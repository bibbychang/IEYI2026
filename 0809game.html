<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>éŠæˆ²é–‹å§‹</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    .grid { display: grid; grid-template-columns: repeat(8, 60px); gap: 5px; justify-content: center; margin-top: 10px; }
    .cell { width: 60px; height: 60px; border: 1px solid #aaa; position: relative; }
    .cell img { width: 100%; height: 100%; object-fit: cover; }
    .player { position: absolute; width: 25px; height: 25px; border-radius: 50%; background: red; border: 2px solid white; top: 0; left: 0; }
    .info { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>å¤§å¯Œç¿éŠæˆ²</h1>
  <div class="grid" id="mapGrid"></div>

  <div class="info">
    <p id="status"></p>
    <button onclick="rollDice()">æ“²éª°å­</button>
    <p id="diceResult"></p>
  </div>

  <script>
    const data = JSON.parse(localStorage.getItem("gameData") || "{}");
    const mapGrid = document.getElementById("mapGrid");
    const map = Array(64).fill(null);
    const order = data.map || [];

    // åœ¨ map[index] ä¸­æ”¾å…¥æ ¼å­åœ–ç¤º
    order.forEach(entry => {
      map[entry.index] = entry.img;
    });

    // æ¸²æŸ“ 8x8 åœ°åœ–
    for (let i = 0; i < 64; i++) {
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.index = i;
      if (map[i]) {
        const img = document.createElement("img");
        img.src = map[i];
        cell.appendChild(img);

        const label = document.createElement("div");
        label.style.position = 'absolute';
        label.style.bottom = '2px';
        label.style.right = '2px';
        label.style.fontSize = '10px';
        label.style.background = 'rgba(255,255,255,0.8)';
        label.textContent = order.findIndex(o => o.index === i) + 1;
        cell.appendChild(label);
      }
      mapGrid.appendChild(cell);
    }

    // ç©å®¶è³‡æ–™åˆå§‹åŒ–
    const playerCount = parseInt(data.players) || 2;
    const players = Array(playerCount).fill(0); // å­˜ä½ç½®ï¼šé †åº array index = playerId
    const colors = ["red", "blue", "green", "orange"];
    let currentPlayer = 0;

    // åˆå§‹é¡¯ç¤ºç©å®¶
    function renderPlayers() {
      document.querySelectorAll(".player").forEach(p => p.remove());
      players.forEach((pos, id) => {
        const gridIndex = order[pos]?.index;
        if (gridIndex === undefined) return;
        const cell = document.querySelector(`.cell[data-index='${gridIndex}']`);
        const marker = document.createElement("div");
        marker.className = "player";
        marker.style.background = colors[id];
        marker.style.top = `${(id * 25) % 60}px`;
        marker.style.left = `${(id * 25) % 60}px`;
        cell.appendChild(marker);
      });
    }

    renderPlayers();

    // æ“²éª°å­ä¸¦ç§»å‹•
    function rollDice() {
      const dice = Math.floor(Math.random() * 6) + 1;
      document.getElementById("diceResult").textContent = `ğŸ² ç©å®¶ ${currentPlayer + 1} æ“²å‡º ${dice}`;
      let pos = players[currentPlayer];
      pos += dice;
      if (pos >= order.length) {
        pos = order.length - 1; // åˆ°çµ‚é»
      }
      players[currentPlayer] = pos;
      renderPlayers();

      const tileType = order[pos]?.img;
      document.getElementById("status").textContent = `ç©å®¶ ${currentPlayer + 1} æŠµé”æ ¼å­ï¼š${tileType || "ç©ºç™½"}`;

      // TODO: è™•ç†ç‰¹æ®Šæ ¼ï¼ˆquiz, event1, fire ç­‰ï¼‰

      // æ›ä¸‹ä¸€ä½
      currentPlayer = (currentPlayer + 1) % playerCount;
    }
  </script>
</body>
</html>
