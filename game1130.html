<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>å¤§å¯Œç¿éŠæˆ²</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0.5rem;
      display: flex;
    }
:root{
  --gap: 2px;
  --cell: 70px; /* å…ˆç•¶ä¿åº•ï¼Œä¹‹å¾Œ JS æœƒè¦†è“‹ */
}

    #left-panel {
      flex: 1;
    }

    #right-panel {
      
      margin-left: 10px;
    }

    #game-board{
  gap: var(--gap);
  grid-template-columns: repeat(8, var(--cell));
  grid-template-rows: repeat(8, var(--cell));
}




    .cell {
	position: relative !important;
  
 
  
  
	 width:var(--cell) !important;
		height:var(--cell) !important;      
       box-sizing: border-box;
      border: 1px solid #aaa;
      position: relative;
      background: white;
    }

    .cell img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      position: absolute;
      top: 0;
      left: 0;
    }

    .order-number {
      position: absolute;
      bottom: 2px;
      right: 4px;
      font-size: 10px;
      background: rgba(255, 255, 255, 0.7);
      padding: 1px 3px;
      border-radius: 4px;
    }

    .player{
  position: absolute;
  /* è¨­å®šç‚ºæ ¼å­çš„ 35% ~ 40% å¤§å° */
  width: calc(var(--cell) * 0.58); 
  height: calc(var(--cell) * 0.58);
  z-index: 10;
  transition: all 0.3s ease-in-out; /* è®“ç§»å‹•æ›´æ»‘é † */
}

    .player1 {
      top: 4px;
      left: 4px;
    }

    .player2 {
      top: 4px;
      right: 4px;
    }

    .player3 {
      bottom: 4px;
      left: 4px;
    }

    .player4 {
      bottom: 4px;
      right: 4px;
    }

    .player img {
      width: 100%;
      height: 100%;object-fit: contain;
    }


  .player1 { top: 2px; left: 2px; }
  .player2 { top: 2px; right: 2px; }
  .player3 { bottom: 2px; left: 2px; }
  .player4 { bottom: 2px; right: 2px; }
  
  
  
  
  





    #log {

      white-space: pre-line;
      font-size: 14px;
      background: #f5f5f5;
      border: 1px solid #ccc;
      padding: 6px;
      max-height: 1000px;
      overflow-y: auto;

    }

    #configInfo {
      
      background: #dceeff !important;       /* æ·ºè—åº•ï¼Œå¯æ”¹æˆ #eaf5ff */
  color: #111 !important;
  border: 2.5px solid #111 !important;  /* ç²—é»‘é‚Š */
  border-radius: 16px !important;       /* è† å›Šåœ“è§’ */
  padding: 8px 14px !important;
  font-weight: 700 !important;
  box-shadow: 0 4px 0 #111 !important;  /* å¯¦å¿ƒä¸‹å½± */
      
    }

    #event-card-display {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 280px;
      height: 380px;
      background: white;
      border: 2px solid #444;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 9999;
      padding: 20px;
      animation: fadeIn 0.4s ease;
    }

    #event-card-display.show {
      display: flex;
    }

    .game-map-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }




    .game-map-tooltip {
      visibility: hidden;
      opacity: 0;
      width: max-content;
      max-width: 140px;
      background: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 2px 2px;
      z-index: 10;
      bottom: 100%;
      left: 50%;

      font-size: 12px;
      pointer-events: none;
      white-space: pre-line;
      transition: opacity 0.3s;
    }

    .game-map-wrapper:hover .game-map-tooltip {
      visibility: visible;
      opacity: 1;
    }

    #game-over {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, #ff5f6d, #ffc371);
      color: white;
      border: 4px solid #fff;
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
      z-index: 10000;
      transition: transform 0.5s ease, opacity 0.5s ease;
      opacity: 0;
    }

    #game-over.show {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

    #game-over h1 {
      font-size: 2.5em;
      margin-bottom: 20px;
    }

    #game-over button {
      background: white;
      color: #ff5f6d;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
    }

    #game-over button:hover {
      background: #ffe0e6;
      transform: scale(1.1);
    }

    #quiz-history {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: #fff;
      color: #333;
      border: 3px solid #ccc;
      border-radius: 10px;
      padding: 20px;
      text-align: left;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
      z-index: 10001;
      width: 400px;
      max-height: 70%;
      overflow-y: auto;
      opacity: 0;
      transition: transform 0.4s, opacity 0.4s;
    }

    #quiz-history.show {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

    #quiz-history h2 {
      text-align: center;
    }

    #roll-dice-btn {
      background: linear-gradient(135deg, #ff7e5f, #feb47b);
      border: none;
      color: white;
      padding: 2px 2px;
      font-size: 20px;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      letter-spacing: 1px;
    }

    #roll-dice-btn:hover {
      background: linear-gradient(135deg, #feb47b, #ff7e5f);
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
    }

    #roll-dice-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    /* ==== Scoreboard (ç¾åŒ–) ==== */
    #status {
      margin: 12px 0;
    }

 .score-card {
 flex: 1 1 calc(25% - 8px);       /* æ¯å¼µä½” 25% */
 min-width: 0;
 --accent: #e0e0e0;
 --bg: rgba(0, 0, 0, .03);
   background: #fff;
      border: 2px solid var(--accent);
	   box-shadow: 0 3px 10px rgba(0, 0, 0, .06);
      flex: 1;                        /* å¹³å‡åˆ†é…å¯¬åº¦ */
                     /* å…è¨±å¡ç‰‡ç¸®å°åˆ°å°æ–¼å…§å®¹å¯¬åº¦ */
  padding: 4px 6px !important;    /* ç¸®å°å…§è· */
  display: flex;
  align-items: center;
  gap: 4px !important;
  border-radius: 10px !important;
  font-size: 12px;                /* èª¿å°åŸºç¤å­—é«” */
  box-sizing: border-box;
    }
 
 



    .score-grid {
	
      display: flex !important;
	 flex-wrap: wrap !important;      /* å…è¨±æ›è¡Œ */
	  gap: 4px !important;            /* ç¸®å°é–“è· */
	  width: 100%;
	  padding: 4px 0;
	  
      
    }
	@media (max-width: 468px) {
  .score-grid {
    flex: 1 1 calc(50% - 8px);     /* æ¯å¼µä½” 50%ï¼Œé”æˆ 2x2 ä½ˆå±€ */
    padding: 6px !important;
    font-size: 13px;
  }

.order-number {
    font-size: 8px !important;      /* å­—é«”ç¸®å° */
    padding: 0px 2px !important;    /* å…§è·ç¸®å° */
    border-width: 1px !important;   /* é‚Šæ¡†è®Šç´° */
    bottom: 1px !important;
    right: 1px !important;
    min-width: 12px;
    text-align: center;
  }

  /* è®“å¡ç‰‡é«˜åº¦å¯ä»¥ç¨å¾®å½ˆæ€§ä¸€é»ï¼Œé¿å…æ–‡å­—è¢«æ“ çˆ† */
  .score-card {
    flex: 0 0 calc(50% - 4px) !important; /* å¼·åˆ¶æ¯å¼µå¡ç‰‡ä½” 50% å¯¬åº¦ */
    height: auto;
    min-height: 60px;
  }
  
  .score-card .player-avatar .token {
    width: 32px !important;        /* æ‰‹æ©Ÿç‰ˆé ­åƒç¨å¾®æ”¾å¤§ä¸€é»é» */
    height: 32px !important;
  }
  
}

   

   

    .player-avatar {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .player-avatar .token {
      width: 28px !important;
      height: 28px !important;
      object-fit: contain
    }

    .player-avatar .name {
      font-size: 11px;
      letter-spacing: .4px;
      line-height: 1.1
    }

    .score-card .left {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .score-card .right {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      flex: 1;
    }

    

    .score-row{
  display: flex;
  align-items: center;
  justify-content: space-between; /* åˆ†æ•¸åœ¨å·¦ã€å¾½ç« åœ¨å³ */
  gap: 10px;
}

.score{
  white-space: nowrap; 
  line-height: 1;
  font-size: 16px;
      
}

/* badges æœ¬èº«ä¹Ÿç”¨ flex æ’ä¸€æ’ */
.badges{
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}

    .badge.pause {
      border-style: dashed;
      opacity: .9
    }

    .badge {
      font-size: 12px;
      border: 1px solid var(--accent);
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--bg)
    }

    .score-card.active {
      box-shadow:
        0 0 0 6px rgba(var(--accent-rgb, 0, 0, 0), .45),
        0 10px 24px rgba(0, 0, 0, .18);
      transform: translateY(-1px);
    }

    /* Colors: P1ç´… / P2è— / P3ç¶  / P4ç´… */
    .score-card.p1 {
      --accent: #e74c3c;
      --accent-rgb: 231, 76, 60;
    }

    .score-card.p2 {
      --accent: #3498db;
      --accent-rgb: 52, 152, 219;
    }

    .score-card.p3 {
      --accent: #2ecc71;
      --accent-rgb: 46, 204, 113;
    }

    .score-card.p4 {
      --accent: #f1c40f;
      --accent-rgb: 241, 196, 15;
    }

    .skill-cards {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      min-height: 28px;
    }

    .skill-cards .scard {
      width: 22px;
      height: 22px;
      padding: 1px;
      border: 1px solid var(--accent);
      border-radius: 4px;
      background: #fff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .15);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .skill-cards .scard img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    .goal {
      width: 72px;
      
      height: 7px;
      border-radius: 999px;
      background: #eef1f6;
     
      overflow: hidden;
      position: relative;
    }

    .goal .bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent, #888), rgba(0, 0, 0, .15));
      transition: width .35s ease;
    }

    

    

    /* ç›®æ¨™é”æˆæ™‚ç”¨å¯¦è‰²ï¼Œå³ç·£çœ‹èµ·ä¾†æ‰æœƒã€ŒçœŸçš„æ»¿ã€ */
    .goal .bar.full {
      background: var(--accent, #888);
    }

    .score-card.winner::after {
      content: "ğŸ‘‘";
      position: absolute;
      top: -12px;
      right: -12px;
      font-size: 32px;
      filter: drop-shadow(0 2px 2px rgba(0, 0, 0, .25));
    }

    .quiz-opt {
      display: block;
      width: 80%;
      /* å›ºå®šå¯¬åº¦ã€‚æƒ³åƒæ»¿å®¹å™¨å°±æ”¹æˆ 100% */
      max-width: 100%;
      margin: 8px auto;
      box-sizing: border-box;
      text-align: left;
    }/* è®“åœ°åœ–å¯ç¸®æ”¾ï¼ˆè‹¥ä½ å·²åŠ éå¯ç•¥éï¼‰ */
/* ==== 1) æŸ”æ€§æ ¼å¯¬ï¼ˆè·Ÿ editor ä¸€æ¨£ï¼‰==== */

/* ==== 2) å¤–å±¤å…è¨±æ›è¡Œï¼ˆå·¦å³æ¬„æ”¹ä¸Šä¸‹å †ï¼‰==== */
body{ flex-wrap: wrap; gap: 20px; box-sizing: border-box; }

/* ==== 3) ç‰ˆé¢é †åºï¼šå·¦(é ‚éƒ¨) â†’ æ£‹ç›¤ â†’ å³(Recordæœ€åº•) ==== */
@media (max-width: 768px){
  #left-panel{ order:1; flex:1 1 100%; width:100%; min-width:0; }
  
  #game-board, #board-wrap, #center-panel, #game-frame{ order:2; width:100%; max-width:100%; margin:0 auto; }
  #right-panel{ order:3; flex:1 1 100%; width:100%; min-width:0; }
}

/* ==== 4) å–æ¶ˆå³æ¬„æ­»å¯¬ï¼Œæ¡Œæ©Ÿä»èƒ½ä½”ä½ ==== */
#right-panel{
  width: auto !important;           /* è¦†è“‹ 750px */
  flex: 1 1 360px;
  margin-left: 10px;
}

/* ==== 5) è¨˜åˆ†æ¿/è¨­å®šæ»¿ç‰ˆï¼ˆè¦†è“‹ 720px èˆŠå€¼èˆ‡ inline styleï¼‰==== */
#configInfo, fieldset, .scoreboard, .status-card, .player-card, .controls, .card, .panel{
  width: 100% !important;
  max-width: 100% !important;
  box-sizing: border-box;
}

/* ==== 6) æ£‹ç›¤ç”¨è®Šæ•¸æ ¼å¯¬ï¼Œè€Œä¸æ˜¯ 90px ==== */
#game-board{
  display: grid;
  grid-template-columns: repeat(8, var(--cell)) !important;
  grid-template-rows:    repeat(8, var(--cell)) !important;
  gap: 2px;
  width: 100%;
  max-width: calc(var(--cell) * 8 + 14px);
  margin: 0 auto;
}
#game-board .cell{
  width: var(--cell) !important;
  height: var(--cell) !important;
}
#game-board .cell img{ max-width:100%; max-height:100%; object-fit:contain; }
#configInfo, fieldset, .scoreboard, .status-card, .player-card, .controls, .card, .panel{
  width: 100% !important;
  max-width: 100% !important;
  box-sizing: border-box;
}


@media (max-width:768px){
  #log{ max-height: 40vh; overflow:auto; }
}
@media (max-width: 768px){
  body > div:first-of-type{
    flex-wrap: wrap !important;    
    width: 100%;
  }
}

.dm-overlay{
  position: fixed; inset: 0;
  background: rgba(0,0,0,.55);
  display: flex; justify-content: center; align-items: center;
  z-index: 99999;
  padding: 16px;
}
.dm-box{
  width: min(90vw, 420px);
  background: #fff; border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.3);
  padding: 16px 16px 12px;
  font-size: 18px; line-height: 1.5;
}
.dm-actions{
  display: flex; justify-content: flex-end; gap: 12px; margin-top: 12px;
}
.dm-btn{ border: 0; background: none; font-size: 18px; padding: 6px 10px; }
.dm-btn.ok{ color: #1a73e8; font-weight: 700; }
.dm-btn.cancel{ color: #666; }


  .dm-overlay{ align-items: flex-start; }
  .dm-box{ margin-top: calc(12vh + env(safe-area-inset-top, 0px)); }

.dm-actions{
  display:flex;
  justify-content:flex-end;
  gap:12px;
  margin-top:12px;
}

/* å…±ç”¨æŒ‰éˆ•æ¨£å¼ */
.dm-btn{
  -webkit-appearance:none;
  appearance:none;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:10px 16px;              /* é»æ“Šå€å¤§ä¸€é» */
  min-height:40px;
  border-radius:10px;
  border:1px solid transparent;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  user-select:none;
  transition:transform .02s ease, box-shadow .15s ease, background-color .15s ease, border-color .15s ease;
  box-shadow:0 1px 2px rgba(0,0,0,.05);
}

/* ä¸»è¦æŒ‰éˆ•ï¼šç¢ºå®š/å¥½ */
.dm-btn.ok{
  background:#1a73e8;             /* Google è— */
  border-color:#1a73e8;
  color:#fff;
}
.dm-btn.ok:hover{ filter:brightness(.97); }
.dm-btn.ok:active{ transform:translateY(1px); filter:brightness(.94); }

/* æ¬¡è¦æŒ‰éˆ•ï¼šå–æ¶ˆ */
.dm-btn.cancel{
  background:#f3f4f6;             /* æ·ºç° */
  border-color:#e5e7eb;
  color:#374151;                   /* æ·±ç°å­— */
}
.dm-btn.cancel:hover{ background:#e5e7eb; }
.dm-btn.cancel:active{ transform:translateY(1px); }

/* éµç›¤å¯åŠæ€§ */
.dm-btn:focus-visible{
  outline:2px solid #2563eb;
  outline-offset:2px;
}

/* æ‰‹æ©Ÿï¼šæŒ‰éˆ•æ›´å¥½æŒ‰ï¼Œå·¦å³å¹³å‡å¯¬ï¼ˆå¯ä¾å–œå¥½ä¿ç•™æˆ–åˆªé™¤ï¼‰ */
@media (max-width:768px){
  .dm-actions{ justify-content:stretch; }
  .dm-btn{ flex:1 1 0; min-height:44px; }
}



  </style>
  
  
   <style>
  body {
  background:
    radial-gradient(circle at 10px 10px, rgba(0,0,0,0.05) 1.2px, transparent 1.3px) 0 0 / 14px 14px,
    linear-gradient(180deg, #fffbe8, #fff4c9 60%, #ffeeb5 100%);
}
/* 1) æ“²éª°æŒ‰éˆ•ï¼šé»ƒè‰²è† å›Šï¼‹ç²—é»‘é‚Šï¼‹å¯¦å¿ƒä¸‹å½± */
#roll-dice-btn{
  background:#ffd400 !important;
  color:#111 !important;
  border:2px solid #111 !important;
  border-radius:16px !important;
  padding:6px 14px !important;
  font-weight:900 !important;
  letter-spacing:.5px !important;
  box-shadow:0 4px 0 #111 !important;  /* æ¼«ç•«å¼å¯¦å¿ƒå½± */
}
#roll-dice-btn:hover{
  transform:translateY(-1px) !important;
  box-shadow:0 6px 0 #111 !important;
}
#roll-dice-btn:active{
  transform:translateY(1px) !important;
  box-shadow:0 2px 0 #111 !important;
}

/* 2) ç´€éŒ„æ¡†ï¼šç™½åº•ã€åœ“è§’ã€ç²—é»‘é‚Šã€å¯¦å¿ƒä¸‹å½± */
#log{
  background:#ffffff !important;
  border:2px solid #111 !important;
  border-radius:16px !important;
  box-shadow:0 3px 0 #111 !important;
  padding:12px 16px !important;
  font-size:16px !important;
  line-height:1.6 !important;
}

/* 3) è·¯å¾‘é †åºæ•¸å­—ï¼šç™½è‰²åœ“é»ï¼‹ç²—é»‘é‚Šï¼‹ç²—é«”å­— */
.order-number{
  background:#fff !important;
  color:#111 !important;
  border:2px solid #111 !important;
  border-radius:999px !important;
  padding:1px 3px !important;
  font-weight:900 !important;
  font-size:10px !important;
  box-shadow:0 1px 0 #111 !important; /* æ¼«ç•«å¼å¯¦å¿ƒå½± */
}



/* åšåº¦æŠ•å½±ï¼šè®“æ¯æ ¼çœ‹èµ·ä¾†ã€Œæœ‰åšåº¦ã€è€Œä¸æ˜¯åªæœ‰å¤–æ¡† */
#game-board .cell::after{
  content:"";
  position:absolute; inset:0;
  border-radius:12px;
  transform: translateY(2px);     /* åšåº¦é«˜åº¦ï¼›æƒ³è–„ä¸€é»æ”¹ 3px */
  background: rgba(0,0,0,.06);    /* åšåº¦çš„æš—é¢ */
  filter: blur(0.3px);
  z-index:-1;
}

/* æ»‘éå¾®å½ˆè·³ï¼Œæ›´æœ‰ç«‹é«”æ„Ÿï¼ˆä¸åš3Då‚¾æ–œï¼‰ */
#game-board .cell:hover{
  transform: translateY(-2px);
  box-shadow:
    inset 0 2px 0 rgba(255,255,255,.85),
    inset 0 -3px 0 rgba(0,0,0,.08),
    0 3px 0 #111;
}

/* åœ–ç‰‡ç¶­æŒä¹¾æ·¨ï¼šç„¡å¤–æ¡†/é™°å½± */
#game-board .cell img{
transform: scale(0.95);
  transform-origin: center center;
  border:none !important;
  box-shadow:none !important;
  filter:none !important;
}

.dice-override-group {
    /* ç§»é™¤é‚Šæ¡†å’Œå…§è·ï¼Œè®“å®ƒèå…¥èƒŒæ™¯ */
    border: none !important; 
    padding: 0 !important;
    margin-top: 10px; /* ä¿æŒèˆ‡ä¸Šæ–¹å…ƒç´ çš„é–“è· */
}

/* æ¨™é¡Œæ–‡å­— (Legend) */
.dice-override-group legend {
    color: #888; /* å°‡æ¨™é¡Œæ–‡å­—é¡è‰²èª¿æš— */
    font-size: 0.9em;
    padding: 0;
    margin-bottom: 5px;
}

/* æ¯å€‹é¸é …çš„æ–‡å­— */
.dice-override-group label {
    color: #FFF0AC; /* ä¿æŒå¯è®€æ€§ */
    display: inline-block;
    margin-right: 12px !important; /* ä¿®æ­£é–“è· */
    font-size: 0.95em;
}

/* ç¢ºä¿ Radio æŒ‰éˆ•æ˜¯ä½èª¿çš„é¡è‰² */
.dice-override-group input[type="radio"] {
  transform: scale(0.9);    /* é»é»ç¸®å° */
  margin-right: 2px;
  accent-color: #FFF0AC;       /* é»é¸é¡è‰²è®Šç° */
  opacity: 0.6;
}


</style>
  
  
</head>

<body>
<div style="display: flex; align-items: flex-start; gap: 20px; width: 100%; min-height: 100vh; box-sizing: border-box;">
  <div id="left-panel">
  <div id="topbar">
  <!-- è¨˜åˆ†æ¿èˆ‡è¨­å®šåŸæœ¬çš„é‚£äº›å…ƒç´ æ”¾é€™è£¡ -->
<!--<input id="apikey" type="text" style="width: 80%;" placeholder="è²¼ä¸Šä½ çš„ API Key">
<button onclick="makeQuiz()">å‡ºä¸€é¡Œç«ç½é˜²ç½é¡Œç›®</button>
<pre id="output">(å°šæœªå‡ºé¡Œ)</pre>-->
    <div id="configInfo"></div>
    <div id="status" style="margin: 10px 0;"></div>
    <div>
      <button id="roll-dice-btn" onclick="rollDice()">ğŸ² ç©å®¶ <span id="currentPlayer">1</span></button>

      å‰›å‰›ç©å®¶<span id="people">-</span> æ“²å‡º <span id="diceResult">-</span>





    </div>
    
	
	</div>
    <div id="game-board"></div>


  </div>
  <div id="right-panel">

    <div id="event-card-display"></div>

    <!-- <h2 >ğŸ¥ å±•ç¤ºå½±ç‰‡</h2><video id="demoVideo" controls width="200" style="border-radius:8px; ">
  <source src="v1.mp4" type="video/mp4">
  æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ HTML5 å½±ç‰‡ã€‚
</video>
-->
    <h2>ğŸ²ç´€éŒ„</h2>
	<fieldset class="dice-override-group">
Â  Â  Â 
<!--<legend>ğŸ¯ æŒ‡å®šéª°å­é»æ•¸ï¼ˆä½œå¼Šç”¨ï¼‰</legend>!-->
Â  Â  Â  <label><input type="radio" name="diceOverride" value="0" checked> ä¸æŒ‡å®š</label>
Â  Â  Â  <label><input type="radio" name="diceOverride" value="1"> 1</label>
Â  Â  Â  <label><input type="radio" name="diceOverride" value="2"> 2</label>
Â  Â  Â  <label><input type="radio" name="diceOverride" value="3"> 3</label>
Â  Â  Â  <label><input type="radio" name="diceOverride" value="4"> 4</label>
Â  Â  Â  <label><input type="radio" name="diceOverride" value="5"> 5</label>
Â  Â  Â  <label><input type="radio" name="diceOverride" value="6"> 6</label>
</fieldset>

<div id="screen-info" style="margin-top: 6px;  font-size: 12px;  color: rgba(0,0,0,.65);  line-height: 1.35;  user-select: none;"></div>
    <div id="log"></div>

  </div>
  <div id="game-over" class="hidden">
    <h1>ğŸ† éŠæˆ²çµæŸ ğŸ†</h1>
    <p id="winner-text"></p>
    <button onclick="restartGame()">é‡æ–°é–‹å§‹</button>
    <button onclick="showQuizHistory()">æª¢è¦–ç­”é¡Œç´€éŒ„</button>
    <button onclick="closeGameOver()">âŒ é—œé–‰</button>
  </div>
  <!-- é¡¯ç¤ºç­”é¡Œè¨˜éŒ„çš„å€å¡Š -->
  <div id="quiz-history" class="hidden">
    <h2>ğŸ“š ç­”é¡Œç´€éŒ„</h2>
    <div id="quiz-list"></div>
    <button onclick="closeQuizHistory()">é—œé–‰</button>
  </div>

  <audio id="diceSound" src="dice-sound.mp3" preload="auto"></audio>
  <script>


    let config = {};
    try { config = JSON.parse(localStorage.getItem("gameConfig") || '{}'); } catch (e) { config = {}; }
	const USE_AI_QUIZ = !!(config.settings && config.settings.useAIQuiz);
// å•Ÿå‹•ç›£æ¸¬
	initDimensionMonitor();
	updateScreenInfo();

    // ---- é è¨­åœ°åœ–ï¼ˆç•¶æœªè¼‰å…¥ä»»ä½•åœ°åœ–è¨­å®šæ™‚å•Ÿç”¨ï¼‰----

    function __buildDefaultMap() {
      // å¤–åœˆè·¯å¾‘ï¼ˆ8x8ï¼‰ï¼šä¸Šâ†’å³â†’ä¸‹â†’å·¦ï¼ˆå…± 28 æ ¼ï¼‰


      // ä½¿ç”¨ä½ æä¾›çš„ map1 é™£åˆ—èªæ³•ï¼ˆåªæ”¾ç½®æœ‰å…§å®¹çš„æ ¼å­ï¼‰
      const map1 = [
        { index: 0, img: 'start.png' },
        { index: 1, img: 'fire_station_0.png' },
        { index: 2, img: 'dice.png' },
        { index: 3, img: 'bag1.png' },
        { index: 4, img: 'museum921_0.png' },
        { index: 5, img: 'ok1.png' },
        { index: 6, img: 'event1.png' },
        { index: 7, img: 'quiz_water.png' },
        { index: 15, img: 'underdesk.png' },
        { index: 23, img: 'water_bureau_0.png' },
        { index: 31, img: 'light.png' },
        { index: 39, img: 'back.png' },
        { index: 38, img: 'ok3.png' },
        { index: 37, img: 'card2.png' },
        { index: 29, img: 'fire_station_0.png' },
        { index: 21, img: 'ok2.png' },
        { index: 20, img: 'rain1.png' },
        { index: 19, img: 'quiz_earthquake.png' },
        { index: 27, img: 'fire2.png' },
        { index: 35, img: 'dice.png' },
        { index: 34, img: 'quiz_water.png' },
        { index: 33, img: 'event1.png' },
        { index: 32, img: 'fire_station_0.png' },
        { index: 24, img: 'earthquake3.png' },
        { index: 17, img: 'rain1.png' },
        { index: 8, img: 'quiz_fire.png' },
      ];

      // è½‰æˆéŠæˆ²ç”¨çš„ mapData çµæ§‹ï¼ˆindex -> imgï¼‰
      const map = {};


      for (const { index, img } of map1) {
        if (Number.isInteger(index) && typeof img === 'string') {
          map[index] = img;
        }
      }

      const seen = new Set();
      const ring = [];
      for (const { index } of map1) {
        if (Number.isInteger(index) && !seen.has(index)) {
          seen.add(index);
          ring.push(index);
        }
      }
      return { ring, map };
    }
function catNameTC(cat){
  return cat === "fire" ? "ç«ç½"
       : cat === "water" ? "æ°´ç½"
       : cat === "earthquake" ? "åœ°éœ‡"
       : "ä¸€èˆ¬";
}

    function __isValidConfig(cfg) {
      const okPath = Array.isArray(cfg?.pathIndices)
        && cfg.pathIndices.length > 0
        && cfg.pathIndices.every(n => Number.isInteger(n) && n >= 0 && n < 64);

      const okMap = cfg?.mapData && Object.keys(cfg.mapData).length > 0;

      return okPath && okMap;
    }

    // è‹¥æ²’æœ‰åœ°åœ–ï¼ˆpathIndices æˆ– mapData çš†å¯ä½œç‚ºåˆ¤æ–·ï¼‰â†’ å¥—ç”¨é è¨­
    (function __ensureDefaults() {
      if (!__isValidConfig(config)) {
        const { ring, map } = __buildDefaultMap();
        config.pathIndices = ring;
        config.mapData = map;
        config.mode = config.mode || "score";
        config.scoreTarget = config.scoreTarget || 20;
        config.timeLimit = config.timeLimit || 120;
        config.playerCount = config.playerCount || 4;
      }
    })();


    const { mode, timeLimit, scoreTarget, playerCount, mapData, pathIndices } = config;
    const nPlayers = config.playerCount || 2;
    document.getElementById("configInfo").innerText =
      mode === "time"
        ? `ğŸ¯ æ¨¡å¼ï¼šé™æ™‚åˆ¶ï¼ˆ${timeLimit} ç§’ï¼‰`
        : `ğŸ¯ æ¨¡å¼ï¼šç©åˆ†åˆ¶ï¼ˆ${scoreTarget} åˆ†ï¼‰`;
		document.getElementById("configInfo").innerText += USE_AI_QUIZ
  ? " ï½œğŸ¤– å‡ºé¡Œæ–¹å¼ï¼šAI å‡ºé¡Œ"
  : " ï½œğŸ“˜ å‡ºé¡Œæ–¹å¼ï¼šé¡Œåº«å‡ºé¡Œ";
    const gameBoard = document.getElementById("game-board");
    const logEl = document.getElementById("log");
    document.getElementById("configInfo").innerText = "é˜²ç½å¤§å¯Œç¿" + document.getElementById("configInfo").innerText;
    console.log(config);

    let playerSteps = new Array(nPlayers).fill(0);
    let playerScores = new Array(nPlayers).fill(10);
    let playerSkills = new Array(nPlayers).fill(1); // æ¯äººåˆå§‹1æŠ€èƒ½å¡
    let skipTurn = new Array(nPlayers).fill(false);
    let lastDiceRoll = new Array(nPlayers).fill(0);
    let playerTokens = new Array(nPlayers).fill(null);
    let currentPlayer = 0;

    let gameEnded = false;
    let winnerIndex = null;
    let timer = null;
    let timeLeft = timeLimit;
	let timerPaused = false;  // aiå‡ºé¡Œæ™‚é–“æš«åœ
	
	function tickTimer() {
  timeLeft--;
  const configInfo = document.getElementById("configInfo");
  configInfo.textContent = `é™æ™‚åˆ¶ï¼šå€’æ•¸ ${timeLeft} ç§’ `;
  if (timeLeft <= 0) {
    clearInterval(timer);
    timer = null;
    gameEnded = true;
    // ï¼ˆä»¥ä¸‹ç¶­æŒä½ åŸæœ¬çµæŸçµç®—çš„ç¨‹å¼ç¢¼ï¼‰
    const maxScore = Math.max(...playerScores);
    const winners = [];
    for (let i = 0; i < playerScores.length; i++) {
      if (playerScores[i] === maxScore) winners.push(i + 1);
    }
    if (winners.length === 1) {
      alert(`âŒ› æ™‚é–“åˆ°ï¼ ç©å®¶ ${winners[0]} ä»¥ ${maxScore} åˆ†ç²å‹`).then(()=>{
        winnerIndex = winners[0] - 1;
        updateStatus();
        showGameOverScreen(`âŒ› æ™‚é–“åˆ°ï¼ ç©å®¶ ${winners[0]} ä»¥ ${maxScore} åˆ†ç²å‹`);
      });
    } else {
      alert(`âŒ› æ™‚é–“åˆ°ï¼ğŸ¤ å¹³æ‰‹ï¼ç©å®¶ ${winners.join("ã€")} å„å¾— ${maxScore} åˆ†`).then(()=>{
        showGameOverScreen(`âŒ› æ™‚é–“åˆ°ï¼ğŸ¤ å¹³æ‰‹ï¼ç©å®¶ ${winners.join("ã€")} å„å¾— ${maxScore} åˆ†`);
      });
    }
  }
}


function startTimer() {
  if (mode !== 'time' || gameEnded) return;
  if (timer) return;
  timer = setInterval(tickTimer, 1000);
}

function stopTimer() {
  if (timer) { clearInterval(timer); timer = null; }
}

function pauseTimer() {         // â˜… æ–°å¢ï¼šæš«åœ
  if (mode !== 'time') return;
  timerPaused = true;
  stopTimer();
}

function resumeTimer() {        // â˜… æ–°å¢ï¼šæ¢å¾©
  if (mode !== 'time') return;
  if (!gameEnded) {
    timerPaused = false;
    startTimer();
  }
}
	
	
    let quizHistory = [];
    let isAskingQuiz = false; // âœ… é˜²å‘†ï¼šé¿å…åŒä¸€å›åˆé‡è¤‡å½ˆå‡ºå•ç­”

    function isQuizTileName(name) {
      if (!name) return false;
      return name.includes("quiz_earthquake.png") || name.includes("quiz_fire.png") || name.includes("quiz_water.png");
    }

    function closeGameOver() {
      document.getElementById('game-over').classList.remove('show');
    }
    let quizQuestions = [];
    let passedStart = false;

    const QUIZ = {
      fire: [
        { category: 'fire', question: 'é‡åˆ°æ¿ƒç…™æ™‚æ‡‰è©²æ€éº¼åšï¼Ÿ', options: ['ä½å§¿å‹¢æ©ä½å£é¼»å‰é€²', 'æŠ¬é ­å¿«è·‘', 'æ­é›»æ¢¯é›¢é–‹'], answer: 0 },
        { category: 'fire', question: 'ä½¿ç”¨æ»…ç«å™¨æ­¥é©Ÿï¼ˆPASSï¼‰å“ªå€‹æ˜¯éŒ¯çš„ï¼Ÿ', options: ['æ‹‰é–‹æ’æ¢¢', 'å°æº–æ ¹éƒ¨', 'å°æ¿ƒç…™é ‚éƒ¨'], answer: 2 },
        { category: 'fire', question: 'ç™¼ç¾ç«ç½æ™‚ï¼Œå…ˆåšä»€éº¼æœ€å®‰å…¨ï¼Ÿ', options: ['ç«‹å³è¿”å›æ‹¿è²´é‡ç‰©', 'å¤§å–Šè‘—ç«ä¸¦é€šå ±', 'å¾€æ¨“ä¸Šè·‘'], answer: 1 },
        { category: 'fire', question: 'ç«ç½ä¸­ç”¢ç”Ÿçš„æ¿ƒç…™æœ‰ä»€éº¼å±éšªï¼Ÿ', options: ['åªæœ‰è‡­å‘³ï¼Œæ²’æœ‰å±å®³', 'å®¹æ˜“è®“äººçœ‹ä¸æ¸…æ¥šæ–¹å‘', 'å¯ä»¥å¹«åŠ©æˆ‘å€‘æ‰¾åˆ°ç«æº', 'èƒ½è®“äººæšˆå€’å¾Œè‡ªå‹•å‘¼æ•‘'], answer: 1 },
        { category: 'fire', question: 'ç•¶ä½ çœ‹åˆ°é›»ç·šå†’ç«æˆ–å†’ç…™æ™‚ï¼Œæœ€å®‰å…¨çš„åšæ³•æ˜¯ï¼Ÿ', options: ['ç”¨æ°´æ½‘å®ƒ', 'ç«‹åˆ»æ‹”æ‰æ’é ­', 'å…ˆé€šçŸ¥å¤§äººæˆ–è€å¸«ï¼Œä¸¦é é›¢ç¾å ´', 'æ‰¾æœ¨æ£æ‰“æ‰é›»ç·š'], answer: 2 },
        { category: 'fire', question: 'å“ªä¸€ç¨®æƒ…æ³æœ€å®¹æ˜“å°è‡´ç«ç½ç™¼ç”Ÿï¼Ÿ', options: ['æ™šä¸Šé—œç‡ˆç¡è¦º', 'ä½¿ç”¨é›»å™¨å¾Œå¿˜äº†é—œæ‰é›»æº', 'å¤©æ°£è®Šå†·', 'å®¢å»³å¤ªå®‰éœ'], answer: 1 },
        { category: 'fire', question: 'å¦‚æœå®¶ä¸­é›»ç·šè€èˆŠï¼Œä½ æ‡‰è©²æ€éº¼åšï¼Ÿ', options: ['ç”¨è† å¸¶é»ä¸€é»ç¹¼çºŒä½¿ç”¨', 'äº¤çµ¦å°ˆæ¥­äººå“¡æª¢æŸ¥èˆ‡æ›´æ›', 'ç‡’ä¸€ä¸‹çœ‹æœƒä¸æœƒè‘—ç«', 'é€šé€šæ‹”æ‰ä¸å†ç”¨é›»'], answer: 1 },
        { category: 'fire', question: 'ç‚ºä»€éº¼ä¸èƒ½åœ¨ç«ç½ç¾å ´æ­é›»æ¢¯é€ƒç”Ÿï¼Ÿ', options: ['é›»æ¢¯å¤ªæ“ ', 'é›»æ¢¯å…§ç©ºæ°£å¤ªå·®', 'ç«ç½å¯èƒ½è®“é›»æ¢¯æ•…éšœæˆ–åœé›»å—å›°', 'é›»æ¢¯å¤ªæ…¢'], answer: 2 },
        { category: 'fire', question: 'ç«ç½ä¸­å¦‚æœèº«ä¸Šè¡£æœè‘—ç«äº†ï¼Œæ­£ç¢ºçš„åšæ³•æ˜¯ï¼Ÿ', options: ['å¿«é€Ÿå¥”è·‘å¹ç†„ç«', 'èº²é€²å»æ‰€æ¾†æ°´', 'å°±åœ°æ‰“æ»¾ã€ç”¨åšå¸ƒè“‹ä½ç«æº', 'ç«™è‘—å¤§å«ç­‰äººæ•‘'], answer: 2 },
        { category: 'fire', question: 'ç•¶ç™¼ç¾ç«ç½æ™‚ï¼Œæ‡‰è©²é¦¬ä¸Šï¼Ÿ', options: ['æ‹å½±ç‰‡ä¸Šå‚³', 'èº²åœ¨æˆ¿é–“è£¡', 'è¶•å¿«é€ƒç”Ÿä¸¦æ‰“119', 'å›å»æ‹¿æ‰‹æ©Ÿ'], answer: 2 },
        { category: 'fire', question: 'åœ¨å“ªè£¡ä½¿ç”¨æ‰“ç«æ©Ÿæ¯”è¼ƒå®¹æ˜“å¼•ç™¼ç«ç½ï¼Ÿ', options: ['å»æ‰€', 'å»šæˆ¿', 'æ“å ´', 'å®¢å»³'], answer: 1 },
        { category: 'fire', question: 'ä¸‹åˆ—å“ªä¸€ç¨®ç‰©å“æœ€å®¹æ˜“å¼•èµ·ç«ç½ï¼Ÿ', options: ['é‡‘å±¬', 'å¡‘è† ç©å…·', 'æ£‰è¢«', 'å†°å¡Š'], answer: 2 },
        { category: 'fire', question: 'ç«ç½æ™‚æ‡‰è©²æ‚ä½å£é¼»ï¼Œæ˜¯ç‚ºäº†ï¼Ÿ', options: ['ä¿æš–', 'çœ‹ä¸è¦‹ç«', 'é¿å…å¸å…¥æ¿ƒç…™', 'é˜²æ­¢å°–å«'], answer: 2 },
        { category: 'fire', question: 'å“ªä¸€é …åšæ³•æ˜¯éŒ¯èª¤çš„ï¼Ÿ', options: ['ä¸ç©æ‰“ç«æ©Ÿ', 'ç¡è¦ºå‰é—œé›»å™¨', 'ç™¼ç¾ç«ç½ç«‹åˆ»é€ƒç”Ÿ', 'ç«ç½æ™‚æ­é›»æ¢¯é€ƒè·‘'], answer: 3 },
        { category: 'fire', question: 'ä½¿ç”¨ç“¦æ–¯çˆå¾Œæ‡‰è©²ï¼Ÿ', options: ['è®“ç«ä¸€ç›´é–‹è‘—', 'å¿˜è¨˜é—œæ‰ä¹Ÿæ²’é—œä¿‚', 'ç¢ºèªç«ç†„æ»…ä¸¦é—œé–‰ç“¦æ–¯é–‹é—œ', 'ç”¨é›»é¢¨æ‰‡å°è‘—ç“¦æ–¯å¹'], answer: 2 },
        { category: 'fire', question: '119 æ˜¯ä»€éº¼ç”¨é€”çš„é›»è©±ï¼Ÿ', options: ['æŸ¥å¤©æ°£', 'è¨‚æŠ«è–©', 'ç«ç½èˆ‡ç·Šæ€¥æ±‚åŠ©', 'æŸ¥åœ°å€'], answer: 2 },
        { category: 'fire', question: 'ç•¶ç™¼ç¾ç«ç½æ™‚ï¼Œæ‡‰è©²é¦¬ä¸Šï¼Ÿ', options: ['æ‹å½±ç‰‡ä¸Šå‚³', 'èº²åœ¨æˆ¿é–“è£¡', 'è¶•å¿«é€ƒç”Ÿä¸¦æ‰“119', 'å›å»æ‹¿æ‰‹æ©Ÿ'], answer: 2 },
        { category: 'fire', question: 'ç«ç½æ™‚æ‡‰è©²ä½¿ç”¨ä»€éº¼æ–¹å¼é€ƒç”Ÿæœ€å®‰å…¨ï¼Ÿ', options: ['åŸåœ°ä¸å‹•', 'ä½å§¿å‹¢çˆ¬è¡Œ', 'ç«™ç›´è·‘', 'æ­é›»æ¢¯é›¢é–‹'], answer: 1 }
      ],
      water: [
        { category: 'water', question: 'é¢±é¢¨ä¾†è‡¨æ™‚ï¼Œå“ªä¸€å€‹è¡Œç‚ºæ˜¯å®‰å…¨çš„ï¼Ÿ', options: ['åœ¨å¤§é›¨ä¸­å‡ºé–€æ‹ç…§', 'èº²åœ¨å¤§æ¨¹ä¸‹é¿é›¨', 'æ‰“é–‹ç“¦æ–¯ç•™åœ¨å®¶ä¸­ï¼Œé—œå¥½é–€çª—ï¼Œæ”¶çœ‹æ°£è±¡è³‡è¨Š', 'åˆ°æµ·é‚Šçœ‹æµªèŠ±'], answer: 2 },
        { category: 'water', question: 'ç‚ºä»€éº¼æ°´ç½æ™‚ä¸æ‡‰è©²èµ°é€²ç©æ°´ä¸­ï¼Ÿ', options: ['æ°´å¤ªé«’æœƒæŠŠé‹å­å¼„å£', 'è£¡é¢å¯èƒ½æœ‰å°é­šæœƒå’¬äºº', 'ç©æ°´è£¡å¯èƒ½è—æœ‰é›»ç·šã€æ´ç©´æˆ–çœ‹ä¸åˆ°çš„å±éšª', 'ç©æ°´æœƒè®“äººæ„Ÿå†’'], answer: 2 },
        { category: 'water', question: 'å“ªä¸€é …ä¸æ˜¯é€ æˆæ°´ç½çš„åŸå› ï¼Ÿ', options: ['ä¸‹å¤§é›¨æˆ–é¢±é¢¨', 'æ²³æ°´æš´æ¼²', 'æ’æ°´ç³»çµ±ä¸è‰¯', 'å¤©æ°£å¤ªä¹¾ç‡¥'], answer: 3 },
        { category: 'water', question: 'ç‚ºäº†æ¸›å°‘æ°´ç½çš„å½±éŸ¿ï¼Œæˆ‘å€‘å¹³æ™‚å¯ä»¥åšä»€éº¼ï¼Ÿ', options: ['æŠŠåƒåœ¾ä¸Ÿé€²æ°´æº', 'è“‹æˆ¿å­åœ¨ä½çªªåœ°å€', 'æ¸…ç†æ’æ°´å­”ã€é¿å…æ°´æºå µå¡', 'ä¸è½æ°£è±¡é å ±'], answer: 2 },
        { category: 'water', question: 'æ°´ç½æœŸé–“ï¼Œå¦‚æœæ”¿åºœå®£å¸ƒæ’¤é›¢ï¼Œæˆ‘å€‘æ‡‰è©²ï¼Ÿ', options: ['ç¹¼çºŒç•™åœ¨å®¶ä¸­ç¡è¦º', 'æ‹¿é›¨å‚˜èµ°å‡ºå»ç©', 'é¦¬ä¸Šç…§æŒ‡ç¤ºå‰å¾€é¿é›£åœ°é»ï¼Œæ”¶çœ‹æ°£è±¡è³‡è¨Š', 'æ‹å½±ç‰‡ä¸Šå‚³ç¶²è·¯'], answer: 2 },

        { category: 'water', question: 'ä¸‹åˆ—å“ªä¸€é …ä¸æ˜¯æ°´ç½å¯èƒ½é€ æˆçš„å½±éŸ¿ï¼Ÿ', options: ['æˆ¿å±‹æ·¹æ°´', 'è¾²ç”°å—æ', 'é“è·¯ä¸­æ–·', 'å¤©æ°£è®Šç†±'], answer: 3 },
        { category: 'water', question: 'ç•¶æ°´ç½ç™¼ç”Ÿæ™‚ï¼Œæˆ‘å€‘æ‡‰è©²æ€éº¼åšï¼Ÿ', options: ['ç•™åœ¨å®¶è£¡çœ‹é›»è¦–', 'è·‘å»æ²³é‚Šçœ‹æ°´æœ‰å¤šé«˜', 'è½å¾å¤§äººæŒ‡ç¤ºï¼Œå‰å¾€å®‰å…¨åœ°é»', 'è·³é€²æ°´è£¡æ¸¸æ³³'], answer: 2 },
        { category: 'water', question: 'ä¸‹åˆ—å“ªä¸€é …å¯ä»¥å¹«åŠ©æ¸›å°‘æ°´ç½ç™¼ç”Ÿçš„æ©Ÿæœƒï¼Ÿ', options: ['äº‚ä¸Ÿåƒåœ¾é€²æ°´æº', 'å»ºé€ æ’æ°´ç³»çµ±', 'ç å…‰æ‰€æœ‰æ¨¹æœ¨', 'æŠŠåƒåœ¾ä¸Ÿé€²æ²³è£¡'], answer: 1 },
        { category: 'water', question: 'ç‚ºä»€éº¼ä¸èƒ½äº‚ä¸Ÿåƒåœ¾é€²æ°´æºï¼Ÿ', options: ['æ²’é—œä¿‚ï¼Œæ°´æœƒæ²–èµ°', 'åƒåœ¾æœƒè®Šå°‘', 'å®¹æ˜“å µå¡ï¼Œå°è‡´æ°´ç½', 'æ¯”è¼ƒæ–¹ä¾¿'], answer: 2 },
        { category: 'water', question: 'é¢å°æ´ªæ°´çŒ›å¢å’Œæ³¥çŸ³æµå¨è„…ï¼Œæˆ‘å€‘æ‡‰é¿å…åœ¨å“ªè£¡åœç•™ï¼Ÿ', options: ['æ²³é“èˆ‡æºè°·ä½çªªè™•', 'å±±å¡é«˜è™•ç­‰å¾…æ•‘æ´', 'æˆ¿å±‹å …å›ºåœ°å¸¶é¿é›£', 'æ²³å²¸é«˜è™•é é›¢æ°´å‹¢è™•'], answer: 0 },
        { category: 'water', question: 'ä¸‹åˆ—å“ªä¸€é …ã€Œä¸å±¬æ–¼ã€æ´ªæ°´çš„è‡ªç„¶æˆå› ï¼Ÿ', options: ['é›¨æ°´å¤§é‡åŒ¯å…¥æ²³é“', 'å±±å¡æ°´åœŸæµå¤±å°è‡´æ²³åºŠæ·¤ç©', 'é›ªèåŒ–æµå…¥æ²³é“', 'åŸå¸‚æ°´æ³¥åœ°é¢æ’æ°´å¿«'], answer: 3 },
        { category: 'water', question: 'å“ªä¸€é …ã€Œä¸æ˜¯ã€äººç‚ºé€ æˆæˆ–åŠ åŠ‡æ´ªç½çš„å› ç´ ï¼Ÿ', options: ['éåº¦ç ä¼é€ æˆæ°´åœŸæµå¤±', 'åŸå¸‚åœ°è¡¨ç¡¬åŒ–å°è‡´å…§æ¾‡', 'æ²³é“æœªå®šæœŸæ¸…æ·¤å°è‡´æ·¤ç©', 'æ²³é“ä¾µè•è‡ªç„¶åŠ æ·±ï¼Œæµé‡å¢åŠ '], answer: 3 },
        { category: 'water', question: 'ä¸‹åˆ—é é˜²æ°´ç½çš„æ–¹æ³•ä¸­ï¼Œå“ªä¸€é …æ˜¯æ—¥å¸¸èƒ½åšåˆ°çš„ï¼Ÿ', options: ['ç¶“å¸¸æŸ¥çœ‹æ°£è±¡è³‡è¨Šèˆ‡æº–å‚™é˜²ç½ç‰©è³‡', 'æ”¾ä»»åƒåœ¾å †ç©åœ¨æ°´æºä¸­', 'ç„¡éœ€é—œå¿ƒé¢±é¢¨èˆ‡æš´é›¨é å ±', 'æŠŠæ²™è¢‹å †æ”¾æ–¼çª—æˆ¶å…§å´'], answer: 0 },

        { category: 'water', question: 'é—œæ–¼æ´ªæ°´é€ƒç”Ÿå·¥å…·ï¼Œå“ªä¸€é …èªªæ³•æ˜¯æ­£ç¢ºçš„ï¼Ÿ', options: ['ç”¨ç©ºæ²¹æ¡¶æˆ–å¡‘è† ç“¶è£½ä½œç°¡æ˜“æµ®å…·', 'ç”¨ç´™ç®±åšç­å­æœ€ç©©å›º', 'å°çƒï¼ˆå¦‚ç±ƒçƒï¼‰æ˜¯æœ€ä½³æ¼‚æµ®å·¥å…·', 'æ•‘ç”Ÿè£ç½®ä¸éœ€è¦å¯†å°'], answer: 0 },
        { category: 'water', question: 'æ°´ç½æœ€å¸¸è¦‹çš„ä¸»è¦æˆå› æ˜¯ä»€éº¼ï¼Ÿ', options: ['åœ°éœ‡é€ æˆåœ°é¢å¡Œé™·', 'å¼·é™é›¨è¶…éæ²³é“æ’æ°´èƒ½åŠ›', 'çªç„¶æ°£æº«é™ä½', 'ç©ºæ°£æ±¡æŸ“å¢åŠ '], answer: 1 }

      ],
      earthquake: [
        { category: 'earthquake', question: 'åœ°éœ‡ä¾†æ™‚æœ€å®‰å…¨çš„èº²é¿ä½ç½®æ˜¯ï¼Ÿ', options: ['é›»æ¢¯è£¡', 'æ¡Œå­ä¸‹', 'é™½å°'], answer: 1 },
        { category: 'earthquake', question: 'åœ°éœ‡æ™‚ï¼Œæ‡‰è©²ç«‹åˆ»åšä»€éº¼ï¼Ÿ', options: ['è·‘å‡ºæ•™å®¤', 'æ‰¾å …å›ºç‰©å“èº²é¿', 'æ‹¿æ‰‹æ©Ÿæ‹ç…§'], answer: 1 },
        { category: 'earthquake', question: 'å“ªä¸€é …æ˜¯åœ°éœ‡æ™‚ã€Œä¸æ‡‰è©²ã€åšçš„äº‹ï¼Ÿ', options: ['èº²åœ¨ç‰†è§’', 'å¾€çª—æˆ¶é è¿‘', 'ä¿æŒå†·éœ'], answer: 1 },

        { category: 'earthquake', question: 'ç‚ºä»€éº¼ä¸èƒ½åœ¨åœ°éœ‡æ™‚ä½¿ç”¨é›»æ¢¯ï¼Ÿ', options: ['é›»æ¢¯æœƒå¡äºº', 'é›»æ¢¯å¯èƒ½å¡ä½', 'å¤ªæ…¢äº†'], answer: 1 },
        { category: 'earthquake', question: 'åœ°éœ‡å‰æº–å‚™çš„ã€Œé˜²ç½åŒ…ã€æ‡‰åŒ…å«ä¸‹åˆ—å“ªä¸€é …ï¼Ÿ', options: ['æ‰‹é›»ç­’', 'ç©å…·', 'æ›¸æœ¬'], answer: 0 },
        { category: 'earthquake', question: 'è‹¥åœ¨å­¸æ ¡ç™¼ç”Ÿå¼·éœ‡ï¼Œæ‡‰è©²å¦‚ä½•åæ‡‰ï¼Ÿ', options: ['è·ŸåŒå­¸èŠå¤©', 'è½å¾è€å¸«æŒ‡ç¤º', 'è‡ªè¡Œé›¢é–‹å­¸æ ¡'], answer: 1 },

        { category: 'earthquake', question: 'åœ°éœ‡æ™‚æ‡‰è©²é›¢çª—æˆ¶é ä¸€é»ï¼Œæ˜¯å› ç‚ºï¼Ÿ', options: ['ç»ç’ƒå¯èƒ½ç ´ç¢', 'çœ‹ä¸åˆ°å¤–é¢', 'å¤ªå†·'], answer: 0 },
        { category: 'earthquake', question: 'åœ°éœ‡ç™¼ç”Ÿå¾Œï¼Œæ‡‰æ³¨æ„å“ªäº›åœ°æ–¹å¯èƒ½æœ‰é¤˜éœ‡ï¼Ÿ', options: ['å®¤å¤–ç©ºåœ°', 'æ¨“æ¢¯é–“', 'åœ°éœ‡å¾Œéƒ½å®‰å…¨äº†'], answer: 1 },
        { category: 'earthquake', question: 'é˜²ç½åŒ…ä¸­ä¸‹åˆ—å“ªä¸€é …ä¸æ˜¯å¿…è¦ç‰©å“ï¼Ÿ', options: ['å“¨å­', 'æ‰‹é›»ç­’', 'é›»å‹•ç©å…·'], answer: 2 },

        { category: 'earthquake', question: 'åœ°éœ‡æ™‚æ‰“é–‹é–€çš„ç›®çš„ç‚ºä½•ï¼Ÿ', options: ['çœ‹é„°å±…åœ¨å¹¹å˜›', 'é€šé¢¨', 'é é˜²é–€å¡ä½'], answer: 2 },
        { category: 'earthquake', question: 'åœ°éœ‡æœ€å®¹æ˜“ç™¼ç”Ÿåœ¨å“ªäº›åœ°æ–¹ï¼Ÿ', options: ['å±±å€', 'æ‰¾ç«å±±é™„è¿‘', 'æ¿å¡Šäº¤ç•Œè™•'], answer: 2 },
        { category: 'earthquake', question: 'å¦‚æœåœ¨é›»å½±é™¢é‡åˆ°åœ°éœ‡ï¼Œæ‡‰è©²ï¼Ÿ', options: ['å¿«è·‘å‡ºå»', 'è¹²ä¸‹æŠ±é ­', 'åè‘—ç¹¼çºŒçœ‹'], answer: 1 },

        { category: 'earthquake', question: 'åœ°éœ‡æ™‚æ¨“æ¢¯å¯èƒ½æ˜¯å±éšªå€åŸŸï¼ŒåŸå› æ˜¯ï¼Ÿ', options: ['å®¹æ˜“å µå¡', 'çµæ§‹ä¸ç©©', 'å¤ªé«˜äº†'], answer: 1 },
        { category: 'earthquake', question: 'åœ°éœ‡ç•¶ä¸‹åœ¨è»Šå…§ï¼Œæ‡‰è©²æ€éº¼åšï¼Ÿ', options: ['ç«‹åˆ»ä¸‹è»Š', 'ä¿æŒå†·éœåœé ', 'åŠ é€Ÿé›¢é–‹'], answer: 1 },

        { category: 'earthquake', question: 'åœ°éœ‡æ™‚æœ€æ‡‰é¿å…å“ªä¸€ç¨®è¡Œç‚ºï¼Ÿ', options: ['å¤§è²å°–å«', 'æ‰¾å‡ºå£', 'æŠ±è‘—ç‰†'], answer: 0 },

        { category: 'earthquake', question: 'ç™¼ç”Ÿåœ°éœ‡æ™‚æœ€é‡è¦çš„åŸå‰‡æ˜¯ï¼Ÿ', options: ['ä¿æŒå†·éœ', 'é€ƒå¾—å¿«', 'å¤§è²å–Šå«'], answer: 0 },
        { category: 'earthquake', question: 'åœ°éœ‡å¾Œä¸èƒ½é¦¬ä¸Šä½¿ç”¨é›»å™¨ï¼Œæ˜¯å› ç‚ºï¼Ÿ', options: ['æ²’é›»', 'å¯èƒ½å¼•èµ·ç«ç½', 'å¤ªåµ'], answer: 1 },
      ]







    };
    //fetch("quiz_all.json")
    //  .then(res => res.json())
    // .then(data => quizQuestions = data);
    // const quiz = quizQuestions[Math.floor(Math.random() * quizQuestions.length)];


    // é¡Œåº«æ ¼å¼å»ºè­°ï¼š[{ category: "earthquake"|"fire"|"water", question, options:[], answer }]
    // answer å¯æ˜¯æ•¸å­—ç´¢å¼•(0-based) æˆ– èˆŠæ ¼å¼çš„ã€Œé¸é …å­—é¦–ã€(ä¾‹å¦‚ "A." / "B.")
    function getRandomQuiz(category) {
      let pool = [];
      if (category === 'fire') pool = QUIZ.fire;
      else if (category === 'water') pool = QUIZ.water;
      else if (category === 'earthquake') pool = QUIZ.earthquake;
      else pool = [...QUIZ.fire, ...QUIZ.water, ...QUIZ.earthquake];
      if (!pool.length) return null;
      return pool[Math.floor(Math.random() * pool.length)];
    }

async function makeQuiz(){
  const key = document.getElementById('apikey').value.trim();

  const out = document.getElementById('output');
  if(!key){ alert('è«‹è¼¸å…¥ API Key'); return; }

  out.textContent = "ğŸ”¥ AI å‡ºé¡Œä¸­â€¦";

  const endpoint = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";
  const prompt = `è«‹å‡ºä¸€é¡Œé—œæ–¼ã€Œç«ç½ã€çš„é˜²ç½å–®é¸é¡Œï¼Œæä¾›é¡Œç›®èˆ‡å››å€‹é¸é …ï¼ˆA~Dï¼‰ï¼Œæœ€å¾Œè«‹æ¨™æ˜æ­£ç¢ºç­”æ¡ˆï¼ˆA~Dï¼‰ã€‚
è«‹åš´æ ¼ä½¿ç”¨ä¸‹åˆ—æ ¼å¼ï¼ˆä¸è¦å¤šé¤˜èªªæ˜ï¼‰ï¼š
é¡Œç›®ï¼š......
A) ......
B) ......
C) ......
D) ......
ç­”æ¡ˆï¼šA`;

  const body = {
    contents: [{ role: "user", parts: [{ text: prompt }] }]
  };

  try {
    const resp = await fetch(endpoint + "?key=" + encodeURIComponent(key), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await resp.json();
    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
    if (text) {
      out.textContent = text;
    } else {
      out.textContent = "âš ï¸ ç„¡æ³•è§£æå›è¦†ï¼Œå®Œæ•´å…§å®¹å¦‚ä¸‹ï¼š\n" + JSON.stringify(data, null, 2);
    }
  } catch (e) {
    out.textContent = "âŒ éŒ¯èª¤ï¼š" + e.message;
  }
}

// âœ… å¹«åŠ©è§£æ AI å›å‚³æ–‡å­—æˆé¡Œç›®ç‰©ä»¶
function parseGeminiQuizText(text) {
  const mQ = text.match(/é¡Œç›®[:ï¼š](.*)/);
  const q = mQ ? mQ[1].trim() : "";
  const opts = [];
  for (const ch of ["A","B","C","D"]) {
    const m = text.match(new RegExp(`${ch}[)ï¼\\.]\\s*(.+)`));
    if (m) opts.push(`${ch}) ${m[1].trim()}`);
  }
  const mA = text.match(/ç­”æ¡ˆ[:ï¼š]\s*([A-D])/);
  const ans = mA ? mA[1] : null;
  return q && opts.length === 4 && ans ? {
    question: q,
    options: opts,
    answerIndex: {A:0,B:1,C:2,D:3}[ans]
  } : null;
}



    // å…¼å®¹ä½ åŸæœ¬çš„ç­”é¡Œåˆ¤å®šï¼šæ”¯æ´ã€Œç´¢å¼•ã€æˆ–ã€Œå­—é¦–ã€
    function isCorrectAnswer(quizObj, optionText, optionIndex) {
      if (typeof quizObj.answer === 'number') {
        return optionIndex === quizObj.answer; // 0-based ç´¢å¼•
      }
      if (typeof quizObj.answer === 'string') {
        // èˆŠæ ¼å¼ï¼šoption ä»¥ "A. xxx"ï¼›quiz.answer = "A"
        const prefix = optionText.trim().slice(0, quizObj.answer.length);
        return prefix === quizObj.answer;
      }
      return false;
    }

    const PROPERTY_DEFS = {
      fire_station: { buyPrice: 5, toll: 3, display: 'æ£®æ—åœ°' },
      water_bureau: { buyPrice: 5, toll: 3, display: 'ä½çªªåœ°' },
      school: { buyPrice: 5, toll: 3, display: 'å­¸æ ¡' },
      museum921: { buyPrice: 5, toll: 3, display: 'é«˜æ¨“å¤§å»ˆ' }
    };
    const propertyOwners = {};   // { [cellIndex]: 1|2|3|4|null }
    const propertyKeys = {};   // { [cellIndex]: 'fire_station'|'water_bureau'|... } å¿«å–åŠ é€Ÿç”¨

    function getPropertyKey(src) {
      if (!src) return null;
      const name = src.split('/').pop().toLowerCase();

      // å…ˆèµ°ã€Œæ¨™æº–æª”åã€è¦å‰‡ï¼š<key>_<owner>.png
      for (const key of Object.keys(PROPERTY_DEFS)) {
        if (name.startsWith(key + '_')) return key;
      }

      // å…¼å®¹ä½ ç”¨ç”Ÿæˆå™¨ç”¢å‡ºçš„é•·æª”åï¼šç”¨é—œéµå­—/åˆ¥åæ¨æ–·
      const patterns = [
        { key: 'fire_station', re: /(fire[\s_\-]?station|æ¶ˆé˜²)/ },
        { key: 'water_bureau', re: /(water[\s_\-]?(bureau|dept|department)|æ°´åˆ©)/ },
        { key: 'school', re: /(school|å­¸æ ¡)/ },
        { key: 'museum921', re: /(921|museum)/ }
      ];
      for (const { key, re } of patterns) {
        if (re.test(name)) return key;
      }
      return null;
    }

    function getOwnerFromImg(src) {
      if (!src) return null;
      const name = src.split('/').pop().toLowerCase();
      const m = name.match(/_(\d)\.(png|webp|jpg)$/);
      return m ? parseInt(m[1], 10) : null;
    }

    function imageForOwner(key, owner) {
      return `${key}_${owner || 0}.png`;
    }

    function setTileImage(index, newImg) {
      mapData[index] = newImg;
      const cell = gameBoard.children[index];
      const imgEl = cell && cell.querySelector('img');
      if (imgEl) imgEl.src = newImg;
    }

    const eventList = [
      { desc: "E01ï¼šåœ°éœ‡ç™¼ç”Ÿæ™‚ï¼Œä½ ç«‹åˆ»èº²åˆ°å …å›ºæ¡Œå­ä¸‹ã€‚å¹¸é‹é€ƒéä¸€åŠ«ï¼", effect: "å‰é€²1æ ¼" },
      { desc: "E02ï¼šåœ°éœ‡æ™‚ä½ è·‘å‘æ¨“æ¢¯é€ƒç”Ÿï¼Œè¢«è­¦è¡›åˆ¶æ­¢ã€‚åœä¸€å›åˆåæ€ã€‚", effect: "åœä¸€å›åˆ" },
      { desc: "E03ï¼šä½ å¿˜äº†å›ºå®šæ›¸æ«ƒï¼Œåœ°éœ‡æ™‚æ±è¥¿æ‰ä¸‹ä¾†ï¼Œè«‹é€€å›1æ ¼ã€‚", effect: "é€€å›1æ ¼" },
      { desc: "E04ï¼šåœ°éœ‡å¾Œé¦¬ä¸Šé–‹ç“¦æ–¯ç…®æ³¡éºµï¼Œç™¼ç”Ÿç«è­¦ï¼", effect: "å›åˆ°èµ·é»" },
      { desc: "E05ï¼šä½ ç†Ÿè¨˜ç–æ•£è·¯ç·šï¼Œè¿…é€Ÿå¸¶åŒå­¸æ’¤é›¢ï¼Œç²å¾—2åˆ†ã€‚", effect: "å¾—2åˆ†" },
      { desc: "E06ï¼šä½ ç”¨é˜²ç½åŒ…ä¸­çš„å“¨å­å‘¼æ•‘ï¼ŒæˆåŠŸç²æ•‘ï¼", effect: "å‰é€²2æ ¼" },
      { desc: "E07ï¼šä½ å†·éœèº²é¿ä¸¦å¹«åŠ©åŒå­¸é€ƒé›¢ï¼Œè¡¨ç¾å„ªç§€ï¼", effect: "å‰é€²2æ ¼" },
      { desc: "E08ï¼šåœ°éœ‡å¾Œæ‰“é›»è©±å ±å¹³å®‰ï¼Œé›»è©±æ“å¡ä¸­ã€‚", effect: "åœä¸€å›åˆ" },
      { desc: "E09ï¼šåœ°éœ‡æ™‚çª—æˆ¶ç ´è£‚ä½ è¢«ç¢ç»ç’ƒåŠƒå‚·ã€‚", effect: "é€€å›1æ ¼" },
      { desc: "E10ï¼šä½ åƒåŠ é˜²éœ‡æ¼”ç·´ï¼Œç†Ÿæ‚‰é¿é›£è·¯ç·šï¼", effect: "å¾—1åˆ†" },
      { desc: "E11ï¼šä½ èº²åœ¨æ›¸æ«ƒæ—é‚Šï¼Œè¢«æ›¸å£“å€’ã€‚", effect: "å›åˆ°èµ·é»" },
      { desc: "E12ï¼šåœ°éœ‡æ™‚ä½ å¤§å–Šã€Œä¸è¦å‹•ã€è®“å¤§å®¶é©šæ…Œã€‚", effect: "é€€å›1æ ¼" },
      { desc: "E13ï¼šä½ èº²åœ¨å»æ‰€è£¡ï¼Œè¢«å¡ä½äº†ï¼", effect: "åœä¸€å›åˆ" },
      { desc: "E14ï¼šä½ è·Ÿæœ‹å‹é–‹ç©ç¬‘èªªã€Œåœ°éœ‡å¿«ä¾†ã€ï¼ŒçµæœçœŸçš„æ–äº†ï¼", effect: "é€€å›1æ ¼" },
      { desc: "E15ï¼šåœ°éœ‡æ™‚ï¼Œä½ æ‹å½±ç‰‡ä¸Šå‚³ï¼Œåè€Œçµ†å€’è¢«å›°ä½ã€‚", effect: "å›åˆ°èµ·é»" },
      { desc: "E16ï¼šä½ å¹«è€å¸«æ¬é˜²ç½ç‰©è³‡ï¼Œæœ‰å‚™ç„¡æ‚£ã€‚", effect: "å‰é€²2æ ¼" },
      { desc: "E17ï¼šåœ°éœ‡åŒ…è£¡æœ‰æ°´å’Œå“¨å­ï¼Œä½ å†·éœç­‰å¾…æ•‘æ´ï¼", effect: "å‰é€²1æ ¼" },
      { desc: "E18ï¼šä½ è½å¾å»£æ’­æŒ‡ç¤ºå‰å¾€ç©ºåœ°é¿é›£ã€‚", effect: "å¾—1åˆ†" }
    ];

    buildBoard();
	updateScreenInfo();
	updateStatus();
	
    
	const nextFrame = () =>  new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

    if (mode === "score") {
      // ç§¯åˆ†åˆ¶ï¼šè¨­å®šç›®æ¨™åˆ†æ•¸

      //scoreGoal = parseInt(document.getElementById("scoreTarget").value);
    } else if (mode === "time") {
      // é™æ™‚åˆ¶ï¼šå•Ÿå‹•å€’æ•¸è¨ˆæ™‚
      timeLeft = config.timeLimit;
      const configInfo = document.getElementById("configInfo");
      configInfo.textContent = `é™æ™‚åˆ¶ï¼šå€’æ•¸ ${timeLeft} ç§’ `;

      timer = setInterval(async() => {
        timeLeft--;
        configInfo.textContent = `é™æ™‚åˆ¶ï¼šå€’æ•¸ ${timeLeft} ç§’ `;

        if (timeLeft <= 0) {
          clearInterval(timer);
          gameEnded = true;

          // æ¯”è¼ƒé›™æ–¹åˆ†æ•¸
          const maxScore = Math.max(...playerScores);
          // æ‰¾å‡ºæ‰€æœ‰æœ€é«˜åˆ†çš„ç©å®¶ï¼ˆæ”¯æ´å¤šäººå¹³æ‰‹ï¼‰
          const winners = [];
          for (let i = 0; i < playerScores.length; i++) {
            if (playerScores[i] === maxScore) {
              winners.push(i + 1); // ç©å®¶ç·¨è™Ÿå¾1é–‹å§‹
            }
          }
          if (winners.length === 1) {
            await alert(`âŒ› æ™‚é–“åˆ°ï¼ ç©å®¶ ${winners[0]} ä»¥ ${maxScore} åˆ†ç²å‹`);
            winnerIndex = winners[0] - 1;
            updateStatus();  // â† 0-based
            showGameOverScreen(`âŒ› æ™‚é–“åˆ°ï¼ ç©å®¶ ${winners[0]} ä»¥ ${maxScore} åˆ†ç²å‹`);
          } else {
            await alert(`âŒ› æ™‚é–“åˆ°ï¼ğŸ¤ å¹³æ‰‹ï¼ç©å®¶ ${winners.join("ã€")} å„å¾— ${maxScore} åˆ†`);
            showGameOverScreen(`âŒ› æ™‚é–“åˆ°ï¼ğŸ¤ å¹³æ‰‹ï¼ç©å®¶ ${winners.join("ã€")} å„å¾— ${maxScore} åˆ†`);
          }



        }
      }, 1000);
    }

    function getDescription(filename) {
      const name = filename.split('/').pop().trim();
      const descriptions = {
        "start.png": "èµ·é»ï¼šç©å®¶å¾é€™è£¡é–‹å§‹",
        "quiz.png": "ç­”é¡Œæ ¼ï¼šç­”å°å¯å¾—åˆ†",
        "quiz_fire.png": "ç«ç½ç›¸é—œå•é¡Œç­”é¡Œæ ¼ï¼šç­”å°å¯å¾—åˆ†",
        "quiz_water.png": "æ°´ç½ç›¸é—œå•é¡Œç­”é¡Œæ ¼ï¼šç­”å°å¯å¾—åˆ†",
        "quiz_earthquake.png": "åœ°éœ‡ç›¸é—œå•é¡Œç­”é¡Œæ ¼ï¼šç­”å°å¯å¾—åˆ†",
        "event1.png": "äº‹ä»¶å¡1ï¼šéš¨æ©Ÿäº‹ä»¶",
        "event2.png": "äº‹ä»¶å¡2ï¼šéš¨æ©Ÿäº‹ä»¶",
        "fire1.png": "ç™¼ç”Ÿç«ç½",
        "fire2.png": "ç™¼ç”Ÿç«ç½",
        "light.png": "æ‰‹é›»ç­’",
        "bag1.png": "æ€¥æ•‘åŒ…ï¼Œå¯åŠ åˆ†",
        "bag2.png": "æ€¥æ•‘åŒ…ï¼Œå¯åŠ åˆ†",
        "card1.png": "é¿é›£å¡",
        "card2.png": "é¿é›£å¡",
        "earthquake1.png": "ç™¼ç”Ÿåœ°éœ‡äº†",
        "earthquake2.png": "ç™¼ç”Ÿåœ°éœ‡äº†",
        "earthquake3.png": "ç™¼ç”Ÿåœ°éœ‡äº†",
        "ok1.png": "ç„¡ç‰¹æ®Šäº‹ä»¶",
        "ok2.png": "å®‰å…¨å€",
        "ok3.png": "ç„¡ç‰¹æ®Šäº‹ä»¶",
        "rain1.png": "ç™¼ç”Ÿæ°´ç½",
        "rain2.png": "ç™¼ç”Ÿæ°´ç½",
        "rain3.png": "ç™¼ç”Ÿæ°´ç½",
        "safe.png": "å®‰å…¨å€",
        "safezone.png": "å®‰å…¨å€",
        "warning1.png": "è­¦å‘Š",
        "warning2.png": "è­¦å‘Š",
        "underdesk.png": "ç™¼ç”Ÿåœ°éœ‡ï¼Œèº²åˆ°æ¡Œä¸‹ï¼Œæ­£ç¢ºèº²é¿ï¼Œå¯åŠ åˆ†",
        "back.png": "é€€å›èµ·é»",
        "dice.png": "éª°å­æ ¼ï¼šå¯ä»¥å†æ“²ä¸€æ¬¡",
        "fire_station_0.png": "æ£®æ—åœ°",
        "water_bureau_0.png": "ä½çªªåœ°",
        "museum921_0.png": "é«˜æ¨“å¤§å»ˆ",
        // ...å¯ä»¥åŠ æ›´å¤š
      };
      return descriptions[name] || "";
    }
// ==== Fit 8x8 board into the first screen (æ‰£æ‰ä¸Šæ–¹è¨˜åˆ†æ¿é«˜åº¦) ====
let __cellFitDone = false;
let __cellFitRaf = 0;

function fitCellToFirstScreen(force = false) {
  if (__cellFitDone && !force) return;

  const root = document.documentElement;
  const board = document.getElementById("game-board"); 
  if (!board) return;

  const leftPanel = document.getElementById("left-panel") || board.parentElement;
  const vv = window.visualViewport;
  const vH = vv ? vv.height : window.innerHeight;

  // âœ… ä¿®æ­£ï¼šå°‡ gameboard æ”¹ç‚ºæ­£ç¢ºçš„è®Šæ•¸å board
  const rect = board.getBoundingClientRect();
  const mapTop = rect.top; 

  const leftW = leftPanel.getBoundingClientRect().width;
  const gap = 2;
  const gapsTotal = gap * 7;
  const sidePad = 16;
  const bottomPad = 24;

  const availW = Math.max(0, leftW - sidePad);
  const availH = Math.max(0, vH - mapTop - bottomPad);

  const byW = (availW - gapsTotal) / 8;
  const byH = (availH - gapsTotal) / 8;

  // è¨ˆç®—æœ€ä½³æ ¼å¯¬
  let cell = Math.floor(Math.min(90, byW, byH));
  cell = Math.max(18, cell);

  root.style.setProperty("--cell", `${cell}px`);
  __cellFitDone = true;
  updateScreenInfo();
}



    function buildBoard() {
      for (let i = 0; i < 64; i++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        if (mapData[i]) {
          const wrapper = document.createElement("div");
          wrapper.className = "game-map-wrapper";
          // åŠ åœ–ç‰‡
          const img = new Image();
          img.src = mapData[i];
          const pKey = getPropertyKey(mapData[i]);
          if (pKey) {
            propertyKeys[i] = pKey;
            propertyOwners[i] = getOwnerFromImg(mapData[i]) ?? 0;// 0 æˆ– null ä»£è¡¨ç„¡äºº
          }
          wrapper.appendChild(img);
          // åŠ  tooltip
          const tooltip = document.createElement("div");
          tooltip.className = "game-map-tooltip";
          tooltip.textContent = getDescription(img.src);
          wrapper.appendChild(tooltip);

          cell.appendChild(wrapper);
        }
        if (pathIndices.includes(i)) {
          const label = document.createElement("div");
          label.className = "order-number";
          label.textContent = pathIndices.indexOf(i) + 1;
          cell.appendChild(label);
        }
        gameBoard.appendChild(cell);
      }
      renderPlayers();
      if (!pathIndices || pathIndices.length === 0) {
        alert("âš ï¸ è«‹å…ˆå¾ editor.html è¨­å®šç§»å‹•é †åºä¸¦é–‹å§‹éŠæˆ²ï¼");
      }
    }
    function displayCategory(cat) {
      switch (String(cat || '').toLowerCase()) {
        case 'water': return 'æ°´ç½';
        case 'fire': return 'ç«ç½';
        case 'earthquake': return 'åœ°éœ‡';
        default: return cat || '';
      }
    }

// === å‡ºé¡Œé®ç½© ===
function showQuizOverlay(text = "â³ é¡Œç›®ç”Ÿæˆä¸­â€¦") {
  if (document.getElementById("quizOverlay")) return;
  const overlay = document.createElement("div");
  overlay.id = "quizOverlay";
  overlay.style = `
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    z-index: 99999;
  `;
  overlay.innerHTML = `<div id="quizProgress">${text}</div>`;
  document.body.appendChild(overlay);
}

function setQuizOverlayText(text) {
  const el = document.getElementById("quizProgress");
  if (el) el.textContent = text;
}

function hideQuizOverlay() {
  const ov = document.getElementById("quizOverlay");
  if (ov) ov.remove();
}



    function askQuiz(playerIndex, onCorrect, onWrong, quizOverride /* å¯é¸ï¼šæŒ‡å®šé¡Œç›® */) {
      const synth = window.speechSynthesis;
      const quiz = quizOverride || getRandomQuiz(null);
      const t0 = Date.now();   // â† åŠ é€™è¡Œè¨˜éŒ„ä½œç­”èµ·å§‹æ™‚é–“
      if (!quiz) { alert("ç›®å‰æ²’æœ‰é¡Œç›®å¯ç”¨"); (onWrong || (() => { }))(); return; }

      const modal = document.createElement("div");
      modal.style.position = "fixed";
      modal.style.top = "0";
      modal.style.left = "0";
      modal.style.width = "100%";
      modal.style.height = "100%";
      modal.style.backgroundColor = "rgba(0,0,0,0.7)";
      modal.style.display = "flex";
      modal.style.justifyContent = "center";
      modal.style.alignItems = "center";
      modal.style.zIndex = "9999";

      const box = document.createElement("div");
      box.style.background = "white";
      box.style.padding = "20px";
      box.style.borderRadius = "8px";
      box.style.width = "300px";
      box.style.boxShadow = "0 4px 10px rgba(0,0,0,0.3)";
      box.style.textAlign = "center";
      box.style.animation = "slideIn 0.4s ease-out";

      const q = document.createElement("h3");
      q.textContent = quiz.question;
      box.appendChild(q);


      const optsWrap = document.createElement('div');
      optsWrap.className = 'quiz-opts';
      quiz.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.classList.add('quiz-opt');
        btn.style.display = "block";
        btn.style.margin = "8px auto";
        btn.style.padding = "8px 16px";
        btn.style.fontSize = "16px";
        btn.style.cursor = "pointer";
        btn.onclick = () => {
          document.body.removeChild(modal);

          const dt = Date.now() - t0;
          const correct = isCorrectAnswer(quiz, opt, idx);

          // ç”¢ç”Ÿã€Œæ­£ç¢ºç­”æ¡ˆé¡¯ç¤ºæ–‡å­—ã€
          let correctLabel = "";
          if (typeof quiz.answer === 'number') {
            correctLabel = quiz.options[quiz.answer];
          } else if (typeof quiz.answer === 'string') {
            const match = quiz.options.find(o => o.trim().startsWith(quiz.answer));
            correctLabel = `${quiz.answer}${match ? ` (${match})` : ""}`;
          }

          // å¯«å…¥æ­·å²
          quizHistory.push({
            player: playerIndex + 1,
            question: quiz.question,
            selected: opt,
            correctAnswer: correctLabel || "",
            result: correct ? "âœ”ï¸ æ­£ç¢º" : "âŒ éŒ¯èª¤",
            category: quiz.category || "-",
            ms: dt,
            correct: correct
          });
          // çµæœè™•ç†ï¼ˆä¿ç•™ä½ åŸæœ¬åŠ åˆ†/ä¸åŠ åˆ†ç”±å‘¼å«ç«¯æ±ºå®šï¼‰
          if (correct) {
            alert("ç­”å°äº†ï¼åŠ 3åˆ†");
            onCorrect && onCorrect();
          } else {
            alert("ç­”éŒ¯äº†ï¼ä¸åŠ åˆ†");
            onWrong && onWrong();
          }
        };
        box.appendChild(btn);
      });

      modal.appendChild(box);

      // èªéŸ³æœ—è®€
      //try {
      // const utterance = new SpeechSynthesisUtterance(`${quiz.question} é¸é …æ˜¯ï¼š${quiz.options.join('ã€')}`);
      // utterance.lang = 'zh-TW';
      //  synth.speak(utterance);
      //} catch(_) {}

      document.body.appendChild(modal);
    }


    function showQuizHistory() {
      const historyEl = document.getElementById('quiz-list');
      // æ˜ç´°åˆ—è¡¨
      const detailHTML = quizHistory.map(h => {
  const playerImg = `player${h.player}.png`;
  return `
    <div style="margin-bottom:10px;">
      <img src="${playerImg}" class="player-icon" style="width:24px; height:24px; vertical-align:middle; margin-right:5px;">
      ç©å®¶${h.player}ï¼š${h.question}<br>
      â¡ï¸ ä½ ç­”ï¼š${h.selected} ${h.result}
      ${Number.isFinite(Number(h.ms)) ? `ï¼ˆ${(Number(h.ms) / 1000).toFixed(1)} ç§’ï¼‰` : ``}<br>
      âœ… æ­£è§£: ${h.correctAnswer} ${h.category ? `ï½œ é¡åˆ¥ï¼š${displayCategory(h.category)}` : ``}
    </div>
    <hr>`;
}).join('');

      // æ•´ç†æ¯ä½ç©å®¶çµ±è¨ˆ
      const players = typeof nPlayers !== 'undefined' ? nPlayers : Math.max(1, ...quizHistory.map(h => h.player || 1));
      const stats = [];
      for (let p = 1; p <= players; p++) {
        const items = quizHistory.filter(h => h.player === p);
        const n = items.length;
        const right = items.filter(h => h.correct === true || /æ­£ç¢º/.test(h.result || '')).length;
        const acc = n ? Math.round(right / n * 100) : "-";
        const totalMs = items.reduce((s, h) => s + (Number(h.ms) || 0), 0);
        const avgSec = n ? Math.round((totalMs / n) / 100) / 10 : "-";
        const by = { fire: { n: 0, c: 0 }, water: { n: 0, c: 0 }, earthquake: { n: 0, c: 0 } };
        items.forEach(h => {
          const t = (h.category || '').toLowerCase();
          if (by[t]) {
            by[t].n += 1;
            by[t].c += (h.correct === true || /æ­£ç¢º/.test(h.result || '')) ? 1 : 0;
          }
        });
        //const pct = (c, n) => n ? +(Math.round((c / n * 100) * 10) / 10) : '-';å°æ•¸é»
		const pct = (c, n) => n ? Math.round(c / n * 100) : "-";
        stats.push({
          player: p,
          count: n,
          acc: acc === "-" ? "-" : +(Math.round(acc * 10) / 10),
          avgSec,
          fireAcc: pct(by.fire.c, by.fire.n),
          waterAcc: pct(by.water.c, by.water.n),
          eqAcc: pct(by.earthquake.c, by.earthquake.n)
        });
      }

      // ç”¢ç”Ÿè¡¨æ ¼
     // ======= ç¾è§€è¡¨æ ¼ CSS =======
const table = `
<style>
.player-icon{  width: 26px;  height: 26px;  object-fit: contain;  vertical-align: middle;  margin-right: 6px;}
  .stats-table{    border-collapse:collapse;    width:100%;    font-size:15px;    margin-top:12px;    border-radius:8px;    overflow:hidden;  }
  .stats-table th{    background:#f0f0f0;    padding:8px 6px;    font-weight:900;    border-bottom:2px solid #ccc;  }
  .stats-table td{    border-bottom:1px solid #eee;    padding:8px 6px;    text-align:center;  }
  .good-rate{    font-weight:700;    color:#111;  }
  .bad-rate{     font-weight:700;     color:#3cb371;    /* ä½æ–¼51% â†’ ç¶ è‰² */  }
</style>
   <h3>ğŸ“Š æ¯ä½ç©å®¶ç­”é¡Œçµ±è¨ˆ</h3>
<table class="stats-table">
<thead>
  <tr>
    <th>ç©å®¶</th><th>ç­”é¡Œæ•¸</th><th>ç­”å°ç‡</th><th>å¹³å‡ç­”é¡Œæ™‚é–“</th>
    <th>ç«ç½æ­£ç¢ºç‡</th><th>æ°´ç½æ­£ç¢ºç‡</th><th>åœ°éœ‡æ­£ç¢ºç‡</th>
  </tr>
</thead>
<tbody>
${stats.map(s => {

  const showRate = (v) => {
    if (v === "-") return `<td>-</td>`;
    const cls = v < 51 ? "bad-rate" : "good-rate";
    return `<td class="${cls}">${v}%</td>`;
  };

  // âœ” ç©å®¶åœ–ç¤ºï¼šä¾ç…§ç©å®¶ç·¨è™Ÿå‹•æ…‹è¼‰å…¥
  const playerImg = `player${s.player}.png`;

  return `
    <tr>
      <td>
        <img class="player-icon" src="${playerImg}">
        ç©å®¶${s.player}
      </td>
      <td>${s.count}</td>
      ${showRate(s.acc)}
      <td>${s.avgSec === "-" ? "-" : s.avgSec + " ç§’"}</td>
      ${showRate(s.fireAcc)}
      ${showRate(s.waterAcc)}
      ${showRate(s.eqAcc)}
    </tr>`;
}).join('')}
</tbody>
</table>`;

      historyEl.innerHTML = detailHTML + table;
      document.getElementById('quiz-history').classList.add('show');

    }

    function closeQuizHistory() {
      document.getElementById('quiz-history').classList.remove('show');
    }



   function renderPlayers() {
  document.querySelectorAll(".player").forEach(p => p.remove());
  for (let idx = 0; idx < nPlayers; idx++) {
    const cellIndex = pathIndices[playerSteps[idx]];
    const cell = gameBoard.children[cellIndex];
    
    const token = document.createElement("div");
    // åŒæ™‚åŠ å…¥é€šç”¨ class å’Œ ç·¨è™Ÿ class (player1, player2...)
    token.className = `player player${idx + 1}`; 
    
    const carImgs = ["car_red.png", "car_blue.png", "car_green.png", "car_yellow.png"];
    const car = new Image();
    car.src = carImgs[idx] || "car_red.png";
    
    token.appendChild(car);
    cell.appendChild(token);
    playerTokens[idx] = token;
  }
}
    function rollDice() {

      if (gameEnded) return;

      console.log("rollDice");
      if (skipTurn[currentPlayer]) {
        console.log(`ç©å®¶ ${currentPlayer + 1} åœä¸€å›åˆ`);
        alert(`ğŸ›‘ ç©å®¶ ${currentPlayer + 1} åœä¸€å›åˆ`);
        const log = document.getElementById("log");
        log.innerText += `\nğŸ¯ç©å®¶ ${currentPlayer + 1} åœä¸€å›åˆ`;
        skipTurn[currentPlayer] = false;
        currentPlayer = (currentPlayer + 1) % nPlayers;
        document.getElementById("currentPlayer").textContent = currentPlayer + 1;
        updateStatus();
        return;
      }
      updateStatus();            // â† è®“æ­£åœ¨æ“²éª°çš„ç©å®¶ç«‹åˆ»é«˜äº®
      const selected = document.querySelector('input[name="diceOverride"]:checked');
      let dice = selected && selected.value !== "0" ? parseInt(selected.value) : Math.floor(Math.random() * 6) + 1;

      playDiceAnimation(dice, () => {
        finalizeRoll(dice);
      });
    }

    function playDiceAnimation(finalDice, callback) {
      const diceOverlay = document.createElement("div");
      diceOverlay.id = "diceOverlay";
      diceOverlay.style.position = "fixed";
      diceOverlay.style.top = "50%";
      diceOverlay.style.left = "50%";
      diceOverlay.style.transform = "translate(-50%, -50%)";
      diceOverlay.style.zIndex = "1000";
      diceOverlay.style.backgroundColor = "rgba(255,255,255,0.8)";
      diceOverlay.style.padding = "20px";
      diceOverlay.style.borderRadius = "10px";

      const diceImage = document.createElement("img");
      diceImage.id = "diceImage";
      diceImage.style.width = "100px";
      diceImage.style.height = "100px";
      diceOverlay.appendChild(diceImage);
      document.body.appendChild(diceOverlay);

      const diceSound = document.getElementById("diceSound");
      if (diceSound) {
        diceSound.currentTime = 0;
        diceSound.play();
      }

      let rollCount = 12, currentRoll = 0;
      const interval = setInterval(() => {
        let tempFace = Math.floor(Math.random() * 6) + 1;
        diceImage.src = `dice${tempFace}.png`;
        currentRoll++;
        if (currentRoll >= rollCount) {
          clearInterval(interval);
          diceImage.src = `dice${finalDice}.png`;
          setTimeout(() => {
            document.body.removeChild(diceOverlay);
            if (callback) callback();
          }, 500);
        }
      }, 80);
    }

    function finalizeRoll(dice) {
      console.log("finalizeRoll dice:", dice);
      const log = document.getElementById("log");



      log.innerText += `\nğŸ¯ ç©å®¶${currentPlayer + 1} æ“²å‡º${dice}`;
      lastDiceRoll[currentPlayer] = dice;
      document.getElementById("diceResult").textContent = dice;
      document.getElementById("people").textContent = currentPlayer + 1;

      continueMoveLogic(dice);
    }



    async function continueMoveLogic(dice) {
      const prevStep = playerSteps[currentPlayer];
      let step = playerSteps[currentPlayer] + dice;
      const pathLen = pathIndices.length;

      if ((prevStep < pathLen) && (step >= pathLen)) {
        passedStart = true;
      }
      step = step % pathLen;

      const fromIndex = pathIndices[prevStep % pathLen];
      const toIndex = pathIndices[step];
      const cellImg = mapData[toIndex] || "";

      if (fromIndex === undefined || toIndex === undefined) {
        alert("âš ï¸ æ‰¾ä¸åˆ°å°æ‡‰çš„æ ¼å­ï¼Œå¯èƒ½æ˜¯åœ°åœ–å°šæœªæ­£ç¢ºè¨­å®šã€‚");
        return;
      }




      const proceed = async () => {
        const prev = playerSteps[currentPlayer];
        if (passedStart) {
          playerScores[currentPlayer] += 1;
          // nextFrame();                        // â˜… å…ˆé‡ç¹ªï¼Œå†è·³çª—
			await alert("ğŸ‰ å®Œæˆä¸€åœˆï¼ŒåŠ 1åˆ†ï¼"); 
	  log.innerText += `\nğŸ¯ ç©å®¶${currentPlayer + 1} å®Œæˆä¸€åœˆï¼ŒåŠ 1åˆ†`;
          checkScoreWin();
          passedStart = false;
        }

        playerSteps[currentPlayer] = step;
        animateMove(currentPlayer, fromIndex, toIndex, async () => {
          updateStatus();
          if (checkScoreWin()) return;
          logAction(currentPlayer, dice, toIndex);


          const imgNow = (typeof getCellImageSrc === 'function') ? getCellImageSrc(toIndex) : (mapData[toIndex] || "");

          if (isQuizTileName(imgNow)) {
  if (isAskingQuiz) return; // é¿å…é‡è¤‡å‡ºé¡Œ
  isAskingQuiz = true;

  // ğŸ”¹è¾¨è­˜é¡Œç›®é¡å‹
  let category = null;
  if (imgNow.includes("quiz_earthquake.png")) category = "earthquake";
  else if (imgNow.includes("quiz_fire.png")) category = "fire";
  else if (imgNow.includes("quiz_water.png")) category = "water";


if (!USE_AI_QUIZ) {
    // ä¸ä½¿ç”¨ AIï¼šç›´æ¥å‡ºé¡Œåº«
    const q = getRandomQuiz(category);
    askQuiz(
      currentPlayer,
      () => {
        playerScores[currentPlayer] += 3;
        logEl.innerText += ` âœ… ç©å®¶${currentPlayer + 1} ç­”å° ${catNameTC(category)} é¡Œï¼šã€Œ${q.question}ã€ +3 åˆ†`;
        logEl.scrollTop = logEl.scrollHeight;
        updateStatus();
        checkScoreWin();
        isAskingQuiz = false;
        nextTurn();
      },
      () => {
        logEl.innerText += ` âŒ ç©å®¶${currentPlayer + 1} ç­”éŒ¯ ${catNameTC(category)} é¡Œï¼šã€Œ${q.question}ã€`;
        logEl.scrollTop = logEl.scrollHeight;
        isAskingQuiz = false;
        nextTurn();
      },
      q
    );
    return;
  }
// ä½¿ç”¨ AIï¼šç›´æ¥å‡ºé¡Œåº«

  // ğŸ”¹ç›´æ¥å¯«åœ¨ç¨‹å¼è£¡çš„ API KEY
//  const  GEMINI_KEY = localStorage.getItem("gemini_api_key");
//if (! GEMINI_KEY) {
  //alert("âš ï¸ ç„¡å¯ç”¨API Key æ”¹ç”¨é¡Œåº«ï¼");  
//}	

  



  async function aiGenerateQuiz(category) {
    const topicMap = { fire: "ç«ç½", water: "æ°´ç½", earthquake: "åœ°éœ‡" };
    const topic = topicMap[category] || "é˜²ç½";
    const prompt = `è«‹å‡ºä¸€é¡Œèˆ‡${topic}é˜²ç½æœ‰é—œçš„å–®é¸é¡Œï¼Œ
æä¾›é¡Œç›®èˆ‡å››å€‹é¸é …ï¼ˆAâ€“Dï¼‰ï¼Œæœ€å¾Œè«‹æ¨™æ˜æ­£ç¢ºç­”æ¡ˆï¼ˆAâ€“Dï¼‰ã€‚
æ ¼å¼å¦‚ä¸‹ï¼š
é¡Œç›®ï¼šAIå‡ºé¡Œï¼......
A) ......
B) ......
C) ......
D) ......
ç­”æ¡ˆï¼šA`;

   try {
  const res = await fetch(
    "https://wispy-firefly-8762.yingli0923.workers.dev/api/gemini",
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [
          { role: "user", parts: [{ text: prompt }] }
        ]
      })
    }
  );

      const data = await res.json();
      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
      const parsed = parseGeminiQuizText(text);
if (!parsed) throw new Error("AI æ ¼å¼éŒ¯èª¤");

// âœ… çµ±ä¸€æ ¼å¼ï¼šè½‰æˆ answerï¼ˆ0~3ï¼‰
return {
category: category,
  question: parsed.question,
  options: parsed.options,
  answer: typeof parsed.answerIndex === "number"
    ? parsed.answerIndex
    : parsed.answer
};
    } catch (e) {
      console.warn("AI å‡ºé¡Œå¤±æ•—:", e);
      return null;
    }
  }

  // ğŸ”¹é–‹å§‹ AI å‡ºé¡Œï¼ˆå¤±æ•—å†ç”¨é¡Œåº«ï¼‰
 (async () => {
  try {
  pauseTimer();  // â˜… é€²å…¥ AI å‡ºé¡Œ â†’ å…ˆæš«åœå€’æ•¸
    // ğŸ§  é¡¯ç¤ºé®ç½©
	
    showQuizOverlay(`â³ æ­£åœ¨ç”Ÿæˆã€Œ${catNameTC(category)}ã€ç›¸é—œå•é¡Œâ€¦`);

    // âš™ï¸ ç”Ÿæˆé¡Œç›®
    let q = await aiGenerateQuiz(category);

    // ğŸ” å¦‚æœAIå¤±æ•— â†’ fallback é¡Œåº«
    if (!q) {
      setQuizOverlayText(`ğŸ“˜ ä½¿ç”¨é¡Œåº«å‡ºé¡Œä¸­...`);
      q = getRandomQuiz(category);
    }

    // âœ… é—œé–‰é®ç½©ï¼ˆç”Ÿæˆå®Œæˆï¼‰
    hideQuizOverlay();
	resumeTimer();  // â˜… é¡Œç›®æº–å‚™å¥½ï¼ˆæˆ–å¤±æ•— fallbackï¼‰â†’ æ¢å¾©å€’æ•¸
    // ğŸ§© å‡ºé¡Œ
    askQuiz(
      currentPlayer,
      () => {
        playerScores[currentPlayer] += 3;
        logEl.innerText += ` âœ… ç©å®¶${currentPlayer + 1} ç­”å° ${catNameTC(category)} é¡Œï¼šã€Œ${q.question}ã€ +3 åˆ†`;
        logEl.scrollTop = logEl.scrollHeight;
        updateStatus();
        checkScoreWin();
        isAskingQuiz = false;
        nextTurn();
      },
      () => {
        logEl.innerText += ` âŒ ç©å®¶${currentPlayer + 1} ç­”éŒ¯ ${catNameTC(category)} é¡Œï¼šã€Œ${q.question}ã€`;
        logEl.scrollTop = logEl.scrollHeight;
        isAskingQuiz = false;
        nextTurn();
      },
      q
    );
  } catch (err) {
    console.error("AI å‡ºé¡ŒéŒ¯èª¤ï¼Œä½¿ç”¨é¡Œåº«ï¼š", err);
    hideQuizOverlay(); // âš ï¸ ç¢ºä¿å‡ºéŒ¯æ™‚ä¹Ÿé—œæ‰é®ç½©
	resumeTimer();
    const q = getRandomQuiz(category);
    askQuiz(currentPlayer, ()=>{}, ()=>{}, q);
  }
})();

  return; // å‡ºé¡Œå®Œå°±çµæŸ
}

          if (imgNow.includes("back.png")) {
            
			
			
			
			
			
			
			alert("ğŸ“¢ é€€å›èµ·é»ï¼");    
            logEl.innerText += ` é€€å›èµ·é»`;
            playerSteps[currentPlayer] = 0;
            renderPlayers();
            updateStatus();
			
			
  
  
            nextTurn();
            return;
          }
          // ğŸ² éª°å­æ ¼ï¼šå†æ“²ä¸€æ¬¡ï¼ˆè½åœ°å¾Œåˆ¤æ–·ï¼‰
          if (imgNow.includes("dice.png")) {
            await alert("ğŸ² è¸©åˆ°éª°å­æ ¼ï¼Œå¯ä»¥å†æ“²ä¸€æ¬¡ï¼");
            playerSteps[currentPlayer] = step;
            logEl.innerText += ` è¸©åˆ°éª°å­æ ¼ï¼Œå¯ä»¥å†æ“²ä¸€æ¬¡ï¼`;
            logEl.scrollTop = logEl.scrollHeight;
            setTimeout(() => rollDice(), 300);
            return;
          }
          if (imgNow.includes("underdesk.png")) {
            playerScores[currentPlayer] += 5;
            updateStatus();
            logEl.innerText += `  åœ°éœ‡æ™‚èº²åœ¨æ¡Œä¸‹ï¼ŒåŠ  5 åˆ†`;
            logEl.scrollTop = logEl.scrollHeight;
            await  alert(`ğŸ´ æ­å–œï¼ç©å®¶ ${currentPlayer + 1} åœ°éœ‡æ™‚èº²åœ¨æ¡Œä¸‹ï¼ŒåŠ  5 åˆ†`);
            checkScoreWin();

            // æ›ä¸‹ä¸€ä½
            nextTurn();
            return;
          }
          if (imgNow.includes("bag1.png")) {
            playerScores[currentPlayer] += 5;
            updateStatus();
            logEl.innerText += ` æ’¿åˆ°æ€¥æ•‘åŒ…ï¼ŒåŠ  5 åˆ†`;
            logEl.scrollTop = logEl.scrollHeight;
            await alert(`ğŸ´ æ­å–œï¼ç©å®¶ ${currentPlayer + 1} æ’¿åˆ°æ€¥æ•‘åŒ…ï¼ŒåŠ  5 åˆ†`);
            checkScoreWin();

            // æ›ä¸‹ä¸€ä½
            nextTurn();
            return;
          }
		  if (imgNow.includes("light.png")) {
            playerScores[currentPlayer] += 5;
            updateStatus();
            logEl.innerText += ` å®¶ä¸­å‚™æœ‰æ‰‹é›»ç­’ï¼ŒåŠ  5 åˆ†`;
            logEl.scrollTop = logEl.scrollHeight;
            await alert(`ğŸ´ æ­å–œï¼ç©å®¶ ${currentPlayer + 1} å®¶ä¸­å‚™æœ‰æ‰‹é›»ç­’ï¼ŒåŠ  5 åˆ†`);
            checkScoreWin();

            // æ›ä¸‹ä¸€ä½
            nextTurn();
            return;
          }
          if (imgNow.includes("card2.png")) {
            playerSkills[currentPlayer]++;
            updateStatus();
            alert(`ğŸ´ æ­å–œï¼ç©å®¶${currentPlayer + 1} ç²å¾—ä¸€å¼µæŠ€èƒ½å¡ï¼Œç›®å‰é¿é›£å¡ï¼š${playerSkills[currentPlayer]} å¼µ`);
            logEl.innerText += ` ç²å¾—1å¼µé¿é›£å¡`;
            logEl.scrollTop = logEl.scrollHeight;
            nextTurn();   // çµæŸæœ¬å›åˆ
            return;       // ä¸è¦å†å¾€ä¸‹åšåœ°ç”¢/æ‹†åœ°
          }


          // ğŸ§¯ fire2.pngï¼šå…ˆå‡ºé¡Œï¼›ç­”éŒ¯å°±æ¸…ç©ºæ‰€æœ‰æ£®æ—åœ°
          // fire2ï¼šæ£®æ—åœ°ï¼ˆç”¨ askfireQuestionï¼‰
          if (imgNow.includes("fire2.png")) {
            handleOwnershipQuiz("fire2.png", "fire_station", "æ£®æ—åœ°", toIndex, askfireQuestion, () => {
              handleProperty(toIndex, () => nextTurn());
            });
            return;
          }
          // rain1ï¼šä½çªªåœ°ï¼ˆç”¨ askWaterBureauQuestionï¼‰
          if (imgNow.includes("rain1.png")) {
            handleOwnershipQuiz("rain1.png", "water_bureau", "ä½çªªåœ°", toIndex, askWaterBureauQuestion, () => {
              handleProperty(toIndex, () => nextTurn());
            });
            return;
          }

          // earthquake3ï¼šé«˜æ¨“å¤§å»ˆï¼ˆç”¨ askMuseumQuestionï¼‰
          if (imgNow.includes("earthquake3.png")) {
            handleOwnershipQuiz("earthquake3.png", "museum921", "é«˜æ¨“å¤§å»ˆ", toIndex, askMuseumQuestion, () => {
              handleProperty(toIndex, () => nextTurn());
            });
            return;
          }



          // åŸæœ¬æµç¨‹end


          handleProperty(toIndex, () => {
            nextTurn();
          });
        });
      }





      if (cellImg.includes("event1.png") || cellImg.includes("event2.png")) {
        const randomEvent = eventList[Math.floor(Math.random() * eventList.length)];
        playerSteps[currentPlayer] = step;
        animateMove(currentPlayer, fromIndex, toIndex, () => {
          handleEventEffect(randomEvent, step);
        });
        return;
      }








      proceed();
    }

    function nextTurn() {
		if (gameEnded) return;   // â˜… å·²ç¶“çµæŸå°±ä¸è¦å†æ›äºº
      currentPlayer = (currentPlayer + 1) % nPlayers;
      document.getElementById("currentPlayer").textContent = currentPlayer + 1;
      updateStatus();
    }



    function animateMove(playerIdx, fromCellIndex, toCellIndex, callback, direction = 1) {
      const token = playerTokens[playerIdx];
      if (!token) { callback && callback(); return; }

      const pathLen = pathIndices.length;

      // å–å¾—ã€Œæ­¥æ•¸ä½ç½®ã€ï¼šæŠŠ cellIndex è½‰ç‚º path ä¸Šçš„åºè™Ÿ
      let curStep = pathIndices.indexOf(fromCellIndex);
      const targetStep = pathIndices.indexOf(toCellIndex);
      if (curStep === -1 || targetStep === -1) { // å®‰å…¨é˜²å‘†
        // æ‰¾ä¸åˆ°å°±ç›´æ¥ç¬ç§»
        gameBoard.children[toCellIndex].appendChild(token);
        callback && callback();
        return;
      }

      // æ¯æ ¼åœç•™æ™‚é–“ï¼ˆå¯è‡ªè¡Œèª¿æ•´é€Ÿåº¦ï¼‰
      const STEP_DELAY = 180; // æ¯«ç§’
      const stepDir = (direction === -1 ? -1 : 1);
      // é€æ ¼å‰é€²ç›´åˆ° targetStep
      function stepOnce() {
        if (curStep === targetStep) {
          // èµ°å®Œ
          callback && callback();
          return;
        }
        // ä¾æ–¹å‘èµ°ä¸€æ ¼ï¼ˆå¯å‰é€²/å¾Œé€€ï¼Œå«ç’°ç¹ï¼‰
        curStep = (curStep + stepDir + pathLen) % pathLen;
        const nextCellIndex = pathIndices[curStep];

        // å°‡æ£‹å­æ”¾åˆ°ä¸‹ä¸€æ ¼ï¼ˆä¸è¤‡è£½ã€ä¸é¡¯ç¤ºåˆ†èº« â†’ ä¸æœƒæ®˜å½±ï¼‰
        gameBoard.children[nextCellIndex].appendChild(token);

        // ç¹¼çºŒä¸‹ä¸€æ ¼
        setTimeout(stepOnce, STEP_DELAY);
      }

      // å¾ç•¶å‰æ ¼é–‹å§‹èµ°
      setTimeout(stepOnce, STEP_DELAY);
    }
    function checkScoreWin() {
      if (mode === "score") {
        for (let i = 0; i < nPlayers; i++) {
          if (playerScores[i] >= scoreTarget) {
            gameEnded = true;
            winnerIndex = i; // â† æ¨™è¨˜è´å®¶ï¼Œè®“è¨˜åˆ†æ¿åŠ ä¸Š .winner
            updateStatus();// â† æ¨™è¨˜è´å®¶ï¼Œè®“è¨˜åˆ†æ¿åŠ ä¸Š .winner
            //alert(`ğŸ‰ ç©å®¶ ${i + 1} é”åˆ° ${scoreTarget} åˆ†ï¼Œç²å‹ï¼`);
            showGameOverScreen(`ğŸ‰ ç©å®¶ ${i + 1} é”åˆ° ${scoreTarget} åˆ†ï¼Œç²å‹ï¼`);
            clearInterval(timer);
            return true;
          }
        }
      }
      return false;
    }


    function updateStatus() {
      // å½©è‰²å¡ç‰‡å¼è¨˜åˆ†æ¿ï¼šé¡¯ç¤ºåˆ†æ•¸èˆ‡æŠ€èƒ½å¡æ•¸
      const carImgs = ["car_red.png", "car_blue.png", "car_green.png", "car_yellow.png"];
      const status = document.getElementById("status");
      const rawGoal = (document.getElementById('scoreTarget')?.value ?? (typeof config !== 'undefined' ? config.scoreTarget : 20));
      let goalScore = (() => {
        const n = parseInt(String(rawGoal).replace(/[^\d.-]/g, ''), 10);
        return Number.isFinite(n) && n > 0 ? n : 20;
      })();
      if (typeof config !== 'undefined' && config.mode === 'time') {
        goalScore = 50;   // OKï¼šå› ç‚ºä¸Šé¢ç”¨ let
      }




      if (!status) return;

      let cards = "";
      for (let i = 0; i < nPlayers; i++) {
       
// éŠæˆ²çµæŸå¾Œå°±ä¸è¦å†é«˜äº®ä»»ä½•äººï¼Œåªé¡¯ç¤ºçš‡å† 
  const isActive = !gameEnded && (i === currentPlayer);

        const isWinner = (winnerIndex === i);
        const cls = `score-card p${i + 1}${isActive ? " active" : ""}${isWinner ? " winner" : ""}`;
        const car = carImgs[i] || "car_red.png";
        const score = (Array.isArray(playerScores) && typeof playerScores[i] !== "undefined") ? playerScores[i] : 0;
        const skills = (Array.isArray(playerSkills) && typeof playerSkills[i] !== "undefined") ? playerSkills[i] : 0;
        const pausedBadge = (Array.isArray(skipTurn) && skipTurn[i]) ? `<span class="badge pause">æš«åœ</span>` : ``;
        const skillIcons = Array.from({ length: skills },
          () => `<span class="scard"><img src="card2.png" alt="å¡"></span>`
        ).join("");

        const pct = goalScore ? (playerScores[i] / goalScore) * 100 : 0;
        const isFull = playerScores[i] >= goalScore;
        const pctStr = isFull ? '100%' : `${Math.max(0, Math.min(100, pct)).toFixed(2)}%`;


        cards += `
      <div class="${cls}">
        <div class="left">
          <div class="player-avatar">
            <img class="token" src="${car}" alt="P${i + 1}">
            <div class="name">ç©å®¶${i + 1}</div>
          </div>
        </div>
        <div class="right">
          <div class="score-row"">
			  <div class="score">${score}åˆ†</div>
			   <div class="badges">            
				<div class="skill-cards" aria-label="æŠ€èƒ½å¡ ${skills} å¼µ">${skillIcons}</div>${pausedBadge}
				</div> 
		  </div>  
		  <div   class="goal"   title="ç›®æ¨™ ${goalScore} åˆ†"   role="progressbar"   aria-valuemin="0"   aria-valuemax="${goalScore}"   aria-valuenow="${score}" >
			<div class="bar${isFull ? ' full' : ''}" style="width:${pctStr}"></div>
		</div>
          
        </div>
      </div>`;
      }
      status.innerHTML = `<div class="score-grid">${cards}</div>`;
    }


    function showGameOverScreen(winnerText) {
      const over = document.getElementById('game-over');
      document.getElementById('winner-text').textContent = winnerText;
      over.classList.add('show');
    }

    function restartGame() {
      location.reload();  // ç›´æ¥é‡æ•´é é¢
    }


    function log(msg) {
      logEl.innerText += msg + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }

    function logAction(player, dice, pos) {
      const log = document.getElementById("log");
      const stepNum = pathIndices.indexOf(pos) + 1;
      const imgSrc = mapData[pos] || "";
      const imgName = imgSrc.split('/').pop();
      //log.innerText += `ç©å®¶${player + 1} æ“²å‡º ${dice}ï¼Œç§»å‹•åˆ°ç¬¬ ${stepNum} æ ¼ï¼ˆ${imgName}ï¼‰`;
      log.innerText += ` ç§»å‹•åˆ°ç¬¬ ${stepNum} æ ¼ï¼ˆ${imgName}ï¼‰`;
      log.scrollTop = log.scrollHeight;
      //alert("ğŸ“¢ğŸ“¢ğŸ“¢ ï¼");
    }

    function didCompleteLap(prevStep, newStep, pathLength) {
      return prevStep > newStep; // ä»£è¡¨ç¹éé ­å›åˆ°èµ·é»
    }




    function showEventCard(event, callback) {
      const card = document.getElementById("event-card-display");
      let skillBtnHtml = "";
      if (playerSkills[currentPlayer] > 0) {
        skillBtnHtml = `<button id="event-skill-btn">ä½¿ç”¨ç‰¹æ®ŠæŠ€èƒ½</button>`;
      }
      card.innerHTML = `
    <h3>ğŸ´ ç©å®¶${currentPlayer + 1}æŠ½åˆ°äº‹ä»¶å¡</h3>
    <p>${event.desc}</p>
    <strong>â¡ ${event.effect}</strong>
    <button id="event-ok-btn">ç¢ºèª</button>
    ${skillBtnHtml}
  `;
      card.classList.add("show");

      // åŸæœ¬ç¢ºèª
      card.querySelector("#event-ok-btn").onclick = () => {
        hideEventCard();
        if (callback) callback();
      };
      // æœ‰æŠ€èƒ½æ‰æœ‰æŒ‰éˆ•
      if (playerSkills[currentPlayer] > 0) {
        card.querySelector("#event-skill-btn").onclick = () => {
          alert("ğŸ® ä½ ä½¿ç”¨äº†ç‰¹æ®ŠæŠ€èƒ½ï¼Œæœ¬æ¬¡äº‹ä»¶ç„¡æ•ˆï¼");
          if (passedStart) {
            playerScores[currentPlayer] += 1;

            //alert("ğŸ‰ å®Œæˆä¸€åœˆï¼ŒåŠ 1åˆ†(é€™é‚Šæ˜¯å¥—åœˆå¾Œ  èµ°åˆ°eventçš„åŠ åˆ† ç„¶å¾Œç”¨æŠ€èƒ½å¡çš„)ï¼");
            alert("ğŸ‰ å®Œæˆä¸€åœˆï¼ŒåŠ 1åˆ†ï¼");

            log.innerText += `\nğŸ¯ ç©å®¶${currentPlayer + 1} å®Œæˆä¸€åœˆï¼ŒåŠ 1åˆ†`;
            passedStart = false;
            updateStatus();
            checkScoreWin();
          }
          playerSkills[currentPlayer]--;
          updateStatus();
          hideEventCard();
          // è·³éäº‹ä»¶ã€æ›äºº

          logEl.innerText += ` è§¸ç™¼äº‹ä»¶ï¼šã€Œ${event.desc} ${event.effect}ã€ï¼Œä½¿ç”¨æŠ€èƒ½å¡  äº‹ä»¶ç„¡æ•ˆ`;
          logEl.scrollTop = logEl.scrollHeight;
          currentPlayer = (currentPlayer + 1) % nPlayers;
          document.getElementById("currentPlayer").textContent = currentPlayer + 1;


          updateStatus();
        };
      }
    }

    function hideEventCard() {
      document.getElementById("event-card-display").classList.remove("show");
    }

    function getPropertyIndexesByKey(propKey, ownerFilter /* (ownerId)=>bool */ = null) {
      const arr = [];
      const total = 64; // 8x8 æ£‹ç›¤
      for (let i = 0; i < total; i++) {
        const key = propertyKeys[i] || getPropertyKey(mapData[i] || "");
        if (key === propKey) {
          const owner = (propertyOwners[i] ?? 0);
          if (!ownerFilter || ownerFilter(owner)) arr.push(i);
        }
      }
      return arr;
    }

    // æ¸…ç©ºæŒ‡å®š ownerId æ“æœ‰çš„ã€ŒæŸä¸€ç¨®åœ°ç”¢ã€(propKey) â†’ è®Šå› *_0.png
    function clearPropertiesByOwner(propKey, ownerId) {
      if (ownerId == null) return;
      const targets = getPropertyIndexesByKey(propKey, o => (o === ownerId));
      targets.forEach(i => {
        propertyOwners[i] = 0;
        setTileImage(i, imageForOwner(propKey, 0)); // e.g. water_bureau_0.png
      });
      updateStatus();
    }

    // å…±ç”¨ï¼šåœ¨æŒ‡å®šè§¸ç™¼åœ–(tileName) è¢«è¸©åˆ°æ™‚ï¼Œé€²è¡Œå›ºå®šå•ç­” & ä¾è¦å‰‡æ¸…ç©º
    // è¦å‰‡ï¼š
    //   è‹¥è‡ªå·±æ“æœ‰è©²é¡åœ°ï¼š  ç­”éŒ¯ â†’ æ¸…è‡ªå·±ï¼›ç­”å° â†’ ä¿ç•™
    //   è‹¥åˆ¥äººæ“æœ‰è©²é¡åœ°ï¼šç­”å° â†’ æ¸…åˆ¥äººï¼›ç­”éŒ¯ â†’ ä¿ç•™
    // ç„¡äººæ“æœ‰å‰‡åªæç¤ºã€‚
    function handleOwnershipQuiz(tileName, propKey, propDisplayName, toIndex, askFunc, afterResolve) {
      const imgNow = (typeof getCellImageSrc === 'function') ? getCellImageSrc(toIndex) : (mapData[toIndex] || "");
      if (!imgNow.includes(tileName)) { afterResolve && afterResolve(); return; }

      askFunc(correct => {
        const me = currentPlayer + 1;
        const mine = getPropertyIndexesByKey(propKey, o => (o === me));            // æˆ‘çš„åŒé¡åœ°
        const others = getPropertyIndexesByKey(propKey, o => (o > 0 && o !== me));    // åˆ¥äººçš„åŒé¡åœ°
        const otherOwnerIds = [...new Set(others.map(i => propertyOwners[i]))];       // å¯èƒ½å¤šä½

        if (mine.length === 0 && others.length === 0) {
          alert(correct ? `ä½ ç­”å°äº†ï¼Œä½†ç›®å‰æ²’æœ‰ç©å®¶æ“æœ‰${propDisplayName}`
            : `ä½ ç­”éŒ¯äº†ï¼Œä½†ç›®å‰æ²’æœ‰ç©å®¶æ“æœ‰${propDisplayName}`);
          afterResolve && afterResolve();
          return;
        }

        if (correct) {
          // âœ… ç­”å°ï¼šä¿ç•™è‡ªå·±çš„ã€æ¸…æ‰æ‰€æœ‰å…¶ä»–äººçš„
          if (otherOwnerIds.length > 0) {
            otherOwnerIds.forEach(oid => clearPropertiesByOwner(propKey, oid));
            logEl.innerText += `\nâœ… ä½ ç­”å°äº†ï¼Œå·²æ¸…ç©ºå…¶ä»–ç©å®¶çš„${propDisplayName}`;
            logEl.scrollTop = logEl.scrollHeight;
          }
          alert(`ä½ ç­”å°äº†ï¼šä¿ç•™è‡ªå·±çš„${propDisplayName}ï¼Œä¸¦æ¸…ç©ºå…¶ä»–ç©å®¶çš„${propDisplayName}`);
        } else {
          // âŒ ç­”éŒ¯ï¼šæ¸…æ‰è‡ªå·±çš„ã€å…¶ä»–äººä¿ç•™
          if (mine.length > 0) {
            clearPropertiesByOwner(propKey, me);
            logEl.innerText += `\nâŒ ä½ ç­”éŒ¯äº†ï¼Œä½ çš„${propDisplayName}å·²è¢«æ¸…ç©º`;
            logEl.scrollTop = logEl.scrollHeight;
          }
          alert(`ä½ ç­”éŒ¯äº†ï¼šä½ çš„${propDisplayName}è¢«æ¸…ç©ºï¼Œå…¶ä»–ç©å®¶ä¿ç•™`);
        }

        afterResolve && afterResolve();
      });
    }


const WATER_QUIZ_POOL = [
  {
    question: "ç•¶æ°£è±¡å±€ç™¼å¸ƒè±ªå¤§é›¨ç‰¹å ±ï¼Œç‚ºäº†é˜²æ­¢é›¨æ°´çŒå…¥å®¶ä¸­ï¼Œæ‡‰é å…ˆåšå¥½ä»€éº¼æº–å‚™ï¼Ÿ",
    options: ["æŠŠçª—æˆ¶æ‰“é–‹é€šé¢¨", "è£è¨­é˜²æ°´é–˜é–€æˆ–å †ç½®æ²™åŒ…", "æŠŠå®¶å…·æ¬åˆ°é–€å£æ“‹ä½"],
    answerIndex: 1   // æ­£ç¢ºï¼š1999
  },
  {
    question: "å¦‚æœç™¼ç¾å®¶ä¸­é–‹å§‹æ·¹æ°´ï¼Œç‚ºäº†é¿å…è§¸é›»ï¼Œç¬¬ä¸€æ™‚é–“æ‡‰è©²åšä»€éº¼ï¼Ÿ",
    options: ["è¶•å¿«ç”¨å¹é¢¨æ©ŸæŠŠåœ°æ¿å¹ä¹¾", "åˆ‡æ–·ç¸½é›»æºé–‹é—œ", "ç«™åœ¨æ°´ä¸­æ‹”æ’é ­"],
    answerIndex: 1   // æ­£ç¢ºï¼šè­¦æ”¿æœå‹™ App
  },
  {
    question: "é€¼ä¸å¾—å·²éœ€è¦åœ¨æ·¹æ°´å€åŸŸè¡Œèµ°é¿é›£æ™‚ï¼Œæ‰‹æŒé•·æ£æˆ–é›¨å‚˜çš„ä¸»è¦ç›®çš„æ˜¯ä»€éº¼ï¼Ÿ",
    options: ["ç”¨ä¾†é©…è¶•æ°´ä¸­çš„é­š", "ç•¶ä½œæ‹æ–æ”¯æ’èº«é«”", "æ¢æ¸¬å‰æ–¹åœ°é¢æ˜¯å¦æœ‰å‘æ´æˆ–äººå­”è“‹è„«è½"],
    answerIndex: 2   // æ­£ç¢ºï¼šè­¦æ”¿æœå‹™ App
  },
  {
    question: "é–‹è»Šç¶“éåœ°ä¸‹é“æˆ–ä½çªªåœ°å€ç™¼ç¾æœ‰ç©æ°´æ™‚ï¼Œæœ€å®‰å…¨çš„åšæ³•æ˜¯ï¼Ÿ",
    options: ["åŠ é€Ÿè¡éå»", "åˆ‡å‹¿å¼·è¡Œé€šéï¼Œæ‡‰ç¹é“è€Œè¡Œ", "ä¸‹è»Šæ¨è»Šå‰é€²"],
    answerIndex: 1   // æ­£ç¢ºï¼šè­¦æ”¿æœå‹™ App
  },
  {
    question: "æ°´ç½éå¾Œï¼Œå®¶ä¸­çš„è‡ªä¾†æ°´å³ä½¿å¤–è§€çœ‹èµ·ä¾†ä¹¾æ·¨ï¼Œé£²ç”¨å‰æ‡‰è©²æ€éº¼è™•ç†ï¼Ÿ",
    options: ["ç›´æ¥é£²ç”¨å³å¯", "åŠ å…¥å†°å¡Šæ®ºèŒ", "å‹™å¿…ç…®æ²¸å¾Œå†é£²ç”¨"],
    answerIndex: 2   // æ­£ç¢ºï¼šè­¦æ”¿æœå‹™ App
  }
];


    function askWaterBureauQuestion(onDone) {
  // éš¨æ©ŸæŒ‘ä¸€é¡Œ
  const quiz = WATER_QUIZ_POOL[Math.floor(Math.random() * WATER_QUIZ_POOL.length)];

  const modal = document.createElement("div");
  Object.assign(modal.style, {
    position: "fixed", inset: "0", background: "rgba(0,0,0,0.6)",
    display: "flex", alignItems: "center", justifyContent: "center", zIndex: 9999
  });

  const box = document.createElement("div");
  Object.assign(box.style, {
    background: "#fff", padding: "20px", borderRadius: "10px",
    width: "320px", textAlign: "center", boxShadow: "0 8px 24px rgba(0,0,0,0.3)"
  });

  const h3 = document.createElement("h3");
  h3.textContent = quiz.question;
  box.appendChild(h3);

  quiz.options.forEach((opt, idx) => {
    const btn = document.createElement("button");
    btn.textContent = opt;
    btn.classList.add('quiz-opt');
    Object.assign(btn.style, { 
      display: "block", margin: "8px auto", padding: "8px 16px", cursor: "pointer"
    });

    btn.onclick = () => {
      const correct = (idx === quiz.answerIndex);
      document.body.removeChild(modal);
      onDone && onDone(correct);
    };

    box.appendChild(btn);
  });

  modal.appendChild(box);
  document.body.appendChild(modal);
}


const MUSEUM_QUIZ_POOL = [
  {
    question: "å°ç£921å¤§åœ°éœ‡ç™¼ç”Ÿæ–¼å“ªä¸€å¹´ï¼Ÿ",
    options: ["1998", "1999", "2000"],
    answerIndex: 1   // æ­£ç¢ºï¼š1999
  },
  {
    question: "ä¾æ“šå…¨æ°‘åœ‹é˜²æŒ‡å¼•ï¼Œæƒ³æŸ¥è©¢é™„è¿‘çš„ã€Œé˜²ç©ºé¿é›£æ‰€ã€ä½ç½®ï¼Œå»ºè­°ä¸‹è¼‰å“ªä¸€å€‹ Appï¼Ÿ",
    options: ["å¥ä¿å¿«æ˜“é€š", "è­¦æ”¿æœå‹™ App", "å°ç£é«˜éµ App"],
    answerIndex: 1   // æ­£ç¢ºï¼šè­¦æ”¿æœå‹™ App
  },
  {
    question: "æ­£åœ¨é–‹è»Šæ™‚é‡åˆ°åœ°éœ‡ï¼Œä¾æ“šé˜²ç½æŒ‡å¼•ï¼Œä¸‹åˆ—å“ªé …æ˜¯æ­£ç¢ºçš„è™•ç½®æ–¹å¼ï¼Ÿ",
    options: ["ç«‹å³ç·Šæ€¥ç…è»Šï¼Œä¸¦åœåœ¨è·¯ä¸­é–“", "æ…¢æ…¢æ¸›é€Ÿé é‚Šï¼Œåœç•™åœ¨è»Šå…§ç­‰å¾…æ–æ™ƒåœæ­¢", "ç«‹åˆ»æ£„è»Šï¼Œè¡å‡ºè»Šå¤–å°‹æ‰¾æ©è­·"],
    answerIndex: 1   // æ­£ç¢ºï¼šè­¦æ”¿æœå‹™ App
  },
  {
    question: "åŠå¤œç¡è¦ºæ™‚ç™¼ç”Ÿåœ°éœ‡ï¼Œæ‡‰è©²æ¡å–ä»€éº¼è¡Œå‹•æœ€å®‰å…¨ï¼Ÿ",
    options: ["ç•™åœ¨åºŠä¸Šï¼Œè½‰èº«è‡‰æœä¸‹ï¼Œç”¨æ•é ­ä¿è­·é ­é ¸éƒ¨", "ç«‹åˆ»è·³ä¸‹åºŠï¼Œèº²åˆ°åºŠé‹ªåº•ä¸‹", "é¦¬ä¸Šé–‹é–€è¡åˆ°æˆ¶å¤–"],
    answerIndex: 0   // æ­£ç¢ºï¼šè­¦æ”¿æœå‹™ App
  },
  {
    question: "åœ°éœ‡ç™¼ç”Ÿç•¶ä¸‹ï¼Œä¸‹åˆ—å“ªä¸€å€‹è¡Œç‚ºæ˜¯ã€ŒéŒ¯èª¤ã€ä¸”å®¹æ˜“å—å‚·çš„ï¼Ÿ",
    options: ["èº²åœ¨å …å›ºçš„æ¡Œå­ä¸‹ï¼ˆè¶´ä¸‹ã€æ©è­·ã€ç©©ä½ï¼‰", "æ…Œå¼µåœ°å¾€æˆ¶å¤–å¥”è·‘", "é é›¢ç»ç’ƒçª—èˆ‡æ‡¸æ›ç‰©"],
    answerIndex: 1   // æ­£ç¢ºï¼šè­¦æ”¿æœå‹™ App
  }
];



function askMuseumQuestion(onDone) {
  // éš¨æ©ŸæŒ‘ä¸€é¡Œ
  const quiz = MUSEUM_QUIZ_POOL[Math.floor(Math.random() * MUSEUM_QUIZ_POOL.length)];

  const modal = document.createElement("div");
  Object.assign(modal.style, {
    position: "fixed", inset: "0", background: "rgba(0,0,0,0.6)",
    display: "flex", alignItems: "center", justifyContent: "center", zIndex: 9999
  });

  const box = document.createElement("div");
  Object.assign(box.style, {
    background: "#fff", padding: "20px", borderRadius: "10px",
    width: "320px", textAlign: "center", boxShadow: "0 8px 24px rgba(0,0,0,0.3)"
  });

  const h3 = document.createElement("h3");
  h3.textContent = quiz.question;
  box.appendChild(h3);

  quiz.options.forEach((opt, idx) => {
    const btn = document.createElement("button");
    btn.textContent = opt;
    btn.classList.add('quiz-opt');
    Object.assign(btn.style, { 
      display: "block", margin: "8px auto", padding: "8px 16px", cursor: "pointer"
    });

    btn.onclick = () => {
      const correct = (idx === quiz.answerIndex);
      document.body.removeChild(modal);
      onDone && onDone(correct);
    };

    box.appendChild(btn);
  });

  modal.appendChild(box);
  document.body.appendChild(modal);
}


const FIRE_QUIZ_POOL = [
  {
    question: "è¬ä¸€èº«ä¸Šè¡£æœè‘—ç«äº†ï¼Œæ‡‰è©²æ¡å–å“ªä¸‰å€‹å‹•ä½œä¾†æ»…ç«ï¼Ÿ",
    options: ["è·‘ã€å«ã€è·³ï¼ˆè·‘è¶Šå¿«è¶Šå¥½ï¼‰", "åœã€èººã€æ»¾ï¼ˆåœåœ¨åŸåœ°ã€èººä¸‹ã€å·¦å³ç¿»æ»¾ï¼‰", "æ²–ã€è„«ã€æ³¡ï¼ˆç«‹åˆ»æ‰¾å†·æ°´æ²–ï¼‰"],
    answerIndex: 1   // æ­£è§£ï¼šåœã€èººã€æ»¾
  },
  {
    question: "ç«ç½ç™¼ç”Ÿæ™‚ï¼Œç‚ºäº†çˆ­å–é€ƒç”Ÿæ™‚é–“ï¼Œå¯ä»¥æ­ä¹˜é›»æ¢¯å—ï¼Ÿ",
    options: ["çµ•å°ä¸å¯ä»¥ï¼Œé›»æ¢¯å¯èƒ½æœƒæ–·é›»æˆ–å°‡æ¿ƒç…™å¸å…¥", "å¯ä»¥ï¼Œé€™æ˜¯æœ€å¿«çš„ä¸‹æ¨“æ–¹å¼", "åªæœ‰é«˜æ¨“å±¤çš„äººå¯ä»¥æ­"],
    answerIndex: 0   // æ­£è§£ï¼šçµ•å°ä¸å¯ä»¥
  },
  {
    question: "é€ƒé›¢èµ·ç«æˆ¿é–“æˆ–å®¶é–€æ™‚ï¼Œéš¨æ‰‹åšå‡ºä»€éº¼å‹•ä½œå¯ä»¥æœ‰æ•ˆå»¶ç·©ç«å‹¢èˆ‡æ¿ƒç…™æ“´æ•£ï¼Ÿ",
    options: ["å¤§è²å°–å«", "æŠŠçª—æˆ¶å…¨éƒ¨æ‰“ç ´", "éš¨æ‰‹é—œé–€"],
    answerIndex: 2   // æ­£è§£ï¼šéš¨æ‰‹é—œé–€
  },
  {
    question: "é‡åˆ°æ¿ƒç…™æ™‚æ‡‰è©²æ€éº¼åšï¼Ÿ",
    options: ["ä½å§¿å‹¢æ©ä½å£é¼»å‰é€²", "æŠ¬é ­å¿«è·‘æ­é›»æ¢¯é›¢é–‹", "æ­é›»æ¢¯é›¢é–‹"],
    answerIndex: 0   // æ­£è§£ï¼šä½å§¿å‹¢æ©ä½å£é¼»å‰é€²
  }
];
   


    function askfireQuestion(onDone)  {
  // éš¨æ©ŸæŒ‘ä¸€é¡Œ
  const quiz = FIRE_QUIZ_POOL[Math.floor(Math.random() * FIRE_QUIZ_POOL.length)];

  const modal = document.createElement("div");
  Object.assign(modal.style, {
    position: "fixed", inset: "0", background: "rgba(0,0,0,0.6)",
    display: "flex", alignItems: "center", justifyContent: "center", zIndex: 9999
  });

  const box = document.createElement("div");
  Object.assign(box.style, {
    background: "#fff", padding: "20px", borderRadius: "10px",
    width: "320px", textAlign: "center", boxShadow: "0 8px 24px rgba(0,0,0,0.3)"
  });

  const h3 = document.createElement("h3");
  h3.textContent = quiz.question;
  box.appendChild(h3);

  quiz.options.forEach((opt, idx) => {
    const btn = document.createElement("button");
    btn.textContent = opt;
    btn.classList.add('quiz-opt');
    Object.assign(btn.style, { 
      display: "block", margin: "8px auto", padding: "8px 16px", cursor: "pointer"
    });

    btn.onclick = () => {
      const correct = (idx === quiz.answerIndex);
      document.body.removeChild(modal);
      onDone && onDone(correct);
    };

    box.appendChild(btn);
  });

  modal.appendChild(box);
  document.body.appendChild(modal);
}
    

    function getCellImageSrc(index) {
      const cell = gameBoard.children[index];
      const imgEl = cell ? cell.querySelector('img') : null;
      return imgEl ? imgEl.src : (mapData[index] || "");
    }
    // === å…¨åŸŸï¼šåœ°ç”¢è™•ç†ï¼ˆè³¼è²·ï¼éè·¯è²»ï¼‰===
    async function handleProperty(index, afterDone) {
      const imgSrc = getCellImageSrc(index);            // ç”¨ DOM è®€åœ–
      const pKey = propertyKeys[index] || getPropertyKey(imgSrc);
      if (!pKey) {
        console.log('[PROP] not a property:', { index, imgSrc });
        afterDone && afterDone();
        return;
      }

      propertyKeys[index] = pKey;

      // owner æ­£è¦åŒ–ï¼šç„¡äºº â†’ 0
      if (propertyOwners[index] == null) {
        const parsed = getOwnerFromImg(imgSrc);         // 0..4 æˆ– null
        propertyOwners[index] = (parsed == null ? 0 : parsed);
      }

      const owner = propertyOwners[index];              // 0 | 1..4
      const me = currentPlayer + 1;
      const def = PROPERTY_DEFS[pKey];
      const price = def.buyPrice;
      const toll = def.toll;

      const name = def.display;

      console.log('[PROP] enter', { index, pKey, name, imgSrc, owner, me, price, myScore: playerScores[currentPlayer] });

      // ç„¡äººæŒæœ‰ â†’ è©¢å•æ˜¯å¦è³¼è²·
      if (owner === 0) {
        if (playerScores[currentPlayer] >= price) {
          console.log('[PROP] ask to buy', { name, price, me });
          const yes = await showConfirm(`${name} åƒ¹æ ¼ ${price} åˆ†ã€‚ç©å®¶ ${currentPlayer+1} è¦è³¼è²·å—ï¼Ÿ`);
		  
          if (yes) {
            playerScores[currentPlayer] -= price;
            propertyOwners[index] = me;
            setTileImage(index, imageForOwner(pKey, me)); // åŒæ­¥ mapData + DOM
            updateStatus(); // å…ˆåˆ·æ–°è¨ˆåˆ†æ¿

            setTimeout(() => {
              logEl.innerText += ` ä»¥ ${price} åˆ†è³¼è²·äº†ã€Œ${name}ã€`;
              logEl.scrollTop = logEl.scrollHeight;
              afterDone && afterDone();
            }, 0);
            return;
          }
        } else {
          alert(`ç©å®¶${me} åˆ†æ•¸ä¸è¶³ ç„¡æ³•è³¼è²·ã€Œ${name}ã€ï¼ˆéœ€ ${price} åˆ†ï¼‰`);
          logEl.innerText += `åˆ†æ•¸ä¸è¶³ ç„¡æ³•è³¼è²·ã€Œ${name}ã€ï¼ˆéœ€ ${price} åˆ†ï¼‰`;
          logEl.scrollTop = logEl.scrollHeight;
        }
        afterDone && afterDone();
        return;
      }

      // === å·²æœ‰äººæŒæœ‰ â†’ ä»˜éè·¯è²»æˆ–è‡ªå·±çš„åœ° ===
      if (owner !== me) {
        if (playerScores[currentPlayer] >= toll) {
          // å¤ éŒ¢ï¼Œæ­£å¸¸ä»˜è²»
          playerScores[currentPlayer] -= toll;
          playerScores[owner - 1] += toll;
          updateStatus(); // å…ˆåˆ·æ–°è¨ˆåˆ†æ¿

          setTimeout(() => {
            alert(`ç©å®¶${me} åœ¨ã€Œ${name}ã€æ”¯ä»˜ ${toll} åˆ†éè·¯è²»çµ¦ç©å®¶${owner}`);
            logEl.innerText += `\nğŸ’° ç©å®¶${me} åœ¨ã€Œ${name}ã€æ”¯ä»˜ ${toll} åˆ†éè·¯è²»çµ¦ç©å®¶${owner}`;
            logEl.scrollTop = logEl.scrollHeight;
            checkScoreWin();
            afterDone && afterDone();
          }, 0);
          return;
        } else {
          // ä¸å¤ ï¼šæŠŠå…¨éƒ¨çµ¦å°æ–¹ï¼ˆå¯ä¾è¦å‰‡æ”¹ï¼‰
          const all = playerScores[currentPlayer];
          playerScores[owner - 1] += all;
          playerScores[currentPlayer] = 0;
          updateStatus();

          setTimeout(() => {
            alert(`ç©å®¶${me} åˆ†æ•¸ä¸è¶³ï¼Œå·²æŠŠå…¨éƒ¨ ${all} åˆ†çµ¦ç©å®¶${owner}ï¼ˆè‡ªå·±è®Š 0 åˆ†ï¼‰`);
            logEl.innerText += `\nâš ï¸ ç©å®¶${me} åˆ†æ•¸ä¸è¶³ï¼Œå·²æŠŠå…¨éƒ¨ ${all} åˆ†çµ¦ç©å®¶${owner}ï¼ˆè‡ªå·±è®Š 0 åˆ†ï¼‰`;
            logEl.scrollTop = logEl.scrollHeight;
            checkScoreWin();
            afterDone && afterDone();
          }, 0);
          return;
        }
      }

      // è‡ªå·±çš„åœ° â†’ æ²’äº‹
      afterDone && afterDone();
    }



    async function handleEventEffect(event, fromStep) {
      console.log("handleEventEffect");
      showEventCard(event, async() => {
        const moveEffects = ["å‰é€²1æ ¼", "å‰é€²2æ ¼", "é€€å›1æ ¼", "é€€å›2æ ¼", "å›åˆ°èµ·é»"];
        const log = document.getElementById("log");
        const lastRoll = lastDiceRoll[currentPlayer];
        log.innerText += `  è§¸ç™¼äº‹ä»¶ï¼šã€Œ${event.desc} ${event.effect}ã€`;
        log.scrollTop = log.scrollHeight;


        let newStep = playerSteps[currentPlayer];

        if (event.effect === "å‰é€²1æ ¼") {
          newStep = (newStep + 1) % pathIndices.length;
        } else if (event.effect === "å‰é€²2æ ¼") {
          newStep = (newStep + 2) % pathIndices.length;
        } else if (event.effect === "é€€å›1æ ¼") {
          newStep = (newStep - 1 + pathIndices.length) % pathIndices.length;
        } else if (event.effect === "é€€å›2æ ¼") {
          newStep = (newStep - 2 + pathIndices.length) % pathIndices.length;
        } else if (event.effect === "å›åˆ°èµ·é»") {
          newStep = 0;
        }
        //logAction(currentPlayer, dice, newStep);
        if (event.effect === "å¾—2åˆ†") {
          playerScores[currentPlayer] += 2;
          updateStatus();
          checkScoreWin();

        } else if (event.effect === "å¾—1åˆ†") {
          playerScores[currentPlayer] += 1;
          updateStatus();
          checkScoreWin();
        } else if (event.effect === "åœä¸€å›åˆ") {
          skipTurn[currentPlayer] = true;
          // ç›´æ¥æ›ä¸‹ä¸€ä½ç©å®¶
          currentPlayer = (currentPlayer + 1) % nPlayers;
          document.getElementById("currentPlayer").textContent = currentPlayer + 1;
          updateStatus();
          return; // é˜²æ­¢ç¹¼çºŒåŸ·è¡Œå¾ŒçºŒç¨‹å¼
        }
        // äº‹ä»¶ï¼šå›åˆ°èµ·é» â†’ ç›´æ¥ç¬ç§»ï¼ˆä¸æ’­æ”¾å‹•ç•«ï¼‰
        if (event.effect === "å›åˆ°èµ·é»") {
          playerSteps[currentPlayer] = 0;
          renderPlayers();
          updateStatus();
          currentPlayer = (currentPlayer + 1) % nPlayers;
          document.getElementById("currentPlayer").textContent = currentPlayer + 1;
          return;
        }

        const fromIndex = pathIndices[fromStep];
        const toIndex = pathIndices[newStep];
        // æ±ºå®šå‹•ç•«æ–¹å‘ï¼šé€€å› â†’ å¾Œé€€ï¼›å…¶ä»– â†’ å‰é€²
        let animDir = (event.effect === "é€€å›1æ ¼" || event.effect === "é€€å›2æ ¼") ? -1 : 1;


        const imgNow = getCellImageSrc(toIndex);
        playerSteps[currentPlayer] = newStep;

        animateMove(currentPlayer, fromIndex, toIndex, async() => {
          console.log("handleEventEffect_animateMove");
          updateStatus();
          const img = mapData[toIndex] || "";

          if (passedStart) {
            playerScores[currentPlayer] += 1;

            //alert("ğŸ‰ å®Œæˆä¸€åœˆï¼ŒåŠ 1åˆ†(é€™é‚Šæ˜¯å¥—åœˆå¾Œ  èµ°åˆ°eventçš„åŠ åˆ†  ä½†å¦‚æœæ˜¯eventé€£é–å‰é€²æ˜¯ä¸åŠ åˆ†çš„)ï¼");

            log.innerText += `\nğŸ¯ ç©å®¶${currentPlayer + 1} å®Œæˆä¸€åœˆï¼ŒåŠ 1åˆ†`;
            passedStart = false;
            updateStatus();
            alert("âš å®Œæˆä¸€åœˆï¼ŒåŠ 1åˆ†");
            checkScoreWin();
          }
          // === äº‹ä»¶å¾Œçš„ç›®çš„åœ°ç‰¹æ€§åˆ¤æ–· ===
          // 1) éª°å­æ ¼ï¼šå†æ“²ä¸€æ¬¡ï¼ˆä¸æª¢æŸ¥åœ°ç”¢ï¼‰
          if (img.includes("dice.png")) {
            alert("ğŸ² æ­å–œï¼ä½ è¸©åˆ°éª°å­æ ¼ï¼Œå¯ä»¥å†æ“²ä¸€æ¬¡ï¼");
            log.innerText += `\nğŸ¯ ç©å®¶${currentPlayer + 1} è¸©åˆ°éª°å­æ ¼ï¼Œå¯ä»¥å†æ“²ä¸€æ¬¡ï¼ï¼ˆäº‹ä»¶å¾Œï¼‰`;
            setTimeout(() => {
              rollDice();
            }, 300);
            return;
          }
          //add
          // 2) æŠ€èƒ½å¡ï¼šæ‹¿å¡ï¼ˆä¸æª¢æŸ¥åœ°ç”¢ï¼‰
          if (img.includes("card2.png")) {
            playerSkills[currentPlayer]++;
            updateStatus();
            // proceed();
            alert(`ğŸ´ æ­å–œï¼ç©å®¶${currentPlayer + 1} ç²å¾—ä¸€å¼µé¿é›£å¡ï¼Œç›®å‰é¿é›£å¡ï¼š${playerSkills[currentPlayer]} å¼µ`);
            logEl.innerText += ` ç²å¾—1å¼µé¿é›£å¡`;
            logEl.scrollTop = logEl.scrollHeight;
            currentPlayer = (currentPlayer + 1) % nPlayers;
            document.getElementById("currentPlayer").textContent = currentPlayer + 1;
            return;
          }
          if (img.includes("underdesk.png")) {
            playerScores[currentPlayer] += 5;
            updateStatus();
            // proceed();
            alert(`ğŸ´ æ­å–œï¼æ­£ç¢ºèº²é¿è§€å¿µï¼Œç©å®¶${currentPlayer + 1} åŠ 5åˆ†`);
            logEl.innerText += ` æ­£ç¢ºèº²é¿è§€å¿µï¼ŒåŠ 5åˆ†`;
            logEl.scrollTop = logEl.scrollHeight;
            checkScoreWin();
            currentPlayer = (currentPlayer + 1) % nPlayers;
            document.getElementById("currentPlayer").textContent = currentPlayer + 1;
            return;
          }



          if (img.includes("bag1.png")) {
            playerScores[currentPlayer] += 5;
            updateStatus();
            // proceed();
            alert(`ğŸ´ æ­å–œï¼å®¶ä¸­å‚™å¦¥æ€¥æ•‘åŒ…ï¼Œç©å®¶${currentPlayer + 1} åŠ 5åˆ†`);
            logEl.innerText += ` åŠ 5åˆ†`;
            logEl.scrollTop = logEl.scrollHeight;
            checkScoreWin();
            currentPlayer = (currentPlayer + 1) % nPlayers;
            document.getElementById("currentPlayer").textContent = currentPlayer + 1;
            return;
          }
		  if (img.includes("light.png")) {
            playerScores[currentPlayer] += 5;
            updateStatus();
            // proceed();
            alert(`ğŸ´ æ­å–œï¼å®¶ä¸­å‚™æœ‰æ‰‹é›»ç­’ï¼Œç©å®¶${currentPlayer + 1} åŠ 5åˆ†`);
            logEl.innerText += ` åŠ 5åˆ†`;
            logEl.scrollTop = logEl.scrollHeight;
            checkScoreWin();
            currentPlayer = (currentPlayer + 1) % nPlayers;
            document.getElementById("currentPlayer").textContent = currentPlayer + 1;
            return;
          }

          // 3) backï¼šé€€å›èµ·é»ï¼ˆä¸æª¢æŸ¥åœ°ç”¢ï¼‰
          if (img.includes("back.png")) {
            alert("ğŸ“¢ é€€å›èµ·é»");
            log.innerText += ` ç©å®¶${currentPlayer + 1}ï¼Œé€€å›èµ·é»`;
            playerSteps[currentPlayer] = 0;
            renderPlayers();                  // ç«‹å³é‡ç¹ªæ£‹å­ä½ç½®
            updateStatus();
            currentPlayer = (currentPlayer + 1) % nPlayers;
            document.getElementById("currentPlayer").textContent = currentPlayer + 1;
            return;
          }
          //console.log(img, "quizåˆ¤æ–·");
          // 4) quizï¼šå•ç­”ï¼ˆä¸æª¢æŸ¥åœ°ç”¢ï¼‰

          const imgNow = (typeof getCellImageSrc === 'function') ? getCellImageSrc(toIndex) : (mapData[toIndex] || "");

          if (isQuizTileName(imgNow)) {
  if (isAskingQuiz) return; // é¿å…é‡è¤‡å‡ºé¡Œ
  isAskingQuiz = true;

  // ğŸ”¹è¾¨è­˜é¡Œç›®é¡å‹
  let category = null;
  if (imgNow.includes("quiz_earthquake.png")) category = "earthquake";
  else if (imgNow.includes("quiz_fire.png")) category = "fire";
  else if (imgNow.includes("quiz_water.png")) category = "water";


if (!USE_AI_QUIZ) {
    // ä¸ä½¿ç”¨ AIï¼šç›´æ¥å‡ºé¡Œåº«
    const q = getRandomQuiz(category);
    askQuiz(
      currentPlayer,
      () => {
        playerScores[currentPlayer] += 3;
        logEl.innerText += ` âœ… ç©å®¶${currentPlayer + 1} ç­”å° ${catNameTC(category)} é¡Œï¼šã€Œ${q.question}ã€ +3 åˆ†`;
        logEl.scrollTop = logEl.scrollHeight;
        updateStatus();
        checkScoreWin();
        isAskingQuiz = false;
        nextTurn();
      },
      () => {
        logEl.innerText += ` âŒ ç©å®¶${currentPlayer + 1} ç­”éŒ¯ ${catNameTC(category)} é¡Œï¼šã€Œ${q.question}ã€`;
        logEl.scrollTop = logEl.scrollHeight;
        isAskingQuiz = false;
        nextTurn();
      },
      q
    );
    return;
  }
// ä½¿ç”¨ AIï¼šç›´æ¥å‡ºé¡Œåº«

  // ğŸ”¹ç›´æ¥å¯«åœ¨ç¨‹å¼è£¡çš„ API KEY
  const  GEMINI_KEY = localStorage.getItem("gemini_api_key");
if (! GEMINI_KEY) {
  alert("âš ï¸ ç„¡å¯ç”¨API Key æ”¹ç”¨é¡Œåº«ï¼");  
}	


  



  async function aiGenerateQuiz(category) {
    const topicMap = { fire: "ç«ç½", water: "æ°´ç½", earthquake: "åœ°éœ‡" };
    const topic = topicMap[category] || "é˜²ç½";
    const prompt = `è«‹å‡ºä¸€é¡Œèˆ‡${topic}é˜²ç½æœ‰é—œçš„å–®é¸é¡Œï¼Œé¡Œç›®é›£åº¦ç‚º10è‡³12æ­²ç¨‹åº¦ï¼Œ
æä¾›é¡Œç›®èˆ‡å››å€‹é¸é …ï¼ˆAâ€“Dï¼‰ï¼Œæœ€å¾Œè«‹æ¨™æ˜æ­£ç¢ºç­”æ¡ˆï¼ˆAâ€“Dï¼‰ã€‚
æ ¼å¼å¦‚ä¸‹ï¼š
é¡Œç›®ï¼šAIå‡ºé¡Œï¼......
A) ......
B) ......
C) ......
D) ......
ç­”æ¡ˆï¼šA`;





    try {
      const res = await fetch("https://wispy-firefly-8762.yingli0923.workers.dev/api/gemini", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ role: "user", parts: [{ text: prompt }] }]
          })
        }
      );
      const data = await res.json();
      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
      const parsed = parseGeminiQuizText(text);
if (!parsed) throw new Error("AI æ ¼å¼éŒ¯èª¤");

// âœ… çµ±ä¸€æ ¼å¼ï¼šè½‰æˆ answerï¼ˆ0~3ï¼‰
return {
category: category,
  question: parsed.question,
  options: parsed.options,
  answer: typeof parsed.answerIndex === "number"
    ? parsed.answerIndex
    : parsed.answer
};
    } catch (e) {
      console.warn("AI å‡ºé¡Œå¤±æ•—:", e);
      return null;
    }
  }

  // ğŸ”¹é–‹å§‹ AI å‡ºé¡Œï¼ˆå¤±æ•—å†ç”¨é¡Œåº«ï¼‰
 (async () => {
  try {
  pauseTimer();  // â˜… é€²å…¥ AI å‡ºé¡Œ â†’ å…ˆæš«åœå€’æ•¸
    // ğŸ§  é¡¯ç¤ºé®ç½©
	
    showQuizOverlay(`â³ æ­£åœ¨ç”Ÿæˆã€Œ${catNameTC(category)}ã€ç›¸é—œå•é¡Œâ€¦`);

    // âš™ï¸ ç”Ÿæˆé¡Œç›®
    let q = await aiGenerateQuiz(category);

    // ğŸ” å¦‚æœAIå¤±æ•— â†’ fallback é¡Œåº«
    if (!q) {
      setQuizOverlayText(`ğŸ“˜ ä½¿ç”¨é¡Œåº«å‡ºé¡Œä¸­...`);
      q = getRandomQuiz(category);
    }

    // âœ… é—œé–‰é®ç½©ï¼ˆç”Ÿæˆå®Œæˆï¼‰
    hideQuizOverlay();
	resumeTimer();  // â˜… é¡Œç›®æº–å‚™å¥½ï¼ˆæˆ–å¤±æ•— fallbackï¼‰â†’ æ¢å¾©å€’æ•¸
    // ğŸ§© å‡ºé¡Œ
    askQuiz(
      currentPlayer,
      () => {
        playerScores[currentPlayer] += 3;
        logEl.innerText += ` âœ… ç©å®¶${currentPlayer + 1} ç­”å° ${catNameTC(category)} é¡Œï¼šã€Œ${q.question}ã€ +3 åˆ†`;
        logEl.scrollTop = logEl.scrollHeight;
        updateStatus();
        checkScoreWin();
        isAskingQuiz = false;
        nextTurn();
      },
      () => {
        logEl.innerText += ` âŒ ç©å®¶${currentPlayer + 1} ç­”éŒ¯ ${catNameTC(category)} é¡Œï¼šã€Œ${q.question}ã€`;
        logEl.scrollTop = logEl.scrollHeight;
        isAskingQuiz = false;
        nextTurn();
      },
      q
    );
  } catch (err) {
    console.error("AI å‡ºé¡ŒéŒ¯èª¤ï¼Œä½¿ç”¨é¡Œåº«ï¼š", err);
    hideQuizOverlay(); // âš ï¸ ç¢ºä¿å‡ºéŒ¯æ™‚ä¹Ÿé—œæ‰é®ç½©
	resumeTimer();
    const q = getRandomQuiz(category);
    askQuiz(currentPlayer, ()=>{}, ()=>{}, q);
  }
})();

  return; // å‡ºé¡Œå®Œå°±çµæŸ
}
		  
		  
		  
		  
		  
          // 5) æ‹†åœ°ï¼šå•ç­”ï¼ˆä¸æª¢æŸ¥åœ°ç”¢ï¼‰
          // fire2ï¼šæ£®æ—åœ°ï¼ˆç”¨ askfireQuestionï¼‰
          if (imgNow.includes("fire2.png")) {
            handleOwnershipQuiz("fire2.png", "fire_station", "æ£®æ—åœ°", toIndex, askfireQuestion, () => {
              const pKeyAfterEvent = propertyKeys[toIndex] || getPropertyKey(getCellImageSrc(toIndex));
              if (pKeyAfterEvent) {
                handleProperty(toIndex, () => {
                  currentPlayer = (currentPlayer + 1) % nPlayers;
                  document.getElementById("currentPlayer").textContent = currentPlayer + 1;
                  updateStatus();
                });
              } else {
                currentPlayer = (currentPlayer + 1) % nPlayers;
                document.getElementById("currentPlayer").textContent = currentPlayer + 1;
                updateStatus();
              }
            });
            return;
          }

          // rain1ï¼šä½çªªåœ°ï¼ˆç”¨ askWaterBureauQuestionï¼‰
          if (imgNow.includes("rain1.png")) {
            handleOwnershipQuiz("rain1.png", "water_bureau", "ä½çªªåœ°", toIndex, askWaterBureauQuestion, () => {
              const pKeyAfterEvent = propertyKeys[toIndex] || getPropertyKey(getCellImageSrc(toIndex));
              if (pKeyAfterEvent) {
                handleProperty(toIndex, () => {
                  currentPlayer = (currentPlayer + 1) % nPlayers;
                  document.getElementById("currentPlayer").textContent = currentPlayer + 1;
                  updateStatus();
                });
              } else {
                currentPlayer = (currentPlayer + 1) % nPlayers;
                document.getElementById("currentPlayer").textContent = currentPlayer + 1;
                updateStatus();
              }
            });
            return;
          }

          // earthquake3ï¼šé«˜æ¨“å¤§å»ˆï¼ˆç”¨ askMuseumQuestionï¼‰
          if (imgNow.includes("earthquake3.png")) {
            handleOwnershipQuiz("earthquake3.png", "museum921", "é«˜æ¨“å¤§å»ˆ", toIndex, askMuseumQuestion, () => {
              const pKeyAfterEvent = propertyKeys[toIndex] || getPropertyKey(getCellImageSrc(toIndex));
              if (pKeyAfterEvent) {
                handleProperty(toIndex, () => {
                  currentPlayer = (currentPlayer + 1) % nPlayers;
                  document.getElementById("currentPlayer").textContent = currentPlayer + 1;
                  updateStatus();
                });
              } else {
                currentPlayer = (currentPlayer + 1) % nPlayers;
                document.getElementById("currentPlayer").textContent = currentPlayer + 1;
                updateStatus();
              }
            });
            return;
          }





          // 5) è‹¥ landing æ˜¯äº‹ä»¶æ ¼ï¼Œä¸”æœ¬æ¬¡äº‹ä»¶æ˜¯ã€Œä½ç§»å‹äº‹ä»¶ã€ï¼Œåšäº‹ä»¶é€£é–ï¼ˆä¸æª¢æŸ¥åœ°ç”¢ï¼‰
          if ((img.includes("event1.png") || img.includes("event2.png")) && moveEffects.includes(event.effect)) {
            //alert("é€£é–äº‹ä»¶å¡");
            const nextEvent = eventList[Math.floor(Math.random() * eventList.length)];
            setTimeout(() => {
              handleEventEffect(nextEvent, newStep);
            }, 200);
            return;
          }
          // 6) ä»¥ä¸Šçš†é â†’ åœ¨é€™è£¡æª¢æŸ¥åœ°ç”¢ï¼ˆè²·åœ°ï¼æ”¶è²»ï¼‰ï¼Œè™•ç†å®Œæ‰æ›äºº
          const imgSrcNow = getCellImageSrc(toIndex);
          console.log('LAND after event:', toIndex, imgSrcNow, 'cachedKey=', propertyKeys[toIndex]);

          const pKeyAfterEvent = propertyKeys[toIndex] || getPropertyKey(imgSrcNow);
          if (pKeyAfterEvent) {
            handleProperty(toIndex, () => {
              currentPlayer = (currentPlayer + 1) % nPlayers;
              document.getElementById("currentPlayer").textContent = currentPlayer + 1;
              updateStatus();
            });
          } else {
            currentPlayer = (currentPlayer + 1) % nPlayers;
            document.getElementById("currentPlayer").textContent = currentPlayer + 1;
            updateStatus();
          }
        }, animDir);
      });
    }
    document.addEventListener('keydown', function (e) {
      if ((e.code === "Space" || e.key === " ") && !gameEnded) {
        e.preventDefault();
        rollDice();
      }
    });
// ===== é¡¯ç¤ºè¢å¹•/è¦–çª—å°ºå¯¸ï¼ˆé™¤éŒ¯ç”¨ï¼‰=====
// ===== ä¿®æ­£ç‰ˆï¼šé¡¯ç¤ºè¢å¹•/è¦–çª—å°ºå¯¸ï¼ˆåŒ…å«æ²å‹•åµæ¸¬ï¼‰=====
function updateScreenInfo() {
  const el = document.getElementById("screen-info");
  if (!el) return;

  const vv = window.visualViewport;
  
  // 1. Screen: ç‰©ç†è¢å¹•ç¸½å¤§å°
  const sW = window.screen.width;
  const sH = window.screen.height;

  // 2. Window Inner: ç€è¦½å™¨å…§éƒ¨å¯ç”¨å¤§å° (ä¸å«å·¥å…·åˆ—)
  const iW = window.innerWidth;
  const iH = window.innerHeight;

  // 3. Visual Viewport: å¯¦éš›å¯è¦‹å€åŸŸ (éš¨æ‰‹æ©Ÿç¶²å€åˆ—ä¼¸ç¸®è®Šå‹•)
  const vW = Math.round(vv ? vv.width : iW);
  const vH = Math.round(vv ? vv.height : iH);

  const sY = Math.round(window.scrollY);
  const cell = getComputedStyle(document.documentElement).getPropertyValue("--cell").trim();

  el.innerHTML = `
    <div style="background: rgba(0,0,0,0.05); padding: 8px; border: 1px solid #111; border-radius: 8px; line-height: 1.4;">
      <b style="color:#d32f2f;">DEBUG MONITOR:</b><br>
      ğŸ–¥ï¸ <b>Screen:</b> ${sW} Ã— ${sH}<br>
      ğŸ–¼ï¸ <b>Window Inner:</b> ${iW} Ã— ${iH}<br>
      ğŸ” <b>Visual Viewport:</b> ${vW} Ã— ${vH}<br>
      ğŸ“œ <b>Scroll Y:</b> ${sY}px | ğŸ§± <b>Cell Size:</b> ${cell}<br>
      â° <b>Last Update:</b> ${new Date().toLocaleTimeString()}
    </div>
  `;
}
// ç›£è½æ‰€æœ‰å¯èƒ½çš„è®Šå‹•äº‹ä»¶
// ===== å¼·è£½ç›£è½æ‰€æœ‰è®Šå‹•äº‹ä»¶ =====



function checkOrientation() {
  const vv = window.visualViewport;
  const h = vv ? vv.height : window.innerHeight;
  const w = vv ? vv.width : window.innerWidth;

  // åˆ¤æ–·æ¢ä»¶ï¼šå¯¬åº¦ > é«˜åº¦ (æ©«å‘) ä¸” é«˜åº¦å°æ–¼ 500px (å¸¸è¦‹ 4~6 å‹æ‰‹æ©Ÿæ©«æ”¾é«˜åº¦)
  if (w > h && h < 500) {
    if (!document.getElementById("rotate-overlay")) {
      showRotateOverlay();
    }
  } else {
    // è½‰å›ç›´å‘æ™‚ç§»é™¤é®ç½©
    const overlay = document.getElementById("rotate-overlay");
    if (overlay) overlay.remove();
  }
}

function showRotateOverlay() {
  const overlay = document.createElement("div");
  overlay.id = "rotate-overlay";
  overlay.style = `
    position: fixed; inset: 0; background: rgba(0,0,0,0.9);
    color: white; display: flex; flex-direction: column;
    align-items: center; justify-content: center; z-index: 100000;
    text-align: center; padding: 20px; font-family: sans-serif;
  `;
  overlay.innerHTML = `
    <div style="font-size: 50px; margin-bottom: 20px;">ğŸ”„</div>
    <h2 style="margin: 0;">è«‹å°‡æ‰‹æ©Ÿè½‰å›ã€Œç›´å‘ã€</h2>
    <p style="opacity: 0.8; margin-top: 10px;">æ‰‹æ©Ÿæ©«æ”¾ç©ºé–“ä¸è¶³ï¼Œå»ºè­°ä½¿ç”¨ç›´å‘æ¨¡å¼ä»¥ç²å¾—æœ€ä½³éŠæˆ²é«”é©—ã€‚</p>
    <button onclick="this.parentElement.remove()" style="margin-top: 20px; padding: 10px 20px; border-radius: 8px; border: none; background: #ffd400; color: #111; font-weight: bold;">
      æˆ‘çŸ¥é“äº†ï¼Œç¹¼çºŒç€è¦½
    </button>
  `;
  document.body.appendChild(overlay);
}


function initDimensionMonitor() {
  const refresher = () => {
    fitCellToFirstScreen(true);
    updateScreenInfo();
	checkOrientation(); // æ–°å¢ï¼šæ¯æ¬¡è®Šå‹•éƒ½æª¢æŸ¥æ–¹å‘
  };

  window.addEventListener("resize", refresher);
  window.addEventListener("scroll", updateScreenInfo);

  if (window.visualViewport) {
    window.visualViewport.addEventListener("resize", refresher);
    window.visualViewport.addEventListener("scroll", updateScreenInfo);
  }
checkOrientation();
  // æ¯ç§’æ›´æ–°ä¸€æ¬¡ï¼Œç¢ºä¿æ™‚é–“å’Œç‹€æ…‹æ­£å¸¸
  setInterval(updateScreenInfo, 1000);
}








function showConfirm(msg, { okText = "å¥½", cancelText = "å–æ¶ˆ" } = {}) {
  return new Promise((resolve) => {
    const overlay = document.createElement("div");
    overlay.className = "dm-overlay";
    const box = document.createElement("div");
    box.className = "dm-box";
    const p = document.createElement("div");
    p.textContent = msg;
    const actions = document.createElement("div");
    actions.className = "dm-actions";
    const btnCancel = document.createElement("button");
    btnCancel.className = "dm-btn cancel";
    btnCancel.textContent = cancelText;
    const btnOk = document.createElement("button");
    btnOk.className = "dm-btn ok";
    btnOk.textContent = okText;

    btnCancel.onclick = () => { document.body.removeChild(overlay); resolve(false); };
    btnOk.onclick = () => { document.body.removeChild(overlay); resolve(true); };
    overlay.onclick = (e) => { if (e.target === overlay) btnCancel.onclick(); }; // é»é®ç½©å–æ¶ˆ
    actions.append(btnCancel, btnOk);
    box.append(p, actions);
    overlay.appendChild(box);
    document.body.appendChild(overlay);
  });
}

// ----- è‡ªè¨‚ ALERTï¼ˆä½ç½®å¯æ§ã€å¤–è§€èˆ‡ confirm ä¸€è‡´ï¼‰-----
function showAlert(message, { okText = "ç¢ºèª" } = {}) {
  return new Promise((resolve) => {
    const overlay = document.createElement("div");
    overlay.className = "dm-overlay";          // â† ç”¨ä½ å·²å­˜åœ¨çš„æ¨£å¼
    const box = document.createElement("div");
    box.className = "dm-box";

    const content = document.createElement("div");
    content.textContent = String(message);

    const actions = document.createElement("div");
    actions.className = "dm-actions";
    const btnOk = document.createElement("button");
    btnOk.className = "dm-btn ok";
    btnOk.textContent = okText;

    btnOk.onclick = () => { document.body.removeChild(overlay); resolve(); };
    overlay.onclick = (e) => { if (e.target === overlay) btnOk.onclick(); }; // é»é®ç½©ï¼é—œé–‰

    actions.appendChild(btnOk);
    box.append(content, actions);
    overlay.appendChild(box);
    document.body.appendChild(overlay);
  });
}

// å…¨åŸŸè¦†å¯« alertï¼šä¹‹å¾Œå‘¼å« alert("è¨Šæ¯") æœƒé¡¯ç¤ºåœ¨ç›¸åŒä½ç½®
// å‚™è¨»ï¼šé€™æ˜¯éé˜»å¡çš„ã€‚è‹¥ä½ æƒ³ç­‰å¾…ä½¿ç”¨è€…æŒ‰ã€Œå¥½ã€å†ç¹¼çºŒï¼Œè«‹åœ¨å‘¼å«è™•ç”¨ `await alert("...")`ã€‚
window.alert = (msg) => showAlert(msg);

  </script>
  
  
  
  </div>
</body>

</html>