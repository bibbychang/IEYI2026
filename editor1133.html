<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç·¨è¼¯åœ°åœ–</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 1rem;
	 background: url('background.jpg') center / cover no-repeat fixed;
    }

    :root {
      --gap: 2px;
      --cell: 70px; 
    }
#map {
      display: grid;
      grid-template-columns: repeat(8, var(--cell));      
      grid-template-rows: repeat(8, var(--cell));     
      gap: var(--gap);
      width: calc(var(--cell) * 8 + var(--gap) * 7);
      height: calc(var(--cell) * 8 + var(--gap) * 7);     
	  margin: 0 auto; /* æ–°å¢ï¼šè®“åœ°åœ–åœ¨åœ°åœ–å€å¡Šå…§ç½®ä¸­20260113 */
    }




    .cell {
      width: var(--cell);      
      height: var(--cell);      
      border: 1px solid #aaa;
      position: relative;
      overflow: hidden;
      background: white;
    }

    .cell img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      position: absolute;
      top: 0;
      left: 0;
    }

    .order-number {
      position: absolute;
      bottom: 2px;
      right: 4px;
      font-size: 10px;
      background: rgba(255, 255, 255, 0.7);
      padding: 1px 3px;
      border-radius: 4px;
    }

  
   #sidebar {
      display: grid;
      grid-template-columns: repeat(10, var(--cell));/* âœ… å¼·åˆ¶ 10 æ¬„ï¼Œæ¯æ¬„ç­‰å¯¬   repeat(8, 1fr)*/
      gap: var(--gap);
      width: 100%;
      max-width: calc(var(--cell) * 10 + var(--gap) * 9);
     margin: 0 0 5px 0; /* ä¿®æ”¹ï¼šæœ€å¾Œä¸€å€‹å€¼æ”¹ç‚º auto å³å¯æ°´å¹³ç½®ä¸­ */
    }
    #sidebar img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      cursor: grab;
      border: 1px solid #aaa;
      border-radius: 6px;
      margin: 0;      
      background: white;
    }
#sidebar img.item {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
    
	#sidebar .item-wrapper {
      width: 100%;
      aspect-ratio: 1 / 1;
      position: relative;
      
    }

    #sidebar .item-wrapper .tooltip {
      visibility: hidden;
      opacity: 0;
      width: max-content;
      max-width: 150px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 8px;
      position: absolute;
      z-index: 10;
      bottom: 105%;
      left: 50%;
      transform: translateX(-50%);
      transition: opacity 0.3s;
      font-size: 12px;
      pointer-events: none;
      white-space: pre-line;
    }

    #sidebar .item-wrapper:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }

    .drop-item-wrapper,
    .map-item-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;      
      justify-content: center;
      align-items: center;
    }

    .drop-item-wrapper img,    .map-item-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: contain;      
      pointer-events: none;
    }


    .drop-item-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border: 1px solid #aaa;
      border-radius: 6px;
      background: white;
    }

    .drop-tooltip {
      visibility: hidden;
      opacity: 0;
      width: max-content;
      max-width: 140px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 2px 2px;
      /*position: absolute;*/
      z-index: 10;
      bottom: auto;
      top: -8px;

      transition: opacity 0.3s;
      font-size: 12px;
      pointer-events: none;
      white-space: pre-line;
    }

    .drop-item-wrapper:hover .drop-tooltip {
      visibility: visible;
      opacity: 1;
    }



    .map-item-wrapper:hover .map-tooltip {
      visibility: visible;
      opacity: 1;
    }

    .map-tooltip {
      visibility: hidden;
      opacity: 0;
      /*position: absolute;*/
      background-color: #333;
      color: white;
      text-align: center;
      padding: 2px 2px;
      border-radius: 6px;
      bottom: 105%;
      left: 50%;

      font-size: 12px;
      white-space: pre-line;
      z-index: 10;
      transition: opacity 0.3s;
    }
	
#sidebar img.item.is-selected {
  outline: 3px solid red;
  outline-offset: 2px;
}
 /* Layout (å·¦ï¼šç·¨è¼¯ / å³ï¼šèªªæ˜) */
    #layout {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      width: 100%;
      min-height: 100vh;
      box-sizing: border-box;
      justify-content: center; /* å¤§è¢å¹•ä¸è¦ç•™ä¸€å¤§ç‰‡ã€Œä¸­é–“ç©ºç™½ã€ */
    }

    #left-panel {
  flex: 0 0 auto;
  display: flex;           /* æ–°å¢ */
  flex-direction: column;  /* æ–°å¢ */
  align-items: center;     /* æ–°å¢ï¼šè®“æ¨™é¡Œã€æŒ‰éˆ•ã€åœ°åœ–å…¨éƒ¨æ°´å¹³ç½®ä¸­ */
  max-width: 100%;
}

    #instructions {
      max-width: 500px;
      border-left: 2px solid #ccc;
      padding-left: 15px;
      box-sizing: border-box;
    }

    /* å°è¢å¹•ï¼šèªªæ˜å€å¡Šç§»åˆ°æœ€ä¸‹é¢ */
    @media (max-width: 798px) {
      #layout { 
        flex-direction: column;
        justify-content: flex-start;
      }
      #left-panel { width: 100%; }
      #instructions {
        max-width: none;
        border-left: none;
        padding-left: 0;
        border-top: 2px solid #ccc;
        padding-top: 15px;
        margin-top: 12px;
      }
    }








html, body { height: 100%; }

body{
  margin: 0;
  min-height: 100vh;
  position: relative;
  background: url('background.jpg') center / cover no-repeat fixed;
}

/* å…¨é æ·¡æ·¡çš„èƒŒæ™¯åœ–ï¼ˆè«‹æ”¾ background.jpg åœ¨åŒå±¤ï¼‰ */
body::before{
  content:"";
  position: fixed;
  inset: 0;
  background: url('background.jpg') center / contain no-repeat;
  opacity: 0.04;          /* è¶Šå°è¶Šæ·¡ï¼Œä¾‹å¦‚ 0.04 æ›´æ·¡ */
  pointer-events: none;
  z-index: -1;
}

/* è®“èƒŒæ™¯åœ–è®Šå¾ˆæ·¡å¾ˆæ·¡ï¼ˆèª¿æ•´é€æ˜åº¦å°±å¥½ï¼‰ */
body::after{
  content:"";
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.95); /* è¶Šæ¥è¿‘ 1 è¶Šæ·¡ï¼š0.85~0.95 è‡ªå·±èª¿ */
  pointer-events: none;
  z-index: 0;
}

/* ç¢ºä¿é é¢å…§å®¹åœ¨é®ç½©ä¸Šé¢ */
body > *{
  position: relative;
  z-index: 1;
}
:root{
  --shadow: 0 10px 24px rgba(0,0,0,.10);
  --card-bg: rgba(255,255,255,.88);
  --card-border: rgba(120,150,255,.35);
  --radius: 18px;
}
/* ===== Instructionï¼ˆå³å´èªªæ˜ï¼‰å¡ç‰‡æ’ç‰ˆï¼šè‡ªå‹•ä¾å¯¬åº¦æ›æ¬„ ===== */
#instructions{
  flex: 1 1 360px;
  max-width: 860px;
  min-width: 320px;
  border-left: 2px solid #ccc;
  padding-left: 15px;
  box-sizing: border-box;
}

#instructions h2{
  margin: 14px 0 10px;
  font-size: 26px;
  letter-spacing: .5px;
}
#instructions h3{
  margin: 0 0 5px;
  font-size: 18px;
}

.grid{
  display: grid;
  gap: 18px;
  margin: 12px 0 18px;
}

/* å¯¬çš„æ™‚å€™å¯ 2 æ¬„ï¼›çª„çš„æ™‚å€™è‡ªå‹• 1 æ¬„ */
.grid.cols-2{
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
}

.card{
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow);
}

.list{
  margin: 0;
  padding-left: 1.2rem;
  line-height: 1.65;
}
.list li{ margin: 8px 0; }

.kbd{
  display: inline-flex;
  align-items: center;
  padding: 2px 10px;
  border-radius: 999px;
  background: rgba(235,243,255,.95);
  border: 1px solid rgba(120,150,255,.45);
  font-size: .92em;
  white-space: nowrap;
}
@media (max-width: 798px){
  #layout{ flex-direction: column; }
  #left-panel{ width: 100%; }

  #instructions{
    max-width: none;
    min-width: 0;
    border-left: none;
    padding-left: 0;
    border-top: 2px solid #ccc;
    padding-top: 15px;
    margin-top: 12px;
  }

  /* æ‰‹æ©Ÿæ›´çª„ï¼šå¡ç‰‡æœ€å°å¯¬åº¦ç¸®å°ï¼Œé¿å…æ°´å¹³æ²è»¸ */
  .grid.cols-2{
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  }
}

  </style>



<style>

#rotate-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.9);
  color: white;
  z-index: 100000;
  display: none; /* é è¨­ä¸é¡¯ç¤º */
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 20px;
  font-family: sans-serif;
}
.rotate-content {
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* ===== é€šç”¨æ¼‚äº®æŒ‰éˆ•ï¼ˆå¯å¥—ç”¨åˆ°æ‰€æœ‰ buttonï¼‰ ===== */
.btn{
  appearance: none;
    border-radius: 999px;
  padding: 10px 14px;
  font-size: 14px;
  font-weight: 700;
  line-height: 0.5;
  cursor: pointer;
  user-select: none;
  box-shadow: 0 8px 20px rgba(0,0,0,.08);
  transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
  white-space: nowrap;
  background: #EBF3FF;
  border: 1px solid #BACCFF;
  color: #1f2a44;
}

.btn:hover{
  transform: translateY(-1px);
  box-shadow: 0 12px 28px rgba(0,0,0,.12);
  background: rgba(255,255,255,.95);
}

.btn:active{
  transform: translateY(0px);
  box-shadow: 0 6px 14px rgba(0,0,0,.10);
}

.btn:focus-visible{
  outline: 3px solid rgba(60,140,255,.45);
  outline-offset: 2px;
}

/* ä¸»æŒ‰éˆ•ï¼ˆé–‹å§‹éŠæˆ²ã€å„²å­˜ã€é€å‡ºç­‰ï¼‰ */
.btn-primary{
  border-color: rgba(40,120,255,.35);
  background: linear-gradient(180deg, rgba(80,160,255,.95), rgba(35,110,255,.95));
  color: #fff;
}
.btn-primary:hover{
  background: linear-gradient(180deg, rgba(95,175,255,.98), rgba(35,110,255,.98));
}

/* å±éšª/æ¸…ç©º */
.btn-danger{
  border-color: rgba(220,60,60,.25);
  background: rgba(255,235,235,.92);
}
.btn-danger:hover{
  background: rgba(255,225,225,.96);
}

/* æ¬¡è¦ï¼ˆç°ï¼‰ */
.btn-secondary{
  border-color: rgba(0,0,0,.10);
  background: rgba(245,245,245,.92);
}
.header-row {
  display: flex;
  align-items: baseline;
  justify-content: flex-start; /* å¼·åˆ¶å…§å®¹å¾å·¦å´é–‹å§‹æ’åˆ— */
  width: 100%;               /* ç¢ºä¿å¯¬åº¦ä½”æ»¿ï¼Œæ‰èƒ½æ¨åˆ°æœ€å·¦é‚Š */
  align-self: flex-start;    /* é—œéµï¼šä¸å—çˆ¶å±¤ (left-panel) çš„ center å½±éŸ¿ */
  gap: 10px;
  flex-wrap: wrap;
}
#screen-info{
  width: auto;
  margin: 0;
  align:left
}
</style>
	
  <script>
(() => {
  const map = document.getElementById('map');
  if (!map) return;

  // â€”â€” æ‰‹æ©Ÿ/å¹³æ¿å°ˆç”¨ Pointer æ‹–æ‹‰ï¼ˆæ¡Œæ©Ÿä¸å•Ÿå‹•ï¼‰â€”â€”
  let dragging = false, ghost = null, filename = null;

  const getCell = (x,y) => document.elementFromPoint(x,y)?.closest('#map .cell');

  document.addEventListener('pointerdown', (e) => {
    if (e.pointerType === 'mouse') return;         // ä¸å¹²æ“¾æ¡Œæ©Ÿ
    const img = e.target.closest('#sidebar img.item');
    if (!img) return;

    e.preventDefault();                             // åªåœ¨è§¸æ§é˜»æ­¢é è¨­
    filename = img.dataset.img || img.getAttribute('src');

    ghost = document.createElement('img');          // è·Ÿæ‰‹çš„å°é è¦½
    ghost.src = filename;
    ghost.style.cssText = `
      position:fixed;left:${e.clientX+12}px;top:${e.clientY+12}px;
      width:40px;height:40px;pointer-events:none;opacity:.9;transform:translate(-50%,-50%);
      border-radius:4px;box-shadow:0 4px 12px rgba(0,0,0,.25);z-index:2147483647;`;
    document.body.appendChild(ghost);

    dragging = true;
    const c = getCell(e.clientX,e.clientY);
    map.querySelectorAll('.cell.hover').forEach(n=>n.classList.remove('hover'));
    if (c) c.classList.add('hover');
  }, { passive: false });

  document.addEventListener('pointermove', (e) => {
    if (!dragging || e.pointerType === 'mouse') return;
    ghost.style.left = (e.clientX+12)+'px';
    ghost.style.top  = (e.clientY+12)+'px';

    const c = getCell(e.clientX,e.clientY);
    map.querySelectorAll('.cell.hover').forEach(n=>n.classList.remove('hover'));
    if (c) c.classList.add('hover');
  }, { passive: true });

  const placeIntoCell = (cell, file) => {
    if (!cell || !file) return;
    const img = document.createElement('img');
    img.src = file; img.alt = ''; img.draggable = false;
    cell.innerHTML = ''; cell.appendChild(img);
  };

  const endDrag = (e) => {
    if (!dragging || e.pointerType === 'mouse') return;
    dragging = false;
    if (ghost) ghost.remove(), (ghost=null);

    const c = getCell(e.clientX,e.clientY);
    placeIntoCell(c, filename);

    filename = null;
    map.querySelectorAll('.cell.hover').forEach(n=>n.classList.remove('hover'));
  };

  document.addEventListener('pointerup', endDrag, { passive: true });
  document.addEventListener('pointercancel', endDrag, { passive: true });
})();
</script>
  
  
</head>

<body>
<div id="rotate-overlay" style="display: none;">
  <div class="rotate-content">
    <div style="font-size: 50px; margin-bottom: 20px;">ğŸ”„</div>
    <h2>è«‹å°‡æ‰‹æ©Ÿè½‰ã€Œç›´å‘ã€ Please turn your phone to "Portrait mode".</h2>
    <p>æ©«å‘ç©ºé–“ä¸è¶³ï¼Œå»ºè­°ä½¿ç”¨ç›´å‘æ¨¡å¼é€²è¡Œç·¨è¼¯ã€‚</p>
    <p>There is insufficient horizontal space; it is recommended to use portrait mode for editing.</p>
    <button onclick="document.getElementById('rotate-overlay').style.display='none'" class="btn btn-primary" style="margin-top: 20px;">æˆ‘çŸ¥é“äº†</button>
  </div>
</div>



<div id="layout">
    <!-- å·¦é‚Šï¼šåŸæœ¬çš„æ§åˆ¶èˆ‡åœ°åœ– -->
    <div id="left-panel">
	
	<div class="header-row">
	<h2 id="title-text" style="    margin-top: 0px;    margin-bottom: 2px;">ğŸ§© ç·¨è¼¯åœ°åœ–èˆ‡è¨­å®š</h2> 
 
	</div>

  
  <div class="topbar">
  <!-- åŸæœ¬çš„èªç³»/æ¨¡å¼/äººæ•¸/AIå‡ºé¡Œ/ screen-info å…¨éƒ¨æ”¾é€™è£¡ -->
  <button class="btn" id="lang-toggle">èªç³»</button>
  <label><input type="radio" name="mode" value="time" onchange="updateMode()"> é™æ™‚åˆ¶</label>
  <select id="timeLimit" disabled>
    <option value="600">10åˆ†é˜</option>
    <option value="1800">30åˆ†é˜</option>
    <option value="3600">60åˆ†é˜</option>
  </select>
  <label style="margin-left: 10px"><input type="radio" name="mode" value="score" checked onchange="updateMode()">
    ç©åˆ†åˆ¶</label>
  <select id="scoreTarget">
    <option value="20">20 åˆ†</option>
    <option value="30">30 åˆ†</option>
    <option value="40">40 åˆ†</option>
  </select>
  <label style="margin-left:10px">äººæ•¸
    <select id="playerCount">
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
    </select>
  </label>

  <div id="ai-quiz-setting" style="margin:8px 0 12px 0;">
  
  
  
  
  
	  <label id="ai-quiz-label" style="display:inline-block; margin-right:8px;">AI å‡ºé¡Œï¼š</label>
	  <label style="margin-right:12px;">
		<input type="radio" name="aiQuiz" value="yes" checked> <span id="ai-quiz-yes">æ˜¯</span></label>
	  <label>
		<input type="radio" name="aiQuiz" value="no"><span id="ai-quiz-no">å¦</span></label>
	  <span id="ai-quiz-hint" style="font-size:12px;color:#666;padding-left:10px;">ã€Œå¦ã€ç”¨é¡Œåº«ï¼ˆä¸å‘¼å« APIã€å¿«ï¼‰</span><!--
	  <label>Gemini API Keyï¼š</label>
	<input type="password" id="apiKeyInput" placeholder="è¼¸å…¥ä½ çš„ API Key">
	<button onclick="saveAPIKey()">å„²å­˜ Key</button>-->
	
	<div id="extra-settings" style="margin:8px 0 12px 0; border-top: 1px dashed #ccc; padding-top: 10px;">
  <div style="margin-bottom: 8px;">
    <label id="cheat-label" style="display:inline-block; margin-right:8px;">ä½œå¼Šæ¨¡å¼ï¼š</label>
    <label style="margin-right:12px;"><input type="radio" name="cheatMode" value="yes" ><span id="cheat-label-yes">æ˜¯</span></label>
    <label><input type="radio" name="cheatMode" value="no" checked><span id="cheat-label-no">å¦</span></label>
    <span id="cheat-hint" style="font-size:12px;color:#666;margin-left:10px;">(é–‹å•Ÿå¾ŒéŠæˆ²ä¸­å¯æŒ‡å®šéª°å­é»æ•¸)</span>
  </div>
  <div>
    <label id="debug-label" style="display:inline-block; margin-right:8px;">Debug æ¨¡å¼ï¼š</label>
    <label style="margin-right:12px;"><input type="radio" name="debugMode" value="yes"><span id="debug-label-yes">æ˜¯</span></label>
    <label><input type="radio" name="debugMode" value="no" checked><span id="debug-label-no">å¦</span></label>
    <span id="debug-hint" style="font-size:12px;color:#666;margin-left:10px;">(é–‹å•Ÿå¾Œé¡¯ç¤ºè¢å¹•è³‡è¨Š)</span>
  </div>
</div>
	
	
</div>
<button class="btn" onclick="loadMap1()">ğŸ“Œ åœ°åœ–1</button><button class="btn" onclick="loadMap2()">ğŸ“Œ åœ°åœ–2</button><button class="btn" onclick="loadMap3()">ğŸ“Œ åœ°åœ–3</button><button class="btn btn-danger" onclick="clearMap()">ğŸ§¹ æ¸…ç©º</button><button class="btn btn-primary" onclick="saveAndStart()">â–¶ é–‹å§‹éŠæˆ²</button><div id="screen-info" style="font-size:10px;color:#666;margin:6px 0 10px 0;"></div>
  
</div>
  
  
  <div id="sidebar" style="padding-top:10px">
    <div class="item-wrapper">
      <img src="start.png" class="item" draggable="true" data-img="start.png">
      <div class="tooltip">èµ·é»ï¼šç©å®¶å¾é€™è£¡é–‹å§‹</div>
    </div>
    <div class="item-wrapper">
      <img src="dice.png" class="item" draggable="true" data-img="dice.png">
      <div class="tooltip">éª°å­æ ¼ï¼šå¯ä»¥å†æ“²ä¸€æ¬¡</div>
    </div>
    <div class="item-wrapper">
      <img src="event1.png" class="item" draggable="true" data-img="event1.png">
      <div class="tooltip">äº‹ä»¶å¡1ï¼šéš¨æ©Ÿäº‹ä»¶</div>
    </div>

    <div class="item-wrapper">
      <img src="ok1.png" class="item" draggable="true" data-img="ok1.png">
      <div class="tooltip">ç„¡ç‰¹æ®Šäº‹ä»¶</div>
    </div>

    <div class="item-wrapper">
      <img src="ok3.png" class="item" draggable="true" data-img="ok3.png">
      <div class="tooltip">ç„¡ç‰¹æ®Šäº‹ä»¶</div>
    </div>
    <div class="item-wrapper">
      <img src="ok2.png" class="item" draggable="true" data-img="ok2.png">
      <div class="tooltip">ç„¡ç‰¹æ®Šäº‹ä»¶</div>
    </div>
    <div class="item-wrapper">
      <img src="quiz_fire.png" class="item" draggable="true" data-img="quiz_fire.png">
      <div class="tooltip">ç­”é¡Œæ ¼ï¼šç­”å°å¯å¾—åˆ†</div>
    </div>

    <div class="item-wrapper">
      <img src="quiz_water.png" class="item" draggable="true" data-img="quiz_water.png">
      <div class="tooltip">ç­”é¡Œæ ¼ï¼šç­”å°å¯å¾—åˆ†</div>
    </div>
    <div class="item-wrapper">
      <img src="quiz_earthquake.png" class="item" draggable="true" data-img="quiz_earthquake.png">
      <div class="tooltip">ç­”é¡Œæ ¼ï¼šç­”å°å¯å¾—åˆ†</div>
    </div>


    <div class="item-wrapper">
      <img src="underdesk.png" class="item" draggable="true" data-img="underdesk.png">
      <div class="tooltip">ç™¼ç”Ÿåœ°éœ‡ï¼Œèº²åˆ°æ¡Œä¸‹ï¼Œæ­£ç¢ºèº²é¿ï¼Œå¯åŠ åˆ†</div>
    </div>
    <div class="item-wrapper">
      <img src="bag1.png" class="item" draggable="true" data-img="bag1.png">
      <div class="tooltip">æ€¥æ•‘åŒ…</div>
    </div>
    <div class="item-wrapper">
      <img src="light.png" class="item" draggable="true" data-img="light.png">
      <div class="tooltip">æ‰‹é›»ç­’</div>
    </div>
    <div class="item-wrapper">
      <img src="back.png" class="item" draggable="true" data-img="back.png">
      <div class="tooltip">é€€å›èµ·é»</div>
    </div>
    <div class="item-wrapper">
      <img src="card2.png" class="item" draggable="true" data-img="card2.png">
      <div class="tooltip">é¿é›£å¡</div>
    </div>
    <div class="item-wrapper">
      <img src="fire2.png" class="item" draggable="true" data-img="fire2.png">
      <div class="tooltip">ç«ç½</div>
    </div>

    <div class="item-wrapper">
      <img src="rain1.png" class="item" draggable="true" data-img="rain1.png">
      <div class="tooltip">æ°´ç½</div>
    </div>
    <div class="item-wrapper">
      <img src="earthquake3.png" class="item" draggable="true" data-img="earthquake3.png">
      <div class="tooltip">åœ°éœ‡</div>
    </div>

    <div class="item-wrapper">
      <img src="fire_station_0.png" class="item" draggable="true" data-img="fire_station_0.png">
      <div class="tooltip">æ£®æ—åœ°</div>
    </div>
   
    <div class="item-wrapper">
      <img src="water_bureau_0.png" class="item" draggable="true" data-img="water_bureau_0.png">
      <div class="tooltip">ä½çªªåœ°</div>
    </div>
    
    <div class="item-wrapper">
      <img src="museum921_0.png" class="item" draggable="true" data-img="museum921_0.png">
      <div class="tooltip">é«˜æ¨“å¤§å»ˆ</div>
    </div>

    

  </div>
  

  <div id="map"></div>
</div>

    
	<div id="instructions"></div>

  </div>

  <script>
    const LANG_KEY = 'gameLang';
    let lang = localStorage.getItem(LANG_KEY) || 'zh'; // 'zh' or 'en'
    if (!lang) {
      lang = 'zh'; // é è¨­ä¸­æ–‡
      localStorage.setItem(LANG_KEY, lang);
    }
    const uiText = {
      zh: {
        title: 'ğŸ§© ç·¨è¼¯åœ°åœ–èˆ‡è¨­å®š',
        toggle_to: 'English',
        mode_time: 'é™æ™‚åˆ¶',
        mode_score: 'ç©åˆ†åˆ¶',
        time_600: '10åˆ†é˜',
        time_1800: '30åˆ†é˜',
        time_3600: '60åˆ†é˜',
        score_20: '20 åˆ†',
        score_30: '30 åˆ†',
        score_40: '40 åˆ†',
        people: 'äººæ•¸',
		aiQuizLabel: 'AI å‡ºé¡Œ',
		aiQuizYes: 'æ˜¯',
		aiQuizNo: 'å¦',
		aiQuizHint: 'ã€Œå¦ã€ç”¨é¡Œåº«ï¼ˆä¸å‘¼å« APIã€å¿«ï¼‰',
		cheat_label: 'ä½œå¼Šæ¨¡å¼ï¼š',
    cheat_yes: 'æ˜¯',
    cheat_no: 'å¦',
    cheat_hint: '(éŠæˆ²ä¸­å¯æŒ‡å®šéª°å­é»æ•¸)',
    debug_label: 'Debug æ¨¡å¼ï¼š',
    debug_yes: 'æ˜¯',
    debug_no: 'å¦',
    debug_hint: '(é¡¯ç¤ºè¢å¹•è³‡è¨Š)',
        map1: 'ğŸ“Œåœ°åœ–1',
        map2: 'ğŸ“Œåœ°åœ–2',
        map3: 'ğŸ“Œåœ°åœ–3',
        clear: 'ğŸ§¹æ¸…ç©º',
        start: 'â–¶é–‹å§‹éŠæˆ²'
		
      },
      en: {
        title: 'Map Editor & Settings',
        toggle_to: 'ä¸­æ–‡ç‰ˆ',
        mode_time: 'Time',
        mode_score: 'Score',
        time_600: '10 min',
        time_1800: '30 min',
        time_3600: '60 min',
        score_20: '20 pts',
        score_30: '30 pts',
        score_40: '40 pts',
        people: 'Players',
		aiQuizLabel: 'AI Questions',
aiQuizYes: 'Yes',
aiQuizNo: 'No',
aiQuizHint: '"No" use built-in question (no API , faster)',
cheat_label: 'Cheat Mode: ',
    cheat_yes: 'Yes',
    cheat_no: 'No',
    cheat_hint: '(Specify dice rolls)',
    debug_label: 'Debug Mode: ',
    debug_yes: 'Yes',
    debug_no: 'No',
    debug_hint: '(Shows screen info)',

        map1: 'ğŸ“ŒMap1',
        map2: 'ğŸ“ŒMap2',
        map3: 'ğŸ“ŒMap3',
        clear: 'ğŸ§¹Clear',
        start: 'â–¶Start'
      }
    };


function getInstructionsHTML(currentLang) {
      const zh = `
  <h2>ğŸš€ éŠæˆ²èªªæ˜ </h2>
  <div class="grid cols-2">
    <div class="card">
      <h3>1) ç·¨è¼¯åœ°åœ–</h3>
      <ol class="list">
        <li>ä¸Šæ–¹é¸é …å¯é¸æ“‡èªè¨€ã€èª¿æ•´éŠæˆ²æ¨¡å¼ï¼ˆç©åˆ† / é™æ™‚ï¼‰ï¼Œè¨­å®šéŠæˆ²äººæ•¸èˆ‡é¸æ“‡å‡ºé¡Œæ–¹å¼</li>
        <li>å¯è‡ªè¡Œæ‹–æ›³è·¯å¾‘åœ–æˆ–é¸æ“‡ <span class="kbd">åœ°åœ–1 / åœ°åœ–2 / åœ°åœ–3</span></li>
        <li>æŒ‰ä¸‹ <span class="kbd">é–‹å§‹éŠæˆ²</span>ï¼Œé–‹å§‹é€²è¡ŒéŠæˆ²</li>
      </ol>
    </div>
    <div class="card">
      <h3>2) é–‹å§‹éŠæˆ²</h3>
      <ol class="list">
        <li>ç©å®¶ä¾åºæŒ‰ <span class="kbd">æ“²éª°</span> ç©å®¶ç§»å‹•ã€‚</li>
        <li>æ£‹å­ç§»å‹•åˆ°æ ¼å­å¾Œæ‰æœƒè§¸ç™¼æ•ˆæœï¼ˆå•ç­”ã€äº‹ä»¶ã€æ‹¿å¡ã€è³¼è²·åœ°ç”¢ç­‰ï¼‰ã€‚</li>
      </ol>
    </div>
  </div>

  <h2>ğŸ“ åŸºæœ¬è¦å‰‡</h2>
  <div class="grid cols-2">
    <div class="card">
      <h3>å›åˆæµç¨‹</h3>
      <ol class="list">
        <li>ç©å®¶æŒ‰ä¸‹ <strong>æ“²éª°</strong>ã€‚</li>
        <li><strong>ä¾éª°å­é»æ•¸è¡Œé€²ç§»å‹•è‡³æ–°ä½ç½®ä¸¦</strong>è§¸ç™¼æ ¼å­æ•ˆæœï¼ˆå•ç­” / äº‹ä»¶ / é¿é›£å¡ / åœ°ç”¢ / é“å…·ï¼‰ã€‚</li>
        <li>è™•ç†çµç®—ï¼ˆåŠ åˆ†ã€è³¼è²·ã€ç§»å‹•ã€æ›äººï¼‰ã€‚</li>
      </ol>
	  <h3>è¦–è¦ºåŒ–è¨˜åˆ†æ¿</h3>
      <ol class="list">
        <li>é¡¯ç¤ºç©å®¶åˆ†æ•¸èˆ‡é€²åº¦æ¢ï¼Œå¢åŠ è‡¨å ´æ„Ÿ</li>
        
      </ol>
    </div>
    <div class="card">
      
	  <h3>äº‹ä»¶å¡</h3>
      <ul class="list">
        <li><strong>å‰é€² 1 / 2 æ ¼</strong>ï¼šå¾€å‰è¡Œé€²ã€‚</li>
        <li><strong>é€€å› 1 / 2 æ ¼</strong>ï¼šå€’é€€è¡Œé€²ã€‚</li>
        <li><strong>å›åˆ°èµ·é»</strong>ï¼šå›åˆ°èµ·é»ï¼Œç›´æ¥æ›äººã€‚</li>
        <li><strong>å¾— 1 / 2 åˆ†</strong>ï¼šå¾—åˆ†ã€‚</li>
        <li><strong>åœä¸€å›åˆ</strong>ï¼šæš«åœä¸€å›åˆã€‚</li>
      </ul>
    </div>
  </div>

  <div class="grid cols-2">
    

    <div class="card">
      <h3>åœ°ç”¢ç³»çµ± è³¼è²·æŒæœ‰èˆ‡ç½æ </h3>
      <ul class="list">
        <li>å¯è³¼è²·çš„åœ°ç”¢ï¼š<strong>é«˜æ¨“å¤§å»ˆ</strong>ã€<strong>æ£®æ—åœ°</strong>ã€<strong>ä½çªªåœ°</strong>ï¼Œå¯ä»¥æ“´å……ã€‚</li>
        <li>æ“æœ‰è¶³å¤ åˆ†æ•¸æ‰èƒ½è³¼è²·ã€‚</li>
        <li>è³¼è²·å¾Œè©²æ ¼èƒŒæ™¯æœƒæ›æˆè©²ç©å®¶çš„é¡è‰²ï¼Œæ¯”å¦‚ç©å®¶1æ˜¯ç´…è‰²ï¼Œç©å®¶2æ˜¯è—è‰²ã€‚</li>
        <li>å…¶ä»–ç©å®¶è¸©åˆ°æ™‚ï¼Œè¦çµ¦å°æ‡‰çš„åˆ†æ•¸ï¼Œè‹¥åˆ†æ•¸ä¸è¶³å¤ ï¼Œèƒ½çµ¦å¤šå°‘å°±çµ¦å¤šå°‘ã€‚</li>
		<li>èµ°åˆ°ç½é›£æ ¼æ™‚ï¼Œæœƒå‡ºå°æ‡‰é¡å‹çš„é¡Œç›®ï¼Œå¦‚æœç­”å°ä¿ç•™è‡ªå·±å°æ‡‰çš„åœ°ç”¢ï¼Œæ‹†é™¤åˆ¥äººå°æ‡‰çš„åœ°ç”¢ï¼Œå¦‚æœç­”éŒ¯æ‹†é™¤è‡ªå·±å°æ‡‰çš„åœ°ç”¢ï¼Œä¿ç•™åˆ¥äººå°æ‡‰çš„åœ°ç”¢ï¼Œè‹¥ç„¡å°æ‡‰åœ°ç”¢å‰‡ç„¡ä½œç”¨</li>		
      </ul>
    </div>
	<div class="card">
      <h3>è¨ˆåˆ†åŠ åˆ†ä¾†æº</h3>
      <ul class="list">
        <li>ç­”å°å•ç­”ï¼ˆé è¨­ +3ï¼‰åŒ…å«ï¼šåœ°éœ‡ã€ç«ç½ã€æ°´ç½ç­‰åˆ†é¡ã€‚</li>
        <li>æ’¿åˆ°é˜²ç½åŒ…ã€æ­£ç¢ºèº²é¿ï¼ˆé è¨­ +5ï¼‰ã€‚</li>
        <li>å®Œæˆä¸€åœˆï¼ˆé è¨­ +1ï¼‰ã€‚</li>
        <li>å…¶ä»–ç©å®¶èµ°åˆ°ä½ çš„åœ°ï¼ˆé è¨­ +3ï¼‰ã€‚</li>
      </ul>
    </div>
  </div>

  <div class="grid cols-2">
    
    <div class="card">
      <h3>å‹åˆ©æ¢ä»¶</h3>
      <ul class="list">
        <li>ç©åˆ†åˆ¶ï¼šå…ˆé” <span class="kbd">ç›®æ¨™åˆ†æ•¸</span>ï¼ˆä¾‹å¦‚ 20 åˆ†ï¼‰ã€‚</li>
        <li>é™æ™‚åˆ¶ï¼šæ™‚é–“çµæŸï¼Œæ¯”è¼ƒåˆ†æ•¸é«˜ä½ã€‚</li>
      </ul>
    </div>
	<div class="card">
      <h3>ä½œç­”çµ±è¨ˆ</h3>
      <ul class="list">
        <li>éŠæˆ²çµæŸå¾Œå¯åˆ—å‡ºå…¨éƒ¨ç­”é¡Œç‹€æ…‹</li>
        <li>å¯ä»¥é¡¯ç¤ºæ¯ä½ç©å®¶ç­”å°çš„æ¯”ä¾‹</li>       
      </ul>
    </div>
  </div>  
      `;

     const en = `
  <h2>ğŸš€ Game Instructions</h2>
  <div class="grid cols-2">
    <div class="card">
      <h3>1) Edit the Map</h3>
      <ol class="list">
        <li>Use the options at the top to choose a language, adjust the game mode (Score / Timed), set the number of players, and choose the question method.</li>
        <li>You can drag and edit the path yourself, or select <span class="kbd">Map 1 / Map 2 / Map 3</span>.</li>
        <li>Click <span class="kbd">Start Game</span> to begin playing.</li>
      </ol>
    </div>
    <div class="card">
      <h3>2) Start Playing</h3>
      <ol class="list">
        <li>Players take turns pressing <span class="kbd">Roll Dice</span> to move.</li>
        <li>Tile effects trigger only after the token lands on a tile (quiz, events, drawing cards, buying property, etc.).</li>
      </ol>
    </div>
  </div>

  <h2>ğŸ“ Basic Rules</h2>
  <div class="grid cols-2">
    <div class="card">
      <h3>Turn Flow</h3>
      <ol class="list">
        <li>The player clicks <strong>Roll Dice</strong>.</li>
        <li><strong>Move forward based on the dice result</strong> to a new position and trigger the tile effect (Quiz / Event / Shelter Card / Property / Item).</li>
        <li>Resolve results (score changes, purchases, movement, switch turns).</li>
      </ol>
      <h3>Visual Scoreboard</h3>
      <ol class="list">
        <li>Shows player scores and progress bars to enhance immersion.</li>
      </ol>
    </div>
    <div class="card">
      <h3>Event Cards</h3>
      <ul class="list">
        <li><strong>Move forward 1 / 2 tiles</strong>: Advance.</li>
        <li><strong>Move back 1 / 2 tiles</strong>: Go backward.</li>
        <li><strong>Return to Start</strong>: Go back to the start and immediately switch turns.</li>
        <li><strong>Gain 1 / 2 points</strong>: Earn points.</li>
        <li><strong>Skip one turn</strong>: Miss your next turn.</li>
      </ul>
    </div>
  </div>

  <div class="grid cols-2">
    <div class="card">
      <h3>Property System: Buy, Own, and Disaster Damage</h3>
      <ul class="list">
        <li>Buyable properties include: <strong>High-rise Building</strong>, <strong>Forest Land</strong>, and <strong>Low-lying Area</strong> (expandable).</li>
        <li>You must have enough points to purchase.</li>
        <li>After purchase, the tile background changes to the playerâ€™s color (e.g., Player 1 = red, Player 2 = blue).</li>
        <li>When other players land on it, they must pay the corresponding points; if they donâ€™t have enough, they pay as much as they can.</li>
        <li>On a disaster tile, a question of the corresponding type appears. If answered correctly, you keep your own matching properties and remove othersâ€™ matching properties; if answered incorrectly, your matching properties are removed and othersâ€™ matching properties remain. If no matching properties exist, nothing happens.</li>
      </ul>
    </div>
    <div class="card">
      <h3>Score Sources</h3>
      <ul class="list">
        <li>Correct quiz answers (default +3), including categories such as earthquakes, fires, floods, etc.</li>
        <li>Picking up an emergency kit / correct avoidance action (default +5).</li>
        <li>Completing one full lap (default +1).</li>
        <li>Other players landing on your property (default +3).</li>
      </ul>
    </div>
  </div>

  <div class="grid cols-2">
    <div class="card">
      <h3>Win Conditions</h3>
      <ul class="list">
        <li>Score Mode: Reach the <span class="kbd">target score</span> first (e.g., 20 points).</li>
        <li>Timed Mode: When time is up, the higher score wins.</li>
      </ul>
    </div>
    <div class="card">
      <h3>Answer Statistics</h3>
      <ul class="list">
        <li>After the game ends, you can list the full answer status.</li>
        <li>You can show each playerâ€™s correct-answer rate.</li>
      </ul>
    </div>
  </div>
`;

      return (currentLang === 'en') ? en : zh;
    }

    function renderInstructions() {
      const box = document.getElementById('instructions');
      if (box) box.innerHTML = getInstructionsHTML(lang);
    }


    function renderLangButton() {
      document.documentElement.lang = (lang === 'en') ? 'en' : 'zh-Hant';

      // åˆ‡æ›æŒ‰éˆ•æ–‡å­—
      const btn = document.getElementById('lang-toggle');
      if (btn) btn.textContent = uiText[lang].toggle_to;

      // æ¨™é¡Œ
      const title = document.getElementById('title-text');
      if (title) title.textContent = uiText[lang].title;

      // å–®é¸æ¨™ç±¤ï¼ˆé™æ™‚åˆ¶ / ç©åˆ†åˆ¶ï¼‰
      const timeLabel = document.querySelector('label input[value="time"]').parentNode;
      const scoreLabel = document.querySelector('label input[value="score"]').parentNode;
      timeLabel.lastChild.nodeValue = ' ' + uiText[lang].mode_time;
      scoreLabel.lastChild.nodeValue = ' ' + uiText[lang].mode_score;

      // ä¸‹æ‹‰é¸é …ï¼ˆæ™‚é–“é™åˆ¶ï¼‰
      const timeSel = document.getElementById('timeLimit');
      timeSel.options[0].text = uiText[lang].time_600;
      timeSel.options[1].text = uiText[lang].time_1800;
      timeSel.options[2].text = uiText[lang].time_3600;

      // ä¸‹æ‹‰é¸é …ï¼ˆç›®æ¨™åˆ†æ•¸ï¼‰
      const scoreSel = document.getElementById('scoreTarget');
      scoreSel.options[0].text = uiText[lang].score_20;
      scoreSel.options[1].text = uiText[lang].score_30;
      scoreSel.options[2].text = uiText[lang].score_40;

      // äººæ•¸æ¨™ç±¤
      const peopleLabel = document.querySelector('label[style*="margin-left:10px"]');
      if (peopleLabel) peopleLabel.childNodes[0].nodeValue = uiText[lang].people + ' ';

const aiLabel = document.getElementById('ai-quiz-label');
const aiYes = document.getElementById('ai-quiz-yes');
const aiNo = document.getElementById('ai-quiz-no');
const aiHint = document.getElementById('ai-quiz-hint');
if (aiLabel) aiLabel.textContent = uiText[lang].aiQuizLabel + 'ï¼š';
if (aiYes) aiYes.textContent = uiText[lang].aiQuizYes;
if (aiNo) aiNo.textContent = uiText[lang].aiQuizNo;
if (aiHint) aiHint.textContent = uiText[lang].aiQuizHint;

// --- ä½œå¼Šæ¨¡å¼è¨­å®š ---
  const cheatLabel = document.getElementById('cheat-label');
  const cheatYes = document.getElementById('cheat-label-yes');
  const cheatNo = document.getElementById('cheat-label-no');
  const cheatHint = document.getElementById('cheat-hint');
  if (cheatLabel) cheatLabel.textContent = uiText[lang].cheat_label;
  if (cheatYes) cheatYes.textContent = uiText[lang].cheat_yes;
  if (cheatNo) cheatNo.textContent = uiText[lang].cheat_no;
  if (cheatHint) cheatHint.textContent = uiText[lang].cheat_hint;

  // --- Debug æ¨¡å¼è¨­å®š ---
  const debugLabel = document.getElementById('debug-label');
  const debugYes = document.getElementById('debug-label-yes');
  const debugNo = document.getElementById('debug-label-no');
  const debugHint = document.getElementById('debug-hint');
  if (debugLabel) debugLabel.textContent = uiText[lang].debug_label;
  if (debugYes) debugYes.textContent = uiText[lang].debug_yes;
  if (debugNo) debugNo.textContent = uiText[lang].debug_no;
  if (debugHint) debugHint.textContent = uiText[lang].debug_hint;


      // åœ°åœ–æŒ‰éˆ•
      const map1Btn = document.querySelector('button[onclick="loadMap1()"]');
      if (map1Btn) map1Btn.textContent = uiText[lang].map1;
      // åœ°åœ–æŒ‰éˆ•
      const map2Btn = document.querySelector('button[onclick="loadMap2()"]');
      if (map2Btn) map2Btn.textContent = uiText[lang].map2;

      const map3Btn = document.querySelector('button[onclick="loadMap3()"]');
      if (map3Btn) map3Btn.textContent = uiText[lang].map3;

      const clearBtn = document.querySelector('button[onclick="clearMap()"]');
      if (clearBtn) clearBtn.textContent = uiText[lang].clear;


      // é–‹å§‹éŠæˆ²æŒ‰éˆ•
      const startBtn = document.querySelector('button[onclick="saveAndStart()"]');
      if (startBtn) startBtn.textContent = uiText[lang].start;

      // â˜… æ“ä½œèªªæ˜ï¼ˆå³å´ï¼‰è·Ÿè‘—èªç³»æ›´æ–°
      renderInstructions();

      // æœ€å¾Œï¼štooltip æ–‡æ¡ˆä¹Ÿä¾èªç³»æ›´æ–°
      refreshAllTooltips();
	  // èªç³»åˆ‡æ›å¾Œï¼Œæ–‡å­—é«˜åº¦å¯èƒ½è®ŠåŒ–ï¼Œé‡æ–°è¨ˆç®— cell
      //updateResponsiveCell();
      //updateScreenInfo();

    }
function updateResponsiveCell() {
  const root = document.documentElement;
  const map = document.getElementById('map');
  const sidebar = document.getElementById('sidebar'); 
  const topbar = document.querySelector('.topbar');
  const header = document.querySelector('.header-row');
  if (!map || !sidebar) return;

  const vv = window.visualViewport;
  const vh = vv ? vv.height : window.innerHeight;
  const vw = vv ? vv.width : window.innerWidth;

  // âœ… æ”¹ç”¨ç©©å®šè¨ˆç®—ï¼šæ’é™¤æ²å‹•å¹²æ“¾
  // å–å¾—ä¸Šæ–¹å›ºå®šå…ƒç´ çš„é«˜åº¦ç¸½å’Œ
  const headerH = header ? header.offsetHeight : 0;
  const topbarH = topbar ? topbar.offsetHeight : 0;
  const sidebarH = sidebar ? sidebar.offsetHeight : 0;
  // åŠ ä¸Š padding èˆ‡ margin (å¤§ç´„å€¼æˆ–ç²¾ç¢ºè¨ˆç®—)
  const topOccupiedHeight = headerH + topbarH + sidebarH + 60; 

  const gap = 2;
  const gapsTotal = gap * 7; 
  const bottomPad = 25; 

  // å¯ç”¨é«˜åº¦ = ç•¶å‰è¦–çª—é«˜ - ä¸Šæ–¹ä½”ç”¨ç©ºé–“
  const availH = Math.max(0, vh - topOccupiedHeight - bottomPad);

  const isNarrow = vw <= 798;
  const availW = isNarrow ? (vw - 32) : (vw * 0.6); // å‡è¨­å¤§è¢å¹•åœ°åœ–ä½” 60%

  const cellByH = (availH - gapsTotal) / 8;
  const cellByW = (availW - gapsTotal) / 8;

  // å–æœ€å°å€¼ä»¥ç¢ºä¿åœ°åœ–èƒ½å®Œæ•´é¡¯ç¤ºåœ¨è¢å¹•å…§
  let next = Math.max(18, Math.min(90, cellByH, cellByW));
  
  root.style.setProperty('--cell', `${next}px`);
  updateScreenInfo();
}
// æ–°å¢ï¼šåµæ¸¬æ‰‹æ©Ÿæ©«æ”¾è­¦å‘Š
function checkOrientation() {
  const vv = window.visualViewport;
  const h = vv ? vv.height : window.innerHeight;
  const w = vv ? vv.width : window.innerWidth;
  const overlay = document.getElementById("rotate-overlay");

  if (!overlay) return;

  // åˆ¤å®šæ¢ä»¶ï¼šæ©«å‘ä¸”é«˜åº¦å¤ªå°
  if (w > h && h < 500) {
    overlay.style.display = "flex";
  } else {
    overlay.style.display = "none";
  }
}



function updateScreenInfo() {
  const el = document.getElementById('screen-info');
  if (!el) return;

  const sw = window.screen?.width ?? 0;
  const sh = window.screen?.height ?? 0;

  const vv = window.visualViewport;
  const vw = Math.round(vv ? vv.width : window.innerWidth);
  const vh = Math.round(vv ? vv.height : window.innerHeight);

  const dpr = window.devicePixelRatio || 1;
  const physicalW = Math.round(sw * dpr);
  const physicalH = Math.round(sh * dpr);

  const ori = window.screen?.orientation?.type || '';

 const cell = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell')) || 0;

  el.textContent =
    `screen${sw}Ã—${sh}(${physicalW}Ã—${physicalH}px)` +
    `viewport${vw}Ã—${vh}` ;


 
}

    
    function toggleLang() {
      lang = (lang === 'zh') ? 'en' : 'zh';
      localStorage.setItem(LANG_KEY, lang);
      renderLangButton();
	  renderInstructions();
	  updateScreenInfo();
	  
    }
	function handleResize() {
  const currentWidth = window.innerWidth;
  
  // åªæœ‰åœ¨å¯¬åº¦çœŸçš„æ”¹è®Šæ™‚ï¼ˆä¾‹å¦‚æ—‹è½‰è¢å¹•ã€æ‹‰å‹•æ¡Œé¢è¦–çª—ï¼‰æ‰é‡æ–°è¨ˆç®— Cell
  if (Math.abs(currentWidth - lastWidth) > 5) {
    updateResponsiveCell();
    lastWidth = currentWidth;
    console.log("å¯¬åº¦æ”¹è®Šï¼Œé‡ç®— Cell");
  } else {
    // å¯¬åº¦æ²’è®Šï¼ˆåªæ˜¯æ²å‹•ï¼‰ï¼Œåªæ›´æ–° debug è³‡è¨Šï¼Œä¸è§¸ç™¼é‡ç®—
    updateScreenInfo();
  }
  checkOrientation();
}
	
	// å®£å‘Šä¸€å€‹è®Šæ•¸è¨˜éŒ„ä¸Šæ¬¡çš„å¯¬åº¦
let lastWidth = window.innerWidth;

window.addEventListener('DOMContentLoaded', () => {
  renderLangButton();
  const btn = document.getElementById('lang-toggle');
  if (btn) btn.addEventListener('click', toggleLang);
});

// âœ… ä¿®æ­£é» 1ï¼šä½¿ç”¨ window.load ç¢ºä¿æ‰€æœ‰åœ–ç‰‡èˆ‡ä½ˆå±€å·²å®Œå…¨ç©©å®š
window.addEventListener('load', () => {
  lastWidth = window.innerWidth; // è¨˜éŒ„åˆå§‹å¯¬åº¦
  updateResponsiveCell();
  // ğŸ’¡ é—œéµä¿®æ­£ï¼šå»¶é² 300 æ¯«ç§’å†åŸ·è¡Œç¬¬ä¸€æ¬¡æ–¹å‘æª¢æŸ¥ï¼Œé¿é–‹å•Ÿå‹•æ™‚çš„é–ƒçˆ
  setTimeout(checkOrientation, 300);



  // é‡å°é‡æ–°æ•´ç†å¾Œçš„æ²å‹•æ®˜ç•™ï¼Œåšä¸€æ¬¡å¾®å°çš„å»¶é²æ ¡æ­£
  setTimeout(updateResponsiveCell, 200);
});

// âœ… ä¿®æ­£é» 2ï¼šåªæœ‰åœ¨ã€Œå¯¬åº¦æ”¹è®Šã€æ™‚æ‰é‡ç®— CELL
window.addEventListener('resize', handleResize);

// è¡Œå‹•è£ç½®è¦–çª—è®Šå‹•ï¼ˆåŒ…å«ç¶²å€åˆ—ä¼¸ç¸®ï¼‰
if (window.visualViewport) {
  // ä¿®æ­£é»ï¼šé€™è£¡ä¹Ÿè¦æŒ‡å‘ handleResizeï¼Œè®“å®ƒå—å¯¬åº¦æª¢æŸ¥ä¿è­·
  window.visualViewport.addEventListener('resize', handleResize);
  
  // æ²å‹•æ™‚åªæ›´æ–°æ–‡å­—è³‡è¨Š
  window.visualViewport.addEventListener('scroll', updateScreenInfo);
}


    function refreshAllTooltips() {
      // 1) å´é‚Šæ¬„çš„ tooltipï¼ˆä¾ sidebar åœ–ç¤ºçš„ data-imgï¼‰
      document.querySelectorAll('#sidebar .item-wrapper').forEach(w => {
        const img = w.querySelector('img.item');
        const tip = w.querySelector('.tooltip');
        if (img && tip) {
          const key = img.getAttribute('data-img') || img.src;
          tip.textContent = getDescription(key);
        }
      });

      // 2) åœ°åœ–ä¸Šã€Œæ‹–é€²ä¾†ã€çš„æ ¼å­ï¼ˆdrop-item-wrapperï¼‰
      document.querySelectorAll('#map .drop-item-wrapper').forEach(w => {
        const img = w.querySelector('img');
        const tip = w.querySelector('.drop-tooltip');
        if (img && tip) {
          const key = img.getAttribute('data-img') || img.src;
          tip.textContent = getDescription(key);
        }
      });

      // 3) åœ°åœ–ä¸Šã€ŒloadMap1() è¼‰å…¥ã€çš„æ ¼å­ï¼ˆmap-item-wrapperï¼‰
      document.querySelectorAll('#map .map-item-wrapper').forEach(w => {
        const img = w.querySelector('img');
        const tip = w.querySelector('.map-tooltip');
        if (img && tip) {
          const key = img.getAttribute('data-img') || img.src;
          tip.textContent = getDescription(key);
        }
      });
    }


    const mapEl = document.getElementById("map");
    let placedOrder = [];
    for (let i = 0; i < 64; i++) {
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.cell = i;
      cell.ondragover = e => e.preventDefault();
      cell.ondrop = drop;
	  cell.addEventListener('click', () => {
  if (selectedItem) placeIntoCell(cell, selectedItem, 'drop-item-wrapper');
});
      mapEl.appendChild(cell);
    }
	
	function makeWrapperDraggable(wrapper) {
  wrapper.setAttribute('draggable', 'true');
  wrapper.addEventListener('dragstart', (e) => {
    const img = wrapper.querySelector('img');
    const filename = img.getAttribute('data-img') || img.src;
    const cell = wrapper.closest('.cell');
    if (!cell || !e.dataTransfer) return;
    e.dataTransfer.setData('text/plain', filename);               // ä¿ç•™åŸæœ¬æª”å
    e.dataTransfer.setData('application/x-from-cell', cell.dataset.cell); // ç´€éŒ„ä¾†æº cell
  });
}
	
	
    function getDescription(filename) {
      const name = filename.split('/').pop().trim();
      const dictZH = {
        "start.png": "èµ·é»ï¼šç©å®¶å¾é€™è£¡é–‹å§‹",
        "quiz_fire.png": "ç«ç½ç›¸é—œå•é¡Œç­”é¡Œæ ¼ï¼šç­”å°å¯å¾—åˆ†",
        "quiz_water.png": "æ°´ç½ç›¸é—œå•é¡Œç­”é¡Œæ ¼ï¼šç­”å°å¯å¾—åˆ†",
        "quiz_earthquake.png": "åœ°éœ‡ç›¸é—œå•é¡Œç­”é¡Œæ ¼ï¼šç­”å°å¯å¾—åˆ†",
        "event1.png": "äº‹ä»¶å¡1ï¼šéš¨æ©Ÿäº‹ä»¶",
        "event2.png": "äº‹ä»¶å¡2ï¼šéš¨æ©Ÿäº‹ä»¶",
        "fire1.png": "ç™¼ç”Ÿç«ç½", "fire2.png": "ç™¼ç”Ÿç«ç½",
        "light.png": "æ‰‹é›»ç­’",
        "bag1.png": "æ€¥æ•‘åŒ…ï¼Œå¯åŠ åˆ†", "bag2.png": "æ€¥æ•‘åŒ…ï¼Œå¯åŠ åˆ†",
        "card1.png": "é¿é›£å¡", "card2.png": "é¿é›£å¡",
        "earthquake1.png": "ç™¼ç”Ÿåœ°éœ‡", "earthquake2.png": "ç™¼ç”Ÿåœ°éœ‡", "earthquake3.png": "ç™¼ç”Ÿåœ°éœ‡",
        "ok1.png": "ç„¡ç‰¹æ®Šäº‹ä»¶", "ok2.png": "å®‰å…¨å€", "ok3.png": "ç„¡ç‰¹æ®Šäº‹ä»¶",
        "rain1.png": "ç™¼ç”Ÿæ°´ç½", "rain2.png": "ç™¼ç”Ÿæ°´ç½", "rain3.png": "ç™¼ç”Ÿæ°´ç½",
        "safe.png": "å®‰å…¨å€", "safezone.png": "å®‰å…¨å€",
        "warning1.png": "è­¦å‘Š", "warning2.png": "è­¦å‘Š",
        "underdesk.png": "ç™¼ç”Ÿåœ°éœ‡ï¼Œèº²åˆ°æ¡Œä¸‹ï¼Œæ­£ç¢ºèº²é¿ï¼Œå¯åŠ åˆ†",
        "back.png": "é€€å›èµ·é»",
        "dice.png": "éª°å­æ ¼ï¼šå¯ä»¥å†æ“²ä¸€æ¬¡",
        "fire_station_0.png": "æ£®æ—åœ°",
        "water_bureau_0.png": "ä½çªªåœ°",
        "museum921_0.png": "é«˜æ¨“å¤§å»ˆ",
      };
      const dictEN = {
        "start.png": "Start: where all players begin",
        "quiz_fire.png": "Quiz for fire: answer to earn points",
        "quiz_water.png": "Quiz for water: answer to earn points",
        "quiz_earthquake.png": "Quiz for earthquake: answer to earn points",
        "event1.png": "Event 1: random effect",
        "event2.png": "Event 2: random effect",
        "fire1.png": "Fire", "fire2.png": "Fire",
        "light.png": "Light",
        "bag1.png": "Aid kit", "bag2.png": "Aid kit",
        "card1.png": "Blank card", "card2.png": "Skill card",
        "earthquake1.png": "Earthquake", "earthquake2.png": "Earthquake", "earthquake3.png": "Earthquake",
        "ok1.png": "Safe", "ok2.png": "Safe", "ok3.png": "Safe",
        "rain1.png": "Rain", "rain2.png": "Rain", "rain3.png": "Rain",
        "safe.png": "Safe zone", "safezone.png": "Safe zone",
        "warning1.png": "Warning", "warning2.png": "Warning",
        "underdesk.png": "arthquake! Hide under the desk. earn points!",
        "back.png": "back to start ",

        "dice.png": "Dice tile: roll again",
        "fire_station_0.png": "Forest",
        "water_bureau_0.png": "Low Lying Land",
        "museum921_0.png": "High Buildings",
      };
      const dict = (lang === 'en') ? dictEN : dictZH;
      return dict[name] || "";
    }



   let selectedItem = null;

/* 1) ä¿ç•™æ¡Œæ©Ÿçš„åŸç”Ÿæ‹–æ”¾ï¼šæŠŠåœ–ç‰‡è·¯å¾‘å¡é€² dataTransfer */
document.querySelectorAll('#sidebar img.item').forEach(img => {
  img.addEventListener('dragstart', e => {
    e.dataTransfer.setData('text/plain', img.getAttribute('data-img') || img.src);
  });

  // 2) è¡Œå‹•è£ç½®ï¼šé»ä¸€ä¸‹å³å¯é¸/å–æ¶ˆ
  img.addEventListener('click', () => {
    const value = img.dataset.img || img.src;
    if (selectedItem === value) {
      selectedItem = null;
      img.classList.remove('is-selected');
      return;
    }
    document.querySelectorAll('#sidebar img.item.is-selected')
      .forEach(el => el.classList.remove('is-selected'));
    selectedItem = value;
    img.classList.add('is-selected');
  });
});

/* 3) å…±ç”¨ï¼šæŠŠåœ–ç‰‡æ”¾é€²æŸå€‹ cellï¼ˆæ¡Œæ©Ÿ dropã€æ‰‹æ©Ÿé»æ”¾éƒ½æœƒç”¨é€™ä¸€å€‹ï¼‰ */
function placeIntoCell(cell, filename, wrapperClass) {
  if (!cell) return;
  cell.innerHTML = '';

  const wrapper = document.createElement('div');
  wrapper.className = wrapperClass || 'drop-item-wrapper';

  const image = new Image();
  image.src = filename;
  image.setAttribute('data-img', filename);
  wrapper.appendChild(image);

  const tip = document.createElement('div');
  tip.className = (wrapperClass === 'map-item-wrapper') ? 'map-tooltip' : 'drop-tooltip';
  if (typeof getDescription === 'function') tip.textContent = getDescription(filename);
  wrapper.appendChild(tip);

  // âœ… è®“åœ°åœ–ä¸Šçš„æ ¼å­çœŸçš„å¯ä»¥è¢«æ‹–æ›³
  makeWrapperDraggable(wrapper);

  cell.appendChild(wrapper);

  const index = parseInt(cell.dataset.cell, 10);
  if (!placedOrder.includes(index)) placedOrder.push(index);
}

/* 6) è®“åŸæœ¬çš„ drop() ä¹Ÿæ”¹èµ°å…±ç”¨é‚è¼¯ï¼ˆæ¡Œæ©Ÿæ‹–æ‹‰ï¼‰ */
function drop(e) {
  e.preventDefault();
  const cell = e.target.closest('.cell');
  if (!cell || !e.dataTransfer) return;

  const filename = e.dataTransfer.getData('text/plain');
  const fromIdx = e.dataTransfer.getData('application/x-from-cell');

  // å¦‚æœæ˜¯å¾åœ°åœ–å…§æ‹–ä¾†ï¼Œå…ˆæ¸…ç©ºä¾†æºæ ¼
  if (fromIdx) {
    const srcCell = mapEl.querySelector(`.cell[data-cell="${fromIdx}"]`);
    if (srcCell && srcCell !== cell) srcCell.innerHTML = '';
  }
  // å†æŠŠåœ–ç‰‡æ”¾åˆ°ç›®æ¨™æ ¼
  placeIntoCell(cell, filename, 'drop-item-wrapper');
}

    function loadMap1() {
      clearMap();
      const map1 = [
        { index: 0, img: 'start.png' },
        { index: 1, img: 'fire_station_0.png' },
        { index: 2, img: 'dice.png' },
        { index: 3, img: 'bag1.png' },
        { index: 4, img: 'museum921_0.png' },
        { index: 5, img: 'ok1.png' },
        { index: 6, img: 'event1.png' },
        { index: 7, img: 'quiz_water.png' },
        { index: 15, img: 'underdesk.png' },
        { index: 23, img: 'water_bureau_0.png' },
        { index: 31, img: 'light.png' },
        { index: 39, img: 'back.png' },
        { index: 38, img: 'ok3.png' },
        { index: 37, img: 'card2.png' },
        { index: 29, img: 'fire_station_0.png' },
        { index: 21, img: 'ok2.png' },
        { index: 20, img: 'rain1.png' },
        { index: 19, img: 'quiz_earthquake.png' },
        { index: 27, img: 'fire2.png' },
        { index: 35, img: 'dice.png' },
        { index: 34, img: 'quiz_water.png' },
        { index: 33, img: 'event1.png' },
        { index: 32, img: 'fire_station_0.png' },
        { index: 24, img: 'earthquake3.png' },
        { index: 17, img: 'rain1.png' },
        { index: 8, img: 'quiz_fire.png' },
      ];
      placedOrder = [];
      map1.forEach(({ index, img }) => {
        const cell = mapEl.querySelector(`.cell[data-cell="${index}"]`);
        cell.innerHTML = '';
        const wrapper = document.createElement("div");
        wrapper.className = "map-item-wrapper";

        const image = new Image();
        image.src = img;
        image.setAttribute('data-img', img); // â˜… æ–°å¢
        image.width = image.height = 90;
        const tooltip = document.createElement("div");
        tooltip.className = "map-tooltip";

        tooltip.textContent = getDescription(img);


        wrapper.appendChild(image);
        wrapper.appendChild(tooltip);
		makeWrapperDraggable(wrapper); 
        cell.appendChild(wrapper);

        placedOrder.push(index);
      });
    }


    function clearMap() {
      const cells = mapEl.querySelectorAll(".cell");
      cells.forEach(cell => cell.innerHTML = '');
      placedOrder = [];
    }

    // ç¯„ä¾‹ Map 2ï¼ˆä½ å¯ä»¥å†èª¿æ•´å…§å®¹é †åºèˆ‡åœ–ç¤ºï¼‰
    function loadMap2() {
      clearMap();
      const map2 = [
        { index: 0, img: 'start.png' },
        { index: 1, img: 'quiz_fire.png' },
        { index: 2, img: 'water_bureau_0.png' },
        { index: 3, img: 'event1.png' },
        { index: 4, img: 'fire_station_0.png' },
        { index: 5, img: 'ok2.png' },
        { index: 6, img: 'quiz_water.png' },
        { index: 7, img: 'dice.png' },
        { index: 15, img: 'rain1.png' },
        { index: 23, img: 'bag1.png' },
        { index: 31, img: 'underdesk.png' },
        { index: 39, img: 'quiz_earthquake.png' },
        { index: 47, img: 'museum921_0.png' },
        { index: 55, img: 'fire2.png' },
        { index: 54, img: 'quiz_water.png' },
        { index: 53, img: 'earthquake3.png' },
        { index: 61, img: 'light.png' },
        { index: 60, img: 'dice.png' },
        { index: 59, img: 'ok1.png' },
        { index: 58, img: 'rain1.png' },
        { index: 57, img: 'museum921_0.png' },
        { index: 56, img: 'event1.png' },
        { index: 49, img: 'card2.png' },
        { index: 42, img: 'earthquake3.png' },

        { index: 34, img: 'back.png' },
        { index: 33, img: 'fire2.png' },
        { index: 32, img: 'water_bureau_0.png' },
        { index: 24, img: 'ok3.png' },
        { index: 16, img: 'bag1.png' },
        { index: 8, img: 'fire_station_0.png' }
      ];
      placedOrder = [];
      map2.forEach(({ index, img }) => {
        const cell = mapEl.querySelector(`.cell[data-cell="${index}"]`);
        cell.innerHTML = '';
        const wrapper = document.createElement("div");
        wrapper.className = "map-item-wrapper";
        const image = new Image();
        image.src = img;
        image.setAttribute('data-img', img);
        image.width = image.height = 90;
        const tooltip = document.createElement("div");
        tooltip.className = "map-tooltip";
        tooltip.textContent = getDescription(img);
        wrapper.appendChild(image);
        wrapper.appendChild(tooltip);
		makeWrapperDraggable(wrapper); 
        cell.appendChild(wrapper);
        placedOrder.push(index);
      });
    }

    // ç¯„ä¾‹ Map 3ï¼ˆä½ å¯ä»¥å†èª¿æ•´å…§å®¹é †åºèˆ‡åœ–ç¤ºï¼‰
    function loadMap3() {
      clearMap();
      const map3 = [
        { index: 0, img: 'start.png' },
        { index: 1, img: 'back.png' },
        { index: 2, img: 'bag1.png' },
        { index: 3, img: 'fire_station_0.png' },
        { index: 4, img: 'rain1.png' },
        { index: 5, img: 'quiz_water.png' },
        { index: 6, img: 'dice.png' },
        { index: 7, img: 'ok1.png' },
        { index: 15, img: 'quiz_fire.png' },
        { index: 23, img: 'museum921_0.png' },
        { index: 31, img: 'event1.png' },
        { index: 30, img: 'ok2.png' },

        { index: 29, img: 'fire2.png' },
        { index: 28, img: 'light.png' },
        { index: 27, img: 'underdesk.png' },
        { index: 26, img: 'quiz_earthquake.png' },
        { index: 25, img: 'water_bureau_0.png' },
        { index: 17, img: 'earthquake3.png' },
        { index: 16, img: 'card2.png' },
        { index: 8, img: 'ok3.png' },

      ];
      placedOrder = [];
      map3.forEach(({ index, img }) => {
        const cell = mapEl.querySelector(`.cell[data-cell="${index}"]`);
        cell.innerHTML = '';
        const wrapper = document.createElement("div");
        wrapper.className = "map-item-wrapper";
        const image = new Image();
        image.src = img;
        image.setAttribute('data-img', img);
        image.width = image.height = 90;
        const tooltip = document.createElement("div");
        tooltip.className = "map-tooltip";
        tooltip.textContent = getDescription(img);
        wrapper.appendChild(image);
        wrapper.appendChild(tooltip);
		makeWrapperDraggable(wrapper); 
        cell.appendChild(wrapper);
        placedOrder.push(index);
      });
    }

    function updateMode() {
      const timeSel = document.getElementById("timeLimit");
      const scoreSel = document.getElementById("scoreTarget");
      const mode = document.querySelector('input[name="mode"]:checked').value;
      timeSel.disabled = mode !== "time";
      scoreSel.disabled = mode !== "score";
	  //updateResponsiveCell();
      //updateScreenInfo();
    }
	
	function saveAPIKey() {
  const key = document.getElementById("apiKeyInput").value.trim();
  if (!key) { alert("è«‹è¼¸å…¥ API Key"); return; }
  localStorage.setItem("gemini_api_key", key);
  alert("âœ… API Key å·²å„²å­˜ï¼Œä¸‹æ¬¡è¼‰å…¥æœƒè‡ªå‹•ä½¿ç”¨ã€‚");
}

	
    function saveAndStart() {
      const mode = document.querySelector('input[name="mode"]:checked').value;
      const timeLimit = parseInt(document.getElementById("timeLimit").value);
      const scoreTarget = parseInt(document.getElementById("scoreTarget").value);
      const playerCount = parseInt(document.getElementById("playerCount").value);
	  const useAIQuiz = document.querySelector('input[name="aiQuiz"]:checked')?.value === 'yes';
	  const cheatMode = document.querySelector('input[name="cheatMode"]:checked')?.value === 'yes';
	const debugMode = document.querySelector('input[name="debugMode"]:checked')?.value === 'yes';
	
      const cells = mapEl.querySelectorAll(".cell");
      const mapData = [];
      cells.forEach(cell => {
        const img = cell.querySelector("img");
        mapData.push(img ? img.src : null);
      });
      const config = {
        mode,
        timeLimit,
        scoreTarget,
        playerCount,
        mapData,
        pathIndices: placedOrder,
        lang,
		// ğŸ”½ åŠ å…¥ settings
		settings: {
		useAIQuiz,
      cheatMode,   // âœ… å„²å­˜ä½œå¼Šæ¨¡å¼
      debugMode    // âœ… å„²å­˜ Debug æ¨¡å¼
		}
      };
      localStorage.setItem("gameConfig", JSON.stringify(config));
      console.log(config);
      localStorage.setItem("gameLang", lang); // è¨˜ä½èªè¨€é¸æ“‡
      window.location.href = (lang === 'en') ? "game1133e.html" : "game1133.html";
    }
  </script>
</body>

</html>


